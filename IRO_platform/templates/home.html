<!-- templates/home.html -->
{% extends "base.html" %}
{% load assessment_filters %}

{% block title %}Dashboard | DMA Platform{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block content %}
<div class="row mb-4">
    <!-- Key metrics cards -->
    <div class="col-md-3">
        <div class="card metric-card bg-white">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="metric-value">{{ total_iros }}</div>
                    <div class="metric-label">Total IROs</div>
                </div>
                <div class="icon-shape rounded-circle bg-primary bg-opacity-10 p-2">
                    <i class="fas fa-chart-line text-primary fs-4"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card bg-white">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="metric-value">{{ high_materiality_count }}</div>
                    <div class="metric-label">High Materiality</div>
                </div>
                <div class="icon-shape rounded-circle bg-danger bg-opacity-10 p-2">
                    <i class="fas fa-exclamation-triangle text-danger fs-4"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card bg-white">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="metric-value">{{ pending_reviews_count }}</div>
                    <div class="metric-label">Pending Reviews</div>
                </div>
                <div class="icon-shape rounded-circle bg-warning bg-opacity-10 p-2">
                    <i class="fas fa-hourglass-half text-warning fs-4"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card bg-white">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="metric-value">{{ completed_assessments_count }}</div>
                    <div class="metric-label">Completed Assessments</div>
                </div>
                <div class="icon-shape rounded-circle bg-success bg-opacity-10 p-2">
                    <i class="fas fa-check-circle text-success fs-4"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <!-- Materiality matrix visualization -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Materiality Matrix</h5>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="matrixDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            Last 12 Months
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="matrixDropdown">
                            <li><a class="dropdown-item" href="#">Last 6 Months</a></li>
                            <li><a class="dropdown-item" href="#">Last 3 Months</a></li>
                            <li><a class="dropdown-item" href="#">Custom Range</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <canvas id="materialityMatrix" style="height: 300px;" data-matrix-data="{{ materiality_matrix_data }}"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Recent activity timeline -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0">Recent Activity</h5>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush">
                    {% for activity in recent_activities %}
                    <div class="list-group-item border-0 py-3" data-status="{{ activity.action }}">
                        <div class="d-flex align-items-center">
                            <div class="bg-{{ activity.icon_color }} rounded-circle p-2 me-3">
                                <i class="fas fa-{{ activity.icon }} text-white small"></i>
                            </div>
                            <div>
                                <p class="mb-0 fw-medium">{{ activity.description }}</p>
                                <p class="text-muted small mb-0">{{ activity.timestamp|timesince }} ago</p>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="list-group-item border-0 py-3">
                        <p class="text-center text-muted my-3">No recent activity</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <!-- Top IROs table -->
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">High Priority IROs</h5>
                    <a href="{% url 'assessments:iro-list' %}" class="btn btn-sm btn-outline-primary">View All IROs</a>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="highPriorityIROsTable">
                        <thead class="bg-light">
                            <tr>
                                <th>IRO ID</th>
                                <th>Title</th>
                                <th>Type</th>
                                <th>Impact Score</th>
                                <th>Financial Score</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for iro in high_priority_iros %}
                            <tr>
                                <td>#{{ iro.iro_id }}</td>
                                <td>{{ iro.title }}</td>
                                <td><span class="badge bg-{% if iro.type == 'Risk' %}danger{% elif iro.type == 'Opportunity' %}success{% else %}primary{% endif %}">{{ iro.type }}</span></td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <span class="me-2">{{ iro.impact_score|floatformat:1 }}</span>
                                        <div class="progress" style="width: 60px; height: 5px;">
                                            <div class="progress-bar bg-{% if iro.impact_score > 3.5 %}danger{% elif iro.impact_score > 2.5 %}warning{% else %}success{% endif %}" 
                                                style="width: {{ iro.impact_score|floatformat:1|stringformat:'s'|slice:'0:3'|floatformat:1|mul:20 }}%">
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <span class="me-2">{{ iro.financial_score|floatformat:1 }}</span>
                                        <div class="progress" style="width: 60px; height: 5px;">
                                            <div class="progress-bar bg-{% if iro.financial_score > 3.5 %}danger{% elif iro.financial_score > 2.5 %}warning{% else %}success{% endif %}" 
                                                style="width: {{ iro.financial_score|floatformat:1|stringformat:'s'|slice:'0:3'|floatformat:1|mul:20 }}%">
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td><span class="status-badge status-{{ iro.current_stage|lower }}">{{ iro.current_stage|title }}</span></td>
                                <td>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                            Actions
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#">View Details</a></li>
                                            <li><a class="dropdown-item" href="{% url 'assessments:iro-edit' iro.iro_id %}">Edit Assessment</a></li>
                                            <li><a class="dropdown-item" href="#">Add Review</a></li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center py-3">No high priority IROs found</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Initialize materiality matrix using data from database
    const matrixCtx = document.getElementById('materialityMatrix');
    const matrixData = JSON.parse(matrixCtx.getAttribute('data-matrix-data') || '[]');
    
    if (matrixData.length > 0) {
        initializeMatrixChart(matrixCtx, matrixData);
    } else {
        matrixCtx.innerHTML = 'No data available for materiality matrix';
    }
});

function initializeMatrixChart(canvas, data) {
    // Process data into datasets grouped by type
    const riskData = data.filter(item => item.type === 'Risk').map(d => ({
        x: d.impact_score,
        y: d.financial_score,
        id: d.id,
        title: d.title
    }));
    
    const opportunityData = data.filter(item => item.type === 'Opportunity').map(d => ({
        x: d.impact_score,
        y: d.financial_score,
        id: d.id,
        title: d.title
    }));
    
    const impactData = data.filter(item => item.type === 'Impact').map(d => ({
        x: d.impact_score,
        y: d.financial_score,
        id: d.id,
        title: d.title
    }));
    
    const matrixChart = new Chart(canvas.getContext('2d'), {
        type: 'scatter',
        data: {
            datasets: [
                {
                    label: 'Risks',
                    data: riskData,
                    backgroundColor: 'rgba(239, 68, 68, 0.7)',
                    borderColor: 'rgba(239, 68, 68, 1)',
                    borderWidth: 1,
                    pointRadius: 8,
                    pointHoverRadius: 10
                }, 
                {
                    label: 'Opportunities',
                    data: opportunityData,
                    backgroundColor: 'rgba(34, 197, 94, 0.7)',
                    borderColor: 'rgba(34, 197, 94, 1)',
                    borderWidth: 1,
                    pointRadius: 8,
                    pointHoverRadius: 10
                },
                {
                    label: 'Impacts',
                    data: impactData,
                    backgroundColor: 'rgba(59, 130, 246, 0.7)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 1,
                    pointRadius: 8,
                    pointHoverRadius: 10
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Impact Materiality'
                    },
                    min: 0,
                    max: 5,
                    grid: {
                        display: true,
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Financial Materiality'
                    },
                    min: 0,
                    max: 5,
                    grid: {
                        display: true,
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const point = context.raw;
                            return `${point.title} (ID: ${point.id})
Impact: ${point.x.toFixed(1)}, Financial: ${point.y.toFixed(1)}`;
                        }
                    }
                }
            }
        }
    });
}
</script>
{% endblock %}