<!-- templates/assessments/iro_list.html -->
{% extends "base.html" %}

{% load assessment_filters %}

{% block title %}IROs | DMA Platform{% endblock %}
{% block page_title %}IROs{% endblock %}

{% block content %}
    <div class="mb-4">
        <a href="{% url 'assessments:iro-create' %}" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i> Create New IRO
        </a>
    </div>
    
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white py-3">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">IROs Library</h5>
                <div class="d-flex">
                    <!-- Search input -->
                    <div class="me-2">
                        <input type="text" id="searchInput" class="form-control" placeholder="Search IROs...">
                    </div>
                    
                    <!-- Type filter dropdown -->
                    <div class="dropdown me-2">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="typeFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            Filter by Type
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="typeFilterDropdown">
                            <li><a class="dropdown-item filter-option" data-filter="type" data-value="all" href="#">All Types</a></li>
                            <li><a class="dropdown-item filter-option" data-filter="type" data-value="Risk" href="#">Risk</a></li>
                            <li><a class="dropdown-item filter-option" data-filter="type" data-value="Opportunity" href="#">Opportunity</a></li>
                            <li><a class="dropdown-item filter-option" data-filter="type" data-value="Impact" href="#">Impact</a></li>
                        </ul>
                    </div>
                    
                    <!-- Status filter dropdown -->
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="statusFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            Filter by Status
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="statusFilterDropdown">
                            <li><a class="dropdown-item filter-option" data-filter="status" data-value="all" href="#">All Statuses</a></li>
                            <li><a class="dropdown-item filter-option" data-filter="status" data-value="Draft" href="#">Draft</a></li>
                            <li><a class="dropdown-item filter-option" data-filter="status" data-value="In_Review" href="#">In Review</a></li>
                            <li><a class="dropdown-item filter-option" data-filter="status" data-value="Approved" href="#">Approved</a></li>
                            <li><a class="dropdown-item filter-option" data-filter="status" data-value="Disclosed" href="#">Disclosed</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Handsontable Container -->
    <div class="card shadow-sm mb-4">
        <div class="card-body p-3">
            <div id="iro-table-container" data-save-url="{% url 'assessments:iro-save' %}" style="height: 500px; overflow: hidden;"></div>
        </div>
    </div>
    
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <p class="text-muted mb-0">Showing <span id="iro-count">{{ iros|length }}</span> items</p>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Show loading indicator
    document.getElementById('iro-table-container').innerHTML = 
        '<div class="d-flex justify-content-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
    
    // Get IRO data from the server
    fetch('{% url "assessments:iro-data" %}')
        .then(function(response) {
            if (!response.ok) {
                throw new Error('HTTP error! Status: ' + response.status);
            }
            return response.json();
        })
        .then(function(data) {
            // Check if data is valid
            if (!Array.isArray(data)) {
                throw new Error('Invalid data format. Expected an array.');
            }
            
            // Validate and normalize data to prevent JavaScript errors
            var validatedData = data.map(function(item) {
                return {
                    iro_id: item.iro_id || 0,
                    title: item.title || 'Untitled',
                    type: ['Risk', 'Opportunity', 'Impact'].includes(item.type) ? item.type : 'Risk',
                    esrs_standard: item.esrs_standard || '',
                    impact_score: parseFloat(item.impact_score || 0),
                    financial_score: parseFloat(item.financial_score || 0),
                    current_stage: ['Draft', 'In_Review', 'Approved', 'Disclosed'].includes(item.current_stage) 
                        ? item.current_stage : 'Draft',
                    last_assessment_date: item.last_assessment_date || ''
                };
            });

            // Configure columns      
            var columnDefs = [
                { data: 'iro_id', title: 'IRO ID', readOnly: true, width: 80 },
                { data: 'title', title: 'Title' },
                { 
                    data: 'type', 
                    title: 'Type',
                    type: 'dropdown',
                    source: ['Risk', 'Opportunity', 'Impact'],
                    editor: 'select'
                },
                { data: 'esrs_standard', title: 'ESRS Standard' },
                { 
                    data: 'impact_score', 
                    title: 'Impact Score', 
                    type: 'numeric',
                    numericFormat: {
                        pattern: '0.0'
                    },
                    readOnly: true,
                    className: function(row, col, prop, cellProperties, value) {
                        // Use the cell value directly instead of accessing data array
                        var score = parseFloat(value || 0);
                        if (score > 3.5) {
                            return 'bg-danger bg-opacity-25';
                        }
                        if (score > 2.5) {
                            return 'bg-warning bg-opacity-25';
                        }
                        return 'bg-success bg-opacity-25';
                    }
                },
                { 
                    data: 'financial_score', 
                    title: 'Financial Score', 
                    type: 'numeric',
                    numericFormat: {
                        pattern: '0.0'
                    },
                    readOnly: true,
                    className: function(row, col, prop, cellProperties, value) {
                        // Use the cell value directly instead of accessing data array
                        var score = parseFloat(value || 0);
                        if (score > 3.5) {
                            return 'bg-danger bg-opacity-25';
                        }
                        if (score > 2.5) {
                            return 'bg-warning bg-opacity-25';
                        }
                        return 'bg-success bg-opacity-25';
                    }
                },
                { 
                    data: 'current_stage', 
                    title: 'Status',
                    type: 'dropdown',
                    source: ['Draft', 'In_Review', 'Approved', 'Disclosed'],
                    editor: 'select'
                },
                {
                    data: 'last_assessment_date',
                    title: 'Last Assessment',
                    readOnly: true
                }
            ];
            
            // If no data available, show a message
            if (validatedData.length === 0) {
                document.getElementById('iro-table-container').innerHTML = 
                    '<div class="alert alert-info">No IRO data available for the selected context. You may need to create IROs first.</div>';
                document.getElementById('iro-count').textContent = '0';
                return;
            }
            
            // Initialize Handsontable
            var contextData = {
                tenant: {{ request.context.tenant.tenant_id|default:"null" }},
                assessment: {{ request.context.assessment.id|default:"null" }}
            };
            
            var hot = window.handsonTableManager.initTable('iro-table-container', {
                colHeaders: columnDefs.map(function(col) { return col.title; }),
                columns: columnDefs,
                filters: true,
                dropdownMenu: true,
                contextMenu: ['row_above', 'row_below', 'remove_row', '---------', 'undo', 'redo'],
                rowHeaders: true,
                height: 'auto',
                licenseKey: 'non-commercial-and-evaluation'
            }, validatedData, contextData);
            
            // Update row count
            document.getElementById('iro-count').textContent = validatedData.length;
            
            // Handle search
            var searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keyup', function() {
                    var query = this.value.toLowerCase();
                    
                    if (hot) {
                        var search = hot.getPlugin('search');
                        hot.getPlugin('search').query(query);
                        hot.render();
                        
                        // Count visible rows
                        var visibleRows = 0;
                        for (var i = 0; i < hot.countRows(); i++) {
                            if (!hot.rowIndexMapper.getValueAtIndex(i)) {
                                visibleRows++;
                            }
                        }
                        document.getElementById('iro-count').textContent = visibleRows;
                    }
                });
            }
            
            // Handle filter dropdown options
            var filterOptions = document.querySelectorAll('.filter-option');
            filterOptions.forEach(function(option) {
                option.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    var filterType = this.dataset.filter;
                    var filterValue = this.dataset.value;
                    
                    if (hot) {
                        var filters = hot.getPlugin('filters');
                        
                        // Get column index based on filter type
                        var columnIndex = filterType === 'type' ? 2 : (filterType === 'status' ? 6 : -1);
                        
                        if (columnIndex >= 0) {
                            filters.clearConditions(columnIndex);
                            
                            if (filterValue !== 'all') {
                                filters.addCondition(columnIndex, 'eq', [filterValue]);
                            }
                            
                            filters.filter();
                            
                            // Update row count
                            document.getElementById('iro-count').textContent = hot.countRows() - hot.countEmptyRows();
                        }
                    }
                });
            });
        })
        .catch(function(error) {
            console.error('Error loading IRO data:', error);
            document.getElementById('iro-table-container').innerHTML = 
                '<div class="alert alert-danger">' +
                '<strong>Error loading IRO data.</strong><br>' +
                'Please try refreshing the page or selecting a different context.<br>' +
                '<small>Technical details: ' + error.message + '</small>' +
                '</div>';
            document.getElementById('iro-count').textContent = '0';
        });
});
</script>
{% endblock %}