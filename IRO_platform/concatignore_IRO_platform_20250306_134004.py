<issue to solve>
[{
	"resource": "/Users/juanfuentes/localcoding/PublicPortfolio/IRO_platform/templates/assessments/iro_list.html",
	"owner": "_generated_diagnostic_collection_name_#3",
	"severity": 8,
	"message": "Property assignment expected.",
	"source": "javascript",
	"startLineNumber": 175,
	"startColumn": 26,
	"endLineNumber": 175,
	"endColumn": 27
},{
	"resource": "/Users/juanfuentes/localcoding/PublicPortfolio/IRO_platform/templates/assessments/iro_list.html",
	"owner": "_generated_diagnostic_collection_name_#3",
	"severity": 8,
	"message": "',' expected.",
	"source": "javascript",
	"startLineNumber": 175,
	"startColumn": 35,
	"endLineNumber": 175,
	"endColumn": 36
},{
	"resource": "/Users/juanfuentes/localcoding/PublicPortfolio/IRO_platform/templates/assessments/iro_list.html",
	"owner": "_generated_diagnostic_collection_name_#3",
	"severity": 8,
	"message": "',' expected.",
	"source": "javascript",
	"startLineNumber": 175,
	"startColumn": 43,
	"endLineNumber": 175,
	"endColumn": 44
},{
	"resource": "/Users/juanfuentes/localcoding/PublicPortfolio/IRO_platform/templates/assessments/iro_list.html",
	"owner": "_generated_diagnostic_collection_name_#3",
	"severity": 8,
	"message": "',' expected.",
	"source": "javascript",
	"startLineNumber": 175,
	"startColumn": 50,
	"endLineNumber": 175,
	"endColumn": 51
},{
	"resource": "/Users/juanfuentes/localcoding/PublicPortfolio/IRO_platform/templates/assessments/iro_list.html",
	"owner": "_generated_diagnostic_collection_name_#3",
	"severity": 8,
	"message": "',' expected.",
	"source": "javascript",
	"startLineNumber": 175,
	"startColumn": 60,
	"endLineNumber": 175,
	"endColumn": 61
},{
	"resource": "/Users/juanfuentes/localcoding/PublicPortfolio/IRO_platform/templates/assessments/iro_list.html",
	"owner": "_generated_diagnostic_collection_name_#3",
	"severity": 8,
	"message": "Expression expected.",
	"source": "javascript",
	"startLineNumber": 175,
	"startColumn": 61,
	"endLineNumber": 175,
	"endColumn": 68
},{
	"resource": "/Users/juanfuentes/localcoding/PublicPortfolio/IRO_platform/templates/assessments/iro_list.html",
	"owner": "_generated_diagnostic_collection_name_#3",
	"severity": 8,
	"message": "Declaration or statement expected.",
	"source": "javascript",
	"startLineNumber": 175,
	"startColumn": 68,
	"endLineNumber": 175,
	"endColumn": 69
},{
	"resource": "/Users/juanfuentes/localcoding/PublicPortfolio/IRO_platform/templates/assessments/iro_list.html",
	"owner": "_generated_diagnostic_collection_name_#3",
	"severity": 8,
	"message": "',' expected.",
	"source": "javascript",
	"startLineNumber": 175,
	"startColumn": 77,
	"endLineNumber": 175,
	"endColumn": 78
},{
	"resource": "/Users/juanfuentes/localcoding/PublicPortfolio/IRO_platform/templates/assessments/iro_list.html",
	"owner": "_generated_diagnostic_collection_name_#3",
	"severity": 8,
	"message": "',' expected.",
	"source": "javascript",
	"startLineNumber": 176,
	"startColumn": 27,
	"endLineNumber": 176,
	"endColumn": 28
},{
	"resource": "/Users/juanfuentes/localcoding/PublicPortfolio/IRO_platform/templates/assessments/iro_list.html",
	"owner": "_generated_diagnostic_collection_name_#3",
	"severity": 8,
	"message": "Property assignment expected.",
	"source": "javascript",
	"startLineNumber": 176,
	"startColumn": 30,
	"endLineNumber": 176,
	"endColumn": 31
},{
	"resource": "/Users/juanfuentes/localcoding/PublicPortfolio/IRO_platform/templates/assessments/iro_list.html",
	"owner": "_generated_diagnostic_collection_name_#3",
	"severity": 8,
	"message": "',' expected.",
	"source": "javascript",
	"startLineNumber": 176,
	"startColumn": 39,
	"endLineNumber": 176,
	"endColumn": 40
},{
	"resource": "/Users/juanfuentes/localcoding/PublicPortfolio/IRO_platform/templates/assessments/iro_list.html",
	"owner": "_generated_diagnostic_collection_name_#3",
	"severity": 8,
	"message": "Expression expected.",
	"source": "javascript",
	"startLineNumber": 176,
	"startColumn": 62,
	"endLineNumber": 176,
	"endColumn": 69
},{
	"resource": "/Users/juanfuentes/localcoding/PublicPortfolio/IRO_platform/templates/assessments/iro_list.html",
	"owner": "_generated_diagnostic_collection_name_#3",
	"severity": 8,
	"message": "',' expected.",
	"source": "javascript",
	"startLineNumber": 176,
	"startColumn": 78,
	"endLineNumber": 176,
	"endColumn": 79
},{
	"resource": "/Users/juanfuentes/localcoding/PublicPortfolio/IRO_platform/templates/assessments/iro_list.html",
	"owner": "_generated_diagnostic_collection_name_#3",
	"severity": 8,
	"message": "Argument expression expected.",
	"source": "javascript",
	"startLineNumber": 177,
	"startColumn": 13,
	"endLineNumber": 177,
	"endColumn": 14
},{
	"resource": "/Users/juanfuentes/localcoding/PublicPortfolio/IRO_platform/templates/assessments/iro_list.html",
	"owner": "_generated_diagnostic_collection_name_#3",
	"severity": 8,
	"message": "')' expected.",
	"source": "javascript",
	"startLineNumber": 177,
	"startColumn": 14,
	"endLineNumber": 177,
	"endColumn": 15
},{
	"resource": "/Users/juanfuentes/localcoding/PublicPortfolio/IRO_platform/templates/assessments/iro_list.html",
	"owner": "_generated_diagnostic_collection_name_#3",
	"severity": 8,
	"message": "Declaration or statement expected.",
	"source": "javascript",
	"startLineNumber": 246,
	"startColumn": 9,
	"endLineNumber": 246,
	"endColumn": 10
},{
	"resource": "/Users/juanfuentes/localcoding/PublicPortfolio/IRO_platform/templates/assessments/iro_list.html",
	"owner": "_generated_diagnostic_collection_name_#3",
	"severity": 8,
	"message": "Declaration or statement expected.",
	"source": "javascript",
	"startLineNumber": 246,
	"startColumn": 10,
	"endLineNumber": 246,
	"endColumn": 11
},{
	"resource": "/Users/juanfuentes/localcoding/PublicPortfolio/IRO_platform/templates/assessments/iro_list.html",
	"owner": "_generated_diagnostic_collection_name_#3",
	"severity": 8,
	"message": "Declaration or statement expected.",
	"source": "javascript",
	"startLineNumber": 247,
	"startColumn": 9,
	"endLineNumber": 247,
	"endColumn": 10
},{
	"resource": "/Users/juanfuentes/localcoding/PublicPortfolio/IRO_platform/templates/assessments/iro_list.html",
	"owner": "_generated_diagnostic_collection_name_#3",
	"severity": 8,
	"message": "'try' expected.",
	"source": "javascript",
	"startLineNumber": 247,
	"startColumn": 10,
	"endLineNumber": 247,
	"endColumn": 15
},{
	"resource": "/Users/juanfuentes/localcoding/PublicPortfolio/IRO_platform/templates/assessments/iro_list.html",
	"owner": "_generated_diagnostic_collection_name_#3",
	"severity": 8,
	"message": "')' expected.",
	"source": "javascript",
	"startLineNumber": 247,
	"startColumn": 22,
	"endLineNumber": 247,
	"endColumn": 24
},{
	"resource": "/Users/juanfuentes/localcoding/PublicPortfolio/IRO_platform/templates/assessments/iro_list.html",
	"owner": "_generated_diagnostic_collection_name_#3",
	"severity": 8,
	"message": "Declaration or statement expected.",
	"source": "javascript",
	"startLineNumber": 256,
	"startColumn": 10,
	"endLineNumber": 256,
	"endColumn": 11
},{
	"resource": "/Users/juanfuentes/localcoding/PublicPortfolio/IRO_platform/templates/assessments/iro_list.html",
	"owner": "_generated_diagnostic_collection_name_#3",
	"severity": 8,
	"message": "Declaration or statement expected.",
	"source": "javascript",
	"startLineNumber": 257,
	"startColumn": 1,
	"endLineNumber": 257,
	"endColumn": 2
},{
	"resource": "/Users/juanfuentes/localcoding/PublicPortfolio/IRO_platform/templates/assessments/iro_list.html",
	"owner": "_generated_diagnostic_collection_name_#3",
	"severity": 8,
	"message": "Declaration or statement expected.",
	"source": "javascript",
	"startLineNumber": 257,
	"startColumn": 2,
	"endLineNumber": 257,
	"endColumn": 3
}]

[{
	"resource": "/Users/juanfuentes/localcoding/PublicPortfolio/IRO_platform/core/settings/production.py",
	"owner": "python",
	"code": {
		"value": "reportUndefinedVariable",
		"target": {
			"$mid": 1,
			"path": "/microsoft/pyright/blob/main/docs/configuration.md",
			"scheme": "https",
			"authority": "github.com",
			"fragment": "reportUndefinedVariable"
		}
	},
	"severity": 4,
	"message": "\"APP_RUN_TIMESTAMP\" is not defined",
	"source": "Pylance",
	"startLineNumber": 41,
	"startColumn": 84,
	"endLineNumber": 41,
	"endColumn": 101
},{
	"resource": "/Users/juanfuentes/localcoding/PublicPortfolio/IRO_platform/core/settings/production.py",
	"owner": "python",
	"code": {
		"value": "reportUndefinedVariable",
		"target": {
			"$mid": 1,
			"path": "/microsoft/pyright/blob/main/docs/configuration.md",
			"scheme": "https",
			"authority": "github.com",
			"fragment": "reportUndefinedVariable"
		}
	},
	"severity": 4,
	"message": "\"APP_RUN_TIMESTAMP\" is not defined",
	"source": "Pylance",
	"startLineNumber": 42,
	"startColumn": 86,
	"endLineNumber": 42,
	"endColumn": 103
}]


</issue to solve>


<output instruction>
1) Explain
2) Give me the COMPLETE UPDATED VERSION of each script that needs to be updated to adrees the more likely root cause and add logging to confirm the hypothesis
</output instruction>



 <Tree of Included Files>
- Dockerfile
- Dockerfile
- apps/assessments/__init__.py
- apps/assessments/admin.py
- apps/assessments/api/serializers.py
- apps/assessments/api/urls.py
- apps/assessments/api/views.py
- apps/assessments/apps.py
- apps/assessments/migrations/0001_initial.py
- apps/assessments/migrations/0002_assessment_tenant.py
- apps/assessments/migrations/0003_alter_assessment_tenant.py
- apps/assessments/migrations/__init__.py
- apps/assessments/models.py
- apps/assessments/tasks.py
- apps/assessments/templatetags/__init__.py
- apps/assessments/templatetags/assessment_filters.py
- apps/assessments/urls.py
- apps/assessments/utils.py
- apps/assessments/views.py
- core/__init__.py
- core/celery.py
- core/middleware/__init__.py
- core/middleware/context_middleware.py
- core/middleware/logging_middleware.py
- core/settings/__init__.py
- core/settings/base.py
- core/settings/local.py
- core/settings/production.py
- core/urls.py
- core/views.py
- core/wsgi.py
- docker-compose.yaml
- ensure_static_files.py
- manage.py
- requirements.txt
- run_local.sh
- scripts/01-init-schemas.sql
- static/js/context_manager.js
- static/js/dashboard.js
- static/js/handsontable-manager.js
- static/js/logger.js
- templates/assessments/assessment_form.html
- templates/assessments/assessment_list.html
- templates/assessments/iro_form.html
- templates/assessments/iro_list.html
- templates/assessments/partials/iro_edit_esrs.html
- templates/assessments/partials/iro_edit_stage.html
- templates/assessments/partials/iro_edit_title.html
- templates/assessments/partials/iro_edit_type.html
- templates/assessments/partials/iro_list_rows.html
- templates/base.html
- templates/components/context_selector.html
- templates/home.html
- tenants/admin.py
- tenants/api/serializers.py
- tenants/api/urls.py
- tenants/api/views.py
- tenants/apps.py
- tenants/management/commands/__init__.py
- tenants/management/commands/init_sample_data.py
- tenants/management/commands/init_tenant.py
- tenants/migrations/0001_initial.py
- tenants/migrations/__init__.py
- tenants/models.py
- tenants/urls.py
- tenants/views.py




 <Tree of Included Files>


<Concatenated Source Code>

<file path='Dockerfile'>
# Dockerfile
# Use a slim Python base image
FROM python:3.11-slim

# Prevent Python from writing pyc files or buffering stdout
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# Install system dependencies including postgresql-client
RUN apt-get update \
    && apt-get install -y postgresql-client \
    && rm -rf /var/lib/apt/lists/*

# Create a non-root user
RUN groupadd -r appuser && useradd -r -g appuser appuser

WORKDIR /app

# Install Python dependencies
COPY requirements.txt /app/
RUN pip install --no-cache-dir -r requirements.txt

# Copy project files
COPY . /app/

# Make sure the non-root user owns the application files
RUN chown -R appuser:appuser /app

# Switch to the non-root user
USER appuser

# Default command (Docker Compose will typically override this)
CMD ["gunicorn", "core.wsgi:application", "--bind", "0.0.0.0:8000"]
</file>

<file path='Dockerfile'>
# Dockerfile
# Use a slim Python base image
FROM python:3.11-slim

# Prevent Python from writing pyc files or buffering stdout
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# Install system dependencies including postgresql-client
RUN apt-get update \
    && apt-get install -y postgresql-client \
    && rm -rf /var/lib/apt/lists/*

# Create a non-root user
RUN groupadd -r appuser && useradd -r -g appuser appuser

WORKDIR /app

# Install Python dependencies
COPY requirements.txt /app/
RUN pip install --no-cache-dir -r requirements.txt

# Copy project files
COPY . /app/

# Make sure the non-root user owns the application files
RUN chown -R appuser:appuser /app

# Switch to the non-root user
USER appuser

# Default command (Docker Compose will typically override this)
CMD ["gunicorn", "core.wsgi:application", "--bind", "0.0.0.0:8000"]
</file>

<file path='apps/assessments/__init__.py'>

</file>

<file path='apps/assessments/admin.py'>
# apps/assessments/admin.py

from django.contrib import admin
from .models import (
    Assessment, IRO, IROVersion, IRORelationship, ImpactAssessment, 
    RiskOppAssessment, Review, Signoff, AuditTrail, 
    ImpactMaterialityDef, FinMaterialityWeights, FinMaterialityMagnitudeDef
)

@admin.register(Assessment)
class AssessmentAdmin(admin.ModelAdmin):
    list_display = ('id', 'name', 'description', 'created_on', 'updated_on')
    search_fields = ('name', 'description')
    list_filter = ('created_on',)

@admin.register(IRO)
class IROAdmin(admin.ModelAdmin):
    list_display = ('iro_id', 'tenant', 'type', 'current_stage',
                    'last_assessment_date', 'assessment_count')
    search_fields = ('type', 'source_of_iro', 'esrs_standard')
    list_filter = ('current_stage', 'esrs_standard', 'updated_on')

@admin.register(IROVersion)
class IROVersionAdmin(admin.ModelAdmin):
    list_display = ('version_id', 'iro', 'tenant', 'version_number', 'title', 
                    'status', 'created_on')
    search_fields = ('title', 'description', 'sust_topic_level1', 'sust_topic_level2')
    list_filter = ('status', 'created_on')

@admin.register(IRORelationship)
class IRORelationshipAdmin(admin.ModelAdmin):
    list_display = ('relationship_id', 'tenant', 'source_iro', 'target_iro', 'relationship_type')
    search_fields = ('relationship_type', 'notes')
    list_filter = ('relationship_type', 'created_on')

@admin.register(ImpactAssessment)
class ImpactAssessmentAdmin(admin.ModelAdmin):
    list_display = ('impact_assessment_id', 'iro', 'tenant', 'time_horizon',
                    'actual_or_potential', 'impact_materiality_score')
    list_filter = ('time_horizon', 'actual_or_potential')
    search_fields = ('overall_rationale',)

@admin.register(RiskOppAssessment)
class RiskOppAssessmentAdmin(admin.ModelAdmin):
    list_display = ('risk_opp_assessment_id', 'iro', 'tenant', 'time_horizon', 
                    'financial_materiality_score')
    list_filter = ('time_horizon',)
    search_fields = ('overall_rationale',)

@admin.register(Review)
class ReviewAdmin(admin.ModelAdmin):
    list_display = ('review_id', 'iro', 'tenant', 'reviewer_id', 'status', 'updated_on')
    list_filter = ('status', 'created_on', 'updated_on')
    search_fields = ('notes',)

@admin.register(Signoff)
class SignoffAdmin(admin.ModelAdmin):
    list_display = ('signoff_id', 'review', 'tenant', 'signed_by', 'signed_on')
    list_filter = ('signed_on',)
    search_fields = ('comments', 'signature_ref')

@admin.register(AuditTrail)
class AuditTrailAdmin(admin.ModelAdmin):
    list_display = ('audit_id', 'tenant', 'entity_type', 'entity_id', 'action', 'timestamp')
    list_filter = ('entity_type', 'action', 'timestamp')
    search_fields = ('data_diff',)

@admin.register(ImpactMaterialityDef)
class ImpactMaterialityDefAdmin(admin.ModelAdmin):
    list_display = ('def_id', 'tenant', 'version_num', 'dimension', 'score_value', 'valid_from', 'valid_to')
    list_filter = ('dimension', 'score_value', 'valid_from', 'valid_to')
    search_fields = ('definition_text',)

@admin.register(FinMaterialityWeights)
class FinMaterialityWeightsAdmin(admin.ModelAdmin):
    list_display = ('weight_id', 'tenant', 'version_num', 'dimension', 'weight', 'valid_from', 'valid_to')
    list_filter = ('dimension', 'version_num', 'valid_from', 'valid_to')
    search_fields = ('dimension',)

@admin.register(FinMaterialityMagnitudeDef)
class FinMaterialityMagnitudeDefAdmin(admin.ModelAdmin):
    list_display = ('def_id', 'tenant', 'version_num', 'score_value', 'valid_from', 'valid_to')
    list_filter = ('version_num', 'score_value', 'valid_from', 'valid_to')
    search_fields = ('definition_text',)
</file>

<file path='apps/assessments/api/serializers.py'>
# apps/assessments/api/serializers.py
from rest_framework import serializers
from ..models import IRO

class IROSerializer(serializers.ModelSerializer):
    class Meta:
        model = IRO
        fields = "__all__"
</file>

<file path='apps/assessments/api/urls.py'>
# apps/assessments/api/urls.py
from rest_framework.routers import DefaultRouter
from .views import IROViewSet

router = DefaultRouter()
router.register(r'iros', IROViewSet, basename='iro')

urlpatterns = router.urls
</file>

<file path='apps/assessments/api/views.py'>
# apps/assessments/api/views.py
from rest_framework import viewsets, permissions
from ..models import IRO
from .serializers import IROSerializer
from ..views import ContextMixin  # Import the ContextMixin

class IROViewSet(ContextMixin, viewsets.ModelViewSet):
    """
    A ViewSet for viewing and editing IRO instances.
    """
    queryset = IRO.objects.all()
    serializer_class = IROSerializer
    permission_classes = [permissions.IsAuthenticated]  # ensure only authenticated users
</file>

<file path='apps/assessments/apps.py'>
# apps/assessments/apps.py
from django.apps import AppConfig

class AssessmentsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'apps.assessments'
    verbose_name = "Assessments"
</file>

<file path='apps/assessments/migrations/0001_initial.py'>
# Generated by Django 4.2 on 2025-02-25 01:30

from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ("tenants", "0001_initial"),
    ]

    operations = [
        migrations.CreateModel(
            name="Assessment",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "name",
                    models.CharField(
                        help_text="Name of the assessment", max_length=200
                    ),
                ),
                (
                    "description",
                    models.TextField(blank=True, help_text="Optional description"),
                ),
                ("created_on", models.DateTimeField(auto_now_add=True)),
                ("updated_on", models.DateTimeField(auto_now=True)),
            ],
            options={
                "db_table": "assessment",
            },
        ),
        migrations.CreateModel(
            name="IRO",
            fields=[
                ("iro_id", models.AutoField(primary_key=True, serialize=False)),
                ("current_version_id", models.IntegerField(blank=True, null=True)),
                ("current_stage", models.CharField(default="Draft", max_length=50)),
                ("type", models.CharField(max_length=20)),
                (
                    "source_of_iro",
                    models.CharField(blank=True, max_length=255, null=True),
                ),
                (
                    "esrs_standard",
                    models.CharField(blank=True, max_length=100, null=True),
                ),
                ("last_assessment_date", models.DateTimeField(blank=True, null=True)),
                ("assessment_count", models.IntegerField(default=0)),
                (
                    "last_assessment_score",
                    models.DecimalField(
                        blank=True, decimal_places=2, max_digits=5, null=True
                    ),
                ),
                ("created_on", models.DateTimeField(auto_now_add=True)),
                ("updated_on", models.DateTimeField(auto_now=True)),
                (
                    "tenant",
                    models.ForeignKey(
                        db_column="tenant_id",
                        on_delete=django.db.models.deletion.CASCADE,
                        to="tenants.tenantconfig",
                    ),
                ),
            ],
            options={
                "db_table": "iro",
            },
        ),
        migrations.CreateModel(
            name="IROVersion",
            fields=[
                ("version_id", models.AutoField(primary_key=True, serialize=False)),
                ("version_number", models.IntegerField()),
                ("title", models.CharField(max_length=255)),
                ("description", models.TextField()),
                (
                    "sust_topic_level1",
                    models.CharField(blank=True, max_length=100, null=True),
                ),
                (
                    "sust_topic_level2",
                    models.CharField(blank=True, max_length=100, null=True),
                ),
                (
                    "sust_topic_level3",
                    models.CharField(blank=True, max_length=100, null=True),
                ),
                ("value_chain_lv1", models.JSONField(default=list)),
                ("value_chain_lv2", models.JSONField(default=list)),
                ("economic_activity", models.JSONField(default=list)),
                ("status", models.CharField(default="Draft", max_length=50)),
                ("created_by", models.IntegerField()),
                ("created_on", models.DateTimeField(auto_now_add=True)),
                ("parent_version_id", models.IntegerField(blank=True, null=True)),
                ("split_type", models.CharField(blank=True, max_length=50, null=True)),
                (
                    "iro",
                    models.ForeignKey(
                        db_column="iro_id",
                        on_delete=django.db.models.deletion.CASCADE,
                        to="assessments.iro",
                    ),
                ),
                (
                    "tenant",
                    models.ForeignKey(
                        db_column="tenant_id",
                        on_delete=django.db.models.deletion.CASCADE,
                        to="tenants.tenantconfig",
                    ),
                ),
            ],
            options={
                "db_table": "iro_version",
            },
        ),
        migrations.CreateModel(
            name="Review",
            fields=[
                ("review_id", models.AutoField(primary_key=True, serialize=False)),
                ("reviewer_id", models.IntegerField()),
                ("status", models.CharField(default="Draft", max_length=50)),
                ("notes", models.TextField(blank=True, default="")),
                ("created_on", models.DateTimeField(auto_now_add=True)),
                ("updated_on", models.DateTimeField(auto_now=True)),
                (
                    "iro",
                    models.ForeignKey(
                        db_column="iro_id",
                        on_delete=django.db.models.deletion.CASCADE,
                        to="assessments.iro",
                    ),
                ),
                (
                    "iro_version",
                    models.ForeignKey(
                        blank=True,
                        db_column="iro_version_id",
                        null=True,
                        on_delete=django.db.models.deletion.SET_NULL,
                        to="assessments.iroversion",
                    ),
                ),
                (
                    "tenant",
                    models.ForeignKey(
                        db_column="tenant_id",
                        on_delete=django.db.models.deletion.CASCADE,
                        to="tenants.tenantconfig",
                    ),
                ),
            ],
            options={
                "db_table": "review",
            },
        ),
        migrations.CreateModel(
            name="Signoff",
            fields=[
                ("signoff_id", models.AutoField(primary_key=True, serialize=False)),
                ("signed_by", models.IntegerField()),
                ("signed_on", models.DateTimeField(auto_now_add=True)),
                (
                    "signature_ref",
                    models.CharField(blank=True, max_length=255, null=True),
                ),
                ("comments", models.TextField(blank=True, default="")),
                (
                    "iro_version",
                    models.ForeignKey(
                        blank=True,
                        db_column="iro_version_id",
                        null=True,
                        on_delete=django.db.models.deletion.SET_NULL,
                        to="assessments.iroversion",
                    ),
                ),
                (
                    "review",
                    models.ForeignKey(
                        db_column="review_id",
                        on_delete=django.db.models.deletion.CASCADE,
                        to="assessments.review",
                    ),
                ),
                (
                    "tenant",
                    models.ForeignKey(
                        db_column="tenant_id",
                        on_delete=django.db.models.deletion.CASCADE,
                        to="tenants.tenantconfig",
                    ),
                ),
            ],
            options={
                "db_table": "signoff",
            },
        ),
        migrations.CreateModel(
            name="RiskOppAssessment",
            fields=[
                (
                    "risk_opp_assessment_id",
                    models.AutoField(primary_key=True, serialize=False),
                ),
                (
                    "fin_materiality_def_version_id",
                    models.IntegerField(blank=True, null=True),
                ),
                ("time_horizon", models.CharField(max_length=20)),
                ("workforce_risk", models.IntegerField(blank=True, null=True)),
                ("workforce_risk_rationale", models.TextField(blank=True, null=True)),
                ("operational_risk", models.IntegerField(blank=True, null=True)),
                ("operational_risk_rationale", models.TextField(blank=True, null=True)),
                ("cost_of_capital_risk", models.IntegerField(blank=True, null=True)),
                (
                    "cost_of_capital_risk_rationale",
                    models.TextField(blank=True, null=True),
                ),
                ("reputational_risk", models.IntegerField(blank=True, null=True)),
                (
                    "reputational_risk_rationale",
                    models.TextField(blank=True, null=True),
                ),
                ("legal_compliance_risk", models.IntegerField(blank=True, null=True)),
                (
                    "legal_compliance_risk_rationale",
                    models.TextField(blank=True, null=True),
                ),
                ("likelihood_score", models.IntegerField(blank=True, null=True)),
                ("likelihood_rationale", models.TextField(blank=True, null=True)),
                (
                    "financial_magnitude_score",
                    models.DecimalField(
                        blank=True, decimal_places=2, max_digits=5, null=True
                    ),
                ),
                (
                    "financial_materiality_score",
                    models.DecimalField(
                        blank=True, decimal_places=2, max_digits=5, null=True
                    ),
                ),
                ("overall_rationale", models.TextField(blank=True, null=True)),
                ("related_documents", models.TextField(blank=True, null=True)),
                ("created_on", models.DateTimeField(auto_now_add=True)),
                ("updated_on", models.DateTimeField(auto_now=True)),
                (
                    "iro",
                    models.ForeignKey(
                        db_column="iro_id",
                        on_delete=django.db.models.deletion.CASCADE,
                        to="assessments.iro",
                    ),
                ),
                (
                    "tenant",
                    models.ForeignKey(
                        db_column="tenant_id",
                        on_delete=django.db.models.deletion.CASCADE,
                        to="tenants.tenantconfig",
                    ),
                ),
            ],
            options={
                "db_table": "risk_opp_assessment",
            },
        ),
        migrations.CreateModel(
            name="IRORelationship",
            fields=[
                (
                    "relationship_id",
                    models.AutoField(primary_key=True, serialize=False),
                ),
                ("relationship_type", models.CharField(max_length=50)),
                ("created_on", models.DateTimeField(auto_now_add=True)),
                ("created_by", models.IntegerField()),
                ("notes", models.TextField(blank=True, null=True)),
                (
                    "source_iro",
                    models.ForeignKey(
                        db_column="source_iro_id",
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="source_relationships",
                        to="assessments.iro",
                    ),
                ),
                (
                    "target_iro",
                    models.ForeignKey(
                        db_column="target_iro_id",
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="target_relationships",
                        to="assessments.iro",
                    ),
                ),
                (
                    "tenant",
                    models.ForeignKey(
                        db_column="tenant_id",
                        on_delete=django.db.models.deletion.CASCADE,
                        to="tenants.tenantconfig",
                    ),
                ),
            ],
            options={
                "db_table": "iro_relationship",
            },
        ),
        migrations.CreateModel(
            name="ImpactMaterialityDef",
            fields=[
                ("def_id", models.AutoField(primary_key=True, serialize=False)),
                ("version_num", models.IntegerField()),
                ("dimension", models.CharField(max_length=50)),
                ("score_value", models.IntegerField()),
                ("definition_text", models.TextField()),
                ("valid_from", models.DateTimeField()),
                ("valid_to", models.DateTimeField(blank=True, null=True)),
                ("created_on", models.DateTimeField(auto_now_add=True)),
                ("created_by", models.IntegerField()),
                (
                    "tenant",
                    models.ForeignKey(
                        db_column="tenant_id",
                        on_delete=django.db.models.deletion.CASCADE,
                        to="tenants.tenantconfig",
                    ),
                ),
            ],
            options={
                "db_table": "impact_materiality_def",
            },
        ),
        migrations.CreateModel(
            name="ImpactAssessment",
            fields=[
                (
                    "impact_assessment_id",
                    models.AutoField(primary_key=True, serialize=False),
                ),
                (
                    "impact_materiality_def_version_id",
                    models.IntegerField(blank=True, null=True),
                ),
                ("time_horizon", models.CharField(max_length=20)),
                (
                    "actual_or_potential",
                    models.CharField(blank=True, max_length=50, null=True),
                ),
                (
                    "related_to_human_rights",
                    models.CharField(blank=True, max_length=50, null=True),
                ),
                ("scale_score", models.IntegerField(blank=True, null=True)),
                ("scale_rationale", models.TextField(blank=True, null=True)),
                ("scope_score", models.IntegerField(blank=True, null=True)),
                ("scope_rationale", models.TextField(blank=True, null=True)),
                ("irremediability_score", models.IntegerField(blank=True, null=True)),
                ("irremediability_rationale", models.TextField(blank=True, null=True)),
                ("likelihood_score", models.IntegerField(blank=True, null=True)),
                ("likelihood_rationale", models.TextField(blank=True, null=True)),
                (
                    "severity_score",
                    models.DecimalField(
                        blank=True, decimal_places=2, max_digits=5, null=True
                    ),
                ),
                (
                    "impact_materiality_score",
                    models.DecimalField(
                        blank=True, decimal_places=2, max_digits=5, null=True
                    ),
                ),
                ("overall_rationale", models.TextField(blank=True, null=True)),
                ("related_documents", models.TextField(blank=True, null=True)),
                ("created_on", models.DateTimeField(auto_now_add=True)),
                ("updated_on", models.DateTimeField(auto_now=True)),
                (
                    "iro",
                    models.ForeignKey(
                        db_column="iro_id",
                        on_delete=django.db.models.deletion.CASCADE,
                        to="assessments.iro",
                    ),
                ),
                (
                    "tenant",
                    models.ForeignKey(
                        db_column="tenant_id",
                        on_delete=django.db.models.deletion.CASCADE,
                        to="tenants.tenantconfig",
                    ),
                ),
            ],
            options={
                "db_table": "impact_assessment",
            },
        ),
        migrations.CreateModel(
            name="FinMaterialityWeights",
            fields=[
                ("weight_id", models.AutoField(primary_key=True, serialize=False)),
                ("version_num", models.IntegerField()),
                ("dimension", models.CharField(max_length=50)),
                ("weight", models.DecimalField(decimal_places=2, max_digits=5)),
                ("valid_from", models.DateTimeField()),
                ("valid_to", models.DateTimeField(blank=True, null=True)),
                ("created_on", models.DateTimeField(auto_now_add=True)),
                ("created_by", models.IntegerField()),
                (
                    "tenant",
                    models.ForeignKey(
                        db_column="tenant_id",
                        on_delete=django.db.models.deletion.CASCADE,
                        to="tenants.tenantconfig",
                    ),
                ),
            ],
            options={
                "db_table": "fin_materiality_weights",
            },
        ),
        migrations.CreateModel(
            name="FinMaterialityMagnitudeDef",
            fields=[
                ("def_id", models.AutoField(primary_key=True, serialize=False)),
                ("version_num", models.IntegerField()),
                ("score_value", models.IntegerField()),
                ("definition_text", models.TextField()),
                ("valid_from", models.DateTimeField()),
                ("valid_to", models.DateTimeField(blank=True, null=True)),
                ("created_on", models.DateTimeField(auto_now_add=True)),
                ("created_by", models.IntegerField()),
                (
                    "tenant",
                    models.ForeignKey(
                        db_column="tenant_id",
                        on_delete=django.db.models.deletion.CASCADE,
                        to="tenants.tenantconfig",
                    ),
                ),
            ],
            options={
                "db_table": "fin_materiality_magnitude_def",
            },
        ),
        migrations.CreateModel(
            name="AuditTrail",
            fields=[
                ("audit_id", models.AutoField(primary_key=True, serialize=False)),
                ("entity_type", models.CharField(max_length=50)),
                ("entity_id", models.IntegerField()),
                ("action", models.CharField(max_length=50)),
                ("user_id", models.IntegerField()),
                ("timestamp", models.DateTimeField(auto_now_add=True)),
                ("data_diff", models.JSONField(default=dict)),
                (
                    "tenant",
                    models.ForeignKey(
                        db_column="tenant_id",
                        on_delete=django.db.models.deletion.CASCADE,
                        to="tenants.tenantconfig",
                    ),
                ),
            ],
            options={
                "db_table": "audit_trail",
            },
        ),
    ]

</file>

<file path='apps/assessments/migrations/0002_assessment_tenant.py'>
# Generated by Django 4.2 on 2025-02-26 16:28

from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    dependencies = [
        ('tenants', '0001_initial'),
        ('assessments', '0001_initial'),
    ]

    operations = [
        migrations.AddField(
            model_name='assessment',
            name='tenant',
            field=models.ForeignKey(db_column='tenant_id', default=1, on_delete=django.db.models.deletion.CASCADE, to='tenants.tenantconfig'),
            preserve_default=False,
        ),
    ]

</file>

<file path='apps/assessments/migrations/0003_alter_assessment_tenant.py'>
# Generated by Django 4.2 on 2025-02-26 16:30

from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    dependencies = [
        ('tenants', '0001_initial'),
        ('assessments', '0002_assessment_tenant'),
    ]

    operations = [
        migrations.AlterField(
            model_name='assessment',
            name='tenant',
            field=models.ForeignKey(blank=True, db_column='tenant_id', null=True, on_delete=django.db.models.deletion.CASCADE, to='tenants.tenantconfig'),
        ),
    ]

</file>

<file path='apps/assessments/migrations/__init__.py'>

</file>

<file path='apps/assessments/models.py'>
# apps/assessments/models.py

from django.db import models
from tenants.models import TenantConfig


class Assessment(models.Model):
    """
    (Kept from your original code, in case you still need a top-level
     Assessment model. You can remove it if it's no longer used.)
    """
    tenant = models.ForeignKey(TenantConfig, on_delete=models.CASCADE, db_column="tenant_id", null=True, blank=True)
    name = models.CharField(max_length=200, help_text="Name of the assessment")
    description = models.TextField(blank=True, help_text="Optional description")
    created_on = models.DateTimeField(auto_now_add=True)
    updated_on = models.DateTimeField(auto_now=True)

    def __str__(self):
        return self.name

    class Meta:
        # This table also goes into each tenant schema if you want it that way. 
        db_table = 'assessment'


class IRO(models.Model):
    iro_id = models.AutoField(primary_key=True)
    tenant = models.ForeignKey(TenantConfig, on_delete=models.CASCADE, db_column="tenant_id")
    current_version_id = models.IntegerField(null=True, blank=True)
    current_stage = models.CharField(max_length=50, default='Draft')
    type = models.CharField(max_length=20)
    source_of_iro = models.CharField(max_length=255, null=True, blank=True)
    esrs_standard = models.CharField(max_length=100, null=True, blank=True)
    last_assessment_date = models.DateTimeField(null=True, blank=True)
    assessment_count = models.IntegerField(default=0)
    last_assessment_score = models.DecimalField(max_digits=5, decimal_places=2, null=True, blank=True)
    created_on = models.DateTimeField(auto_now_add=True)
    updated_on = models.DateTimeField(auto_now=True)

    class Meta:
        db_table = 'iro'
    
    @property
    def title(self):
        """Return the title from the current version of this IRO"""
        if self.current_version_id:
            try:
                version = IROVersion.objects.get(version_id=self.current_version_id)
                return version.title
            except IROVersion.DoesNotExist:
                pass
        
        # Fallback: try to get the latest version's title
        latest_version = IROVersion.objects.filter(iro=self).order_by('-version_number').first()
        if latest_version:
            return latest_version.title
        
        return f"IRO #{self.iro_id}"  # Fallback title
    
    @property
    def description(self):
        """Return the description from the current version of this IRO"""
        if self.current_version_id:
            try:
                version = IROVersion.objects.get(version_id=self.current_version_id)
                return version.description
            except IROVersion.DoesNotExist:
                pass
                
        # Fallback: try to get the latest version's description
        latest_version = IROVersion.objects.filter(iro=self).order_by('-version_number').first()
        if latest_version:
            return latest_version.description
            
        return ""  # Fallback description



class IROVersion(models.Model):
    version_id = models.AutoField(primary_key=True)
    iro = models.ForeignKey(IRO, on_delete=models.CASCADE, db_column="iro_id")
    tenant = models.ForeignKey(TenantConfig, on_delete=models.CASCADE, db_column="tenant_id")
    version_number = models.IntegerField()
    title = models.CharField(max_length=255)
    description = models.TextField()
    sust_topic_level1 = models.CharField(max_length=100, null=True, blank=True)
    sust_topic_level2 = models.CharField(max_length=100, null=True, blank=True)
    sust_topic_level3 = models.CharField(max_length=100, null=True, blank=True)
    value_chain_lv1 = models.JSONField(default=list)  # or ArrayField in Postgres
    value_chain_lv2 = models.JSONField(default=list)
    economic_activity = models.JSONField(default=list)
    status = models.CharField(max_length=50, default='Draft')
    created_by = models.IntegerField()
    created_on = models.DateTimeField(auto_now_add=True)
    parent_version_id = models.IntegerField(null=True, blank=True)
    split_type = models.CharField(max_length=50, null=True, blank=True)

    class Meta:
        db_table = 'iro_version'


class IRORelationship(models.Model):
    relationship_id = models.AutoField(primary_key=True)
    tenant = models.ForeignKey(TenantConfig, on_delete=models.CASCADE, db_column="tenant_id")
    source_iro = models.ForeignKey(IRO, on_delete=models.CASCADE, db_column="source_iro_id",
                                   related_name='source_relationships')
    target_iro = models.ForeignKey(IRO, on_delete=models.CASCADE, db_column="target_iro_id",
                                   related_name='target_relationships')
    relationship_type = models.CharField(max_length=50)
    created_on = models.DateTimeField(auto_now_add=True)
    created_by = models.IntegerField()
    notes = models.TextField(null=True, blank=True)

    class Meta:
        db_table = 'iro_relationship'


class ImpactAssessment(models.Model):
    impact_assessment_id = models.AutoField(primary_key=True)
    iro = models.ForeignKey(IRO, on_delete=models.CASCADE, db_column="iro_id")
    tenant = models.ForeignKey(TenantConfig, on_delete=models.CASCADE, db_column="tenant_id")
    impact_materiality_def_version_id = models.IntegerField(null=True, blank=True)
    time_horizon = models.CharField(max_length=20)
    actual_or_potential = models.CharField(max_length=50, null=True, blank=True)
    related_to_human_rights = models.CharField(max_length=50, null=True, blank=True)
    scale_score = models.IntegerField(null=True, blank=True)
    scale_rationale = models.TextField(null=True, blank=True)
    scope_score = models.IntegerField(null=True, blank=True)
    scope_rationale = models.TextField(null=True, blank=True)
    irremediability_score = models.IntegerField(null=True, blank=True)
    irremediability_rationale = models.TextField(null=True, blank=True)
    likelihood_score = models.IntegerField(null=True, blank=True)
    likelihood_rationale = models.TextField(null=True, blank=True)
    severity_score = models.DecimalField(max_digits=5, decimal_places=2, null=True, blank=True)
    impact_materiality_score = models.DecimalField(max_digits=5, decimal_places=2, null=True, blank=True)
    overall_rationale = models.TextField(null=True, blank=True)
    related_documents = models.TextField(null=True, blank=True)
    created_on = models.DateTimeField(auto_now_add=True)
    updated_on = models.DateTimeField(auto_now=True)

    class Meta:
        db_table = 'impact_assessment'


class RiskOppAssessment(models.Model):
    risk_opp_assessment_id = models.AutoField(primary_key=True)
    iro = models.ForeignKey(IRO, on_delete=models.CASCADE, db_column="iro_id")
    tenant = models.ForeignKey(TenantConfig, on_delete=models.CASCADE, db_column="tenant_id")
    fin_materiality_def_version_id = models.IntegerField(null=True, blank=True)
    time_horizon = models.CharField(max_length=20)
    workforce_risk = models.IntegerField(null=True, blank=True)
    workforce_risk_rationale = models.TextField(null=True, blank=True)
    operational_risk = models.IntegerField(null=True, blank=True)
    operational_risk_rationale = models.TextField(null=True, blank=True)
    cost_of_capital_risk = models.IntegerField(null=True, blank=True)
    cost_of_capital_risk_rationale = models.TextField(null=True, blank=True)
    reputational_risk = models.IntegerField(null=True, blank=True)
    reputational_risk_rationale = models.TextField(null=True, blank=True)
    legal_compliance_risk = models.IntegerField(null=True, blank=True)
    legal_compliance_risk_rationale = models.TextField(null=True, blank=True)
    likelihood_score = models.IntegerField(null=True, blank=True)
    likelihood_rationale = models.TextField(null=True, blank=True)
    financial_magnitude_score = models.DecimalField(max_digits=5, decimal_places=2, null=True, blank=True)
    financial_materiality_score = models.DecimalField(max_digits=5, decimal_places=2, null=True, blank=True)
    overall_rationale = models.TextField(null=True, blank=True)
    related_documents = models.TextField(null=True, blank=True)
    created_on = models.DateTimeField(auto_now_add=True)
    updated_on = models.DateTimeField(auto_now=True)

    class Meta:
        db_table = 'risk_opp_assessment'


class Review(models.Model):
    review_id = models.AutoField(primary_key=True)
    iro = models.ForeignKey(IRO, on_delete=models.CASCADE, db_column="iro_id")
    tenant = models.ForeignKey(TenantConfig, on_delete=models.CASCADE, db_column="tenant_id")
    iro_version = models.ForeignKey(IROVersion, on_delete=models.SET_NULL, db_column="iro_version_id",
                                    null=True, blank=True)
    reviewer_id = models.IntegerField()
    status = models.CharField(max_length=50, default='Draft')
    notes = models.TextField(default='', blank=True)
    created_on = models.DateTimeField(auto_now_add=True)
    updated_on = models.DateTimeField(auto_now=True)

    class Meta:
        db_table = 'review'


class Signoff(models.Model):
    signoff_id = models.AutoField(primary_key=True)
    review = models.ForeignKey(Review, on_delete=models.CASCADE, db_column="review_id")
    tenant = models.ForeignKey(TenantConfig, on_delete=models.CASCADE, db_column="tenant_id")
    iro_version = models.ForeignKey(IROVersion, on_delete=models.SET_NULL, db_column="iro_version_id",
                                    null=True, blank=True)
    signed_by = models.IntegerField()
    signed_on = models.DateTimeField(auto_now_add=True)
    signature_ref = models.CharField(max_length=255, null=True, blank=True)
    comments = models.TextField(default='', blank=True)

    class Meta:
        db_table = 'signoff'


class AuditTrail(models.Model):
    audit_id = models.AutoField(primary_key=True)
    tenant = models.ForeignKey(TenantConfig, on_delete=models.CASCADE, db_column="tenant_id")
    entity_type = models.CharField(max_length=50)
    entity_id = models.IntegerField()
    action = models.CharField(max_length=50)
    user_id = models.IntegerField()
    timestamp = models.DateTimeField(auto_now_add=True)
    data_diff = models.JSONField(default=dict)

    class Meta:
        db_table = 'audit_trail'


class ImpactMaterialityDef(models.Model):
    def_id = models.AutoField(primary_key=True)
    tenant = models.ForeignKey(TenantConfig, on_delete=models.CASCADE, db_column="tenant_id")
    version_num = models.IntegerField()
    dimension = models.CharField(max_length=50)
    score_value = models.IntegerField()
    definition_text = models.TextField()
    valid_from = models.DateTimeField()
    valid_to = models.DateTimeField(null=True, blank=True)
    created_on = models.DateTimeField(auto_now_add=True)
    created_by = models.IntegerField()

    class Meta:
        db_table = 'impact_materiality_def'


class FinMaterialityWeights(models.Model):
    weight_id = models.AutoField(primary_key=True)
    tenant = models.ForeignKey(TenantConfig, on_delete=models.CASCADE, db_column="tenant_id")
    version_num = models.IntegerField()
    dimension = models.CharField(max_length=50)
    weight = models.DecimalField(max_digits=5, decimal_places=2)
    valid_from = models.DateTimeField()
    valid_to = models.DateTimeField(null=True, blank=True)
    created_on = models.DateTimeField(auto_now_add=True)
    created_by = models.IntegerField()

    class Meta:
        db_table = 'fin_materiality_weights'


class FinMaterialityMagnitudeDef(models.Model):
    def_id = models.AutoField(primary_key=True)
    tenant = models.ForeignKey(TenantConfig, on_delete=models.CASCADE, db_column="tenant_id")
    version_num = models.IntegerField()
    score_value = models.IntegerField()
    definition_text = models.TextField()
    valid_from = models.DateTimeField()
    valid_to = models.DateTimeField(null=True, blank=True)
    created_on = models.DateTimeField(auto_now_add=True)
    created_by = models.IntegerField()

    class Meta:
        db_table = 'fin_materiality_magnitude_def'
</file>

<file path='apps/assessments/tasks.py'>
# apps/assessments/tasks.py
from celery import shared_task

@shared_task
def example_task(assessment_id):
    # your asynchronous logic, e.g., sending an email after an assessment is created
    pass
</file>

<file path='apps/assessments/templatetags/__init__.py'>

</file>

<file path='apps/assessments/templatetags/assessment_filters.py'>
from django import template

register = template.Library()

@register.filter(name='mul')
def mul(value, arg):
    """Multiply the value by the argument"""
    try:
        return float(value) * float(arg)
    except (ValueError, TypeError):
        return ''

</file>

<file path='apps/assessments/urls.py'>
# apps/assessments/urls.py
from django.urls import path
from .views import (
    AssessmentListView, AssessmentCreateView, AssessmentUpdateView,
    IROListView, IROCreateView, IROUpdateView, iro_save, assessment_save,
    assessment_data, iro_data
)

app_name = 'assessments'

urlpatterns = [
    path('', AssessmentListView.as_view(), name='list'),
    path('create/', AssessmentCreateView.as_view(), name='create'),
    path('<int:pk>/edit/', AssessmentUpdateView.as_view(), name='edit'),
    path('assessment/data/', assessment_data, name='assessment-data'),
    path('assessment/save/', assessment_save, name='assessment-save'),

    # IRO CRUD
    path('iro/', IROListView.as_view(), name='iro-list'),
    path('iro/create/', IROCreateView.as_view(), name='iro-create'),
    path('iro/<int:pk>/edit/', IROUpdateView.as_view(), name='iro-edit'),
    path('iro/data/', iro_data, name='iro-data'),
    path('iro/save/', iro_save, name='iro-save'),  # Add this line for saving IRO data
]
</file>

<file path='apps/assessments/utils.py'>
from django.db import connection
from django_tenants.utils import schema_context

def get_iros_for_tenant(tenant=None):
    """
    Get IROs for a specific tenant or use the current schema if no tenant specified.
    Returns a list of IRO objects to ensure they're fully loaded before exiting schema context.
    """
    from apps.assessments.models import IRO  # Import here to avoid circular imports
    
    try:
        if tenant and hasattr(tenant, 'schema_name') and tenant.schema_name:
            # If a tenant is specified, use its schema
            from django_tenants.utils import schema_context
            try:
                with schema_context(tenant.schema_name):
                    try:
                        # Try to get all IROs for this tenant
                        iros = list(IRO.objects.filter(tenant=tenant))
                        return iros
                    except Exception as inner_e:
                        print(f"Error querying IROs in tenant schema {tenant.schema_name}: {str(inner_e)}")
                        return []
            except Exception as schema_e:
                print(f"Error switching to schema {tenant.schema_name}: {str(schema_e)}")
                return []
        else:
            # If no valid tenant, use the current schema but be careful about filtering
            try:
                from django.db import connection
                current_schema = connection.schema_name
                if current_schema and current_schema.startswith('tenant_'):
                    # We're in a tenant schema, get all IROs for this schema
                    try:
                        return list(IRO.objects.all())
                    except Exception as query_e:
                        print(f"Error querying IROs in current schema {current_schema}: {str(query_e)}")
                        return []
                else:
                    # We're in the public schema, we can't get IROs directly
                    return []
            except Exception as conn_e:
                print(f"Error determining current schema: {str(conn_e)}")
                return []
    except Exception as e:
        import traceback
        print(f"Error in get_iros_for_tenant: {str(e)}")
        print(traceback.format_exc())
        return []

def get_iro_by_id(iro_id, tenant=None):
    """
    Get a specific IRO by ID for a tenant.
    Returns the IRO object or None if not found.
    """
    from apps.assessments.models import IRO  # Import here to avoid circular imports
    
    if tenant:
        with schema_context(tenant.schema_name):
            try:
                return IRO.objects.get(iro_id=iro_id, tenant=tenant)
            except IRO.DoesNotExist:
                return None
    else:
        # If no tenant, use the current schema
        current_schema = connection.schema_name
        if current_schema.startswith('tenant_'):
            # We're in a tenant schema, try to get the IRO
            try:
                return IRO.objects.get(iro_id=iro_id)
            except IRO.DoesNotExist:
                return None
        else:
            # We're in the public schema, we can't get IROs directly
            return None

def get_all_tenant_iros():
    """
    Get IROs from all tenant schemas.
    This is useful for admin views or aggregate dashboards.
    """
    from tenants.models import TenantConfig
    from apps.assessments.models import IRO
    
    all_iros = []
    
    for tenant in TenantConfig.objects.all():
        with schema_context(tenant.schema_name):
            # Convert QuerySet to list to ensure objects are fully loaded
            tenant_iros = list(IRO.objects.filter(tenant=tenant))
            all_iros.extend(tenant_iros)
    
    return all_iros
</file>

<file path='apps/assessments/views.py'>
# apps/assessments/views.py
from django.http import JsonResponse
from django.views.decorators.http import require_POST
from django.views.generic import ListView, CreateView, UpdateView
from django.urls import reverse_lazy
import json
from django_tenants.utils import schema_context
import tenants.models

from .models import Assessment, IRO

# Define the class-based views needed for URLs
class AssessmentListView(ListView):
    model = Assessment
    template_name = 'assessments/assessment_list.html'
    context_object_name = 'assessments'
    
    def get_queryset(self):
        # Get tenant from context middleware
        tenant = self.request.context.get('tenant')
        if tenant:
            return Assessment.objects.filter(tenant=tenant)
        return Assessment.objects.all()

class AssessmentCreateView(CreateView):
    model = Assessment
    template_name = 'assessments/assessment_form.html'
    fields = ['name', 'description']
    success_url = reverse_lazy('assessments:list')
    
    def form_valid(self, form):
        # Set tenant from context
        form.instance.tenant = self.request.context.get('tenant')
        return super().form_valid(form)

class AssessmentUpdateView(UpdateView):
    model = Assessment
    template_name = 'assessments/assessment_form.html'
    fields = ['name', 'description']
    success_url = reverse_lazy('assessments:list')

class IROListView(ListView):
    model = IRO
    template_name = 'assessments/iro_list.html'
    context_object_name = 'iros'
    
    def get_queryset(self):
        # Get tenant from context middleware
        tenant = self.request.context.get('tenant')
        if tenant:
            return IRO.objects.filter(tenant=tenant)
        return IRO.objects.all()
    
    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        
        # Add available tenants to context
        context['available_tenants'] = tenants.models.TenantConfig.objects.all()
        
        # Add available assessments for the selected tenant
        if self.request.context.get('tenant'):
            tenant = self.request.context.get('tenant')
            with schema_context(tenant.schema_name):
                context['available_assessments'] = list(Assessment.objects.filter(tenant=tenant))
        else:
            context['available_assessments'] = []
        
        # Add available IROs for the selected tenant
        if self.request.context.get('tenant'):
            tenant = self.request.context.get('tenant')
            with schema_context(tenant.schema_name):
                context['available_iros'] = list(IRO.objects.filter(tenant=tenant))
        else:
            context['available_iros'] = []
        
        return context

class IROCreateView(CreateView):
    model = IRO
    template_name = 'assessments/iro_form.html'
    fields = ['type', 'source_of_iro', 'esrs_standard']
    success_url = reverse_lazy('assessments:iro-list')
    
    def form_valid(self, form):
        # Set tenant from context
        form.instance.tenant = self.request.context.get('tenant')
        return super().form_valid(form)
    
    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        
        # Add available tenants to context
        context['available_tenants'] = tenants.models.TenantConfig.objects.all()
        
        # Add available assessments for the selected tenant
        if self.request.context.get('tenant'):
            tenant = self.request.context.get('tenant')
            with schema_context(tenant.schema_name):
                context['available_assessments'] = list(Assessment.objects.filter(tenant=tenant))
        else:
            context['available_assessments'] = []
        
        # Add available IROs for the selected tenant
        if self.request.context.get('tenant'):
            tenant = self.request.context.get('tenant')
            with schema_context(tenant.schema_name):
                context['available_iros'] = list(IRO.objects.filter(tenant=tenant))
        else:
            context['available_iros'] = []
        
        return context

class IROUpdateView(UpdateView):
    model = IRO
    template_name = 'assessments/iro_form.html'
    fields = ['type', 'source_of_iro', 'esrs_standard', 'current_stage']
    success_url = reverse_lazy('assessments:iro-list')
    
    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        # Add latest version information
        iro = self.get_object()
        context['latest_version'] = iro.iroversion_set.order_by('-version_number').first()
        
        # Add available tenants to context
        context['available_tenants'] = tenants.models.TenantConfig.objects.all()
        
        # Add available assessments for the selected tenant
        if self.request.context.get('tenant'):
            tenant = self.request.context.get('tenant')
            with schema_context(tenant.schema_name):
                context['available_assessments'] = list(Assessment.objects.filter(tenant=tenant))
        else:
            context['available_assessments'] = []
        
        # Add available IROs for the selected tenant
        if self.request.context.get('tenant'):
            tenant = self.request.context.get('tenant')
            with schema_context(tenant.schema_name):
                context['available_iros'] = list(IRO.objects.filter(tenant=tenant))
        else:
            context['available_iros'] = []
        
        return context

# ContextMixin needed for API views
class ContextMixin:
    """
    Mixin to filter queryset based on tenant context.
    Used by API views to respect tenant boundaries.
    """
    def get_queryset(self):
        queryset = super().get_queryset()
        tenant = self.request.context.get('tenant')
        if tenant:
            return queryset.filter(tenant=tenant)
        return queryset

# Add these functions to the end of apps/assessments/views.py

@require_POST
def iro_save(request):
    """
    View to save IRO changes from Handsontable.
    Expects a JSON POST with 'changes' and 'contextData'.
    """
    try:
        data = json.loads(request.body)
        changes = data.get('changes', [])
        context_data = data.get('contextData', {})
        
        # Extract tenant and assessment from context
        tenant = None
        if 'tenant' in context_data and context_data['tenant']:
            tenant_id = context_data['tenant']
            from tenants.models import TenantConfig
            tenant = TenantConfig.objects.get(tenant_id=tenant_id)
        
        # Process changes
        updated_rows = 0
        for row_change in changes:
            row_data = row_change.get('data')
            iro_changes = row_change.get('changes', {})
            
            if 'iro_id' in row_data:
                iro_id = row_data['iro_id']
                
                # Get the IRO instance
                from apps.assessments.utils import get_iro_by_id
                iro = get_iro_by_id(iro_id, tenant)
                
                if iro:
                    # Update fields based on changes
                    for field, value in iro_changes.items():
                        if hasattr(iro, field):
                            setattr(iro, field, value)
                    
                    # Save the changes
                    iro.save()
                    updated_rows += 1
        
        return JsonResponse({
            'success': True,
            'message': f"Updated {updated_rows} IROs"
        })
    except Exception as e:
        return JsonResponse({
            'success': False,
            'message': str(e)
        }, status=400)

@require_POST
def assessment_save(request):
    """
    View to save Assessment changes from Handsontable.
    """
    try:
        data = json.loads(request.body)
        changes = data.get('changes', [])
        context_data = data.get('contextData', {})
        
        # Extract tenant from context
        tenant = None
        if 'tenant' in context_data and context_data['tenant']:
            tenant_id = context_data['tenant']
            from tenants.models import TenantConfig
            tenant = TenantConfig.objects.get(tenant_id=tenant_id)
        
        # Process changes
        updated_rows = 0
        for row_change in changes:
            row_data = row_change.get('data')
            assessment_changes = row_change.get('changes', {})
            
            if 'id' in row_data:
                assessment_id = row_data['id']
                
                try:
                    from apps.assessments.models import Assessment
                    assessment = Assessment.objects.get(id=assessment_id)
                    
                    # Update fields based on changes
                    for field, value in assessment_changes.items():
                        if hasattr(assessment, field):
                            setattr(assessment, field, value)
                    
                    # Save the changes
                    assessment.save()
                    updated_rows += 1
                except Assessment.DoesNotExist:
                    pass
        
        return JsonResponse({
            'success': True,
            'message': f"Updated {updated_rows} assessments"
        })
    except Exception as e:
        return JsonResponse({
            'success': False,
            'message': str(e)
        }, status=400)

def assessment_data(request):
    """
    API view to return assessment data for Handsontable.
    """
    assessments = []
    
    tenant = request.context.get('tenant')
    
    from apps.assessments.models import Assessment
    if tenant:
        from django_tenants.utils import schema_context
        with schema_context(tenant.schema_name):
            assessment_queryset = Assessment.objects.filter(tenant=tenant)
            
            for assessment in assessment_queryset:
                assessments.append({
                    'id': assessment.id,
                    'name': assessment.name,
                    'description': assessment.description,
                    'created_on': assessment.created_on.strftime('%Y-%m-%d %H:%M:%S'),
                    'updated_on': assessment.updated_on.strftime('%Y-%m-%d %H:%M:%S')
                })
    else:
        # Handle case where we need to aggregate assessments from all tenants
        from tenants.models import TenantConfig
        for t in TenantConfig.objects.all():
            with schema_context(t.schema_name):
                assessment_queryset = Assessment.objects.filter(tenant=t)
                
                for assessment in assessment_queryset:
                    assessments.append({
                        'id': assessment.id,
                        'name': assessment.name,
                        'description': assessment.description,
                        'created_on': assessment.created_on.strftime('%Y-%m-%d %H:%M:%S'),
                        'updated_on': assessment.updated_on.strftime('%Y-%m-%d %H:%M:%S')
                    })
        
    return JsonResponse(assessments, safe=False)

def iro_data(request):
    """
    API view to return IRO data for Handsontable.
    """
    try:
        # Get the tenant from context
        tenant = request.context.get('tenant')
        
        # Early validation for tenant
        if tenant:
            # Verify tenant exists and has a valid schema_name
            if not hasattr(tenant, 'schema_name') or not tenant.schema_name:
                # Return empty array with status 200 instead of error
                print("No valid schema_name found for tenant")
                return JsonResponse([], safe=False)
        
        # Get IROs from utility function
        from apps.assessments.utils import get_iros_for_tenant, get_all_tenant_iros
        
        iros = []
        iro_queryset = []
        
        # Get the IRO queryset based on tenant context
        try:
            if tenant:
                print(f"Getting IROs for tenant: {tenant.tenant_name}")
                iro_queryset = get_iros_for_tenant(tenant)
            else:
                print("Getting IROs for all tenants")
                iro_queryset = get_all_tenant_iros()
        except Exception as e:
            import traceback
            print(f"Error getting IRO queryset: {str(e)}")
            print(traceback.format_exc())
            # Return empty array with status 200 instead of error
            return JsonResponse([], safe=False)
            
        # Prepare data for each IRO
        for iro in iro_queryset:
            try:
                # Initialize values with safe defaults
                impact_score = 0.0
                financial_score = 0.0
                title = f"IRO #{getattr(iro, 'iro_id', 'unknown')}"  # Safe default
                
                # Ensure we have a valid tenant for this IRO
                tenant_to_use = None
                try:
                    # First try to use the current context tenant
                    if tenant and hasattr(tenant, 'schema_name') and tenant.schema_name:
                        tenant_to_use = tenant
                    # If not available, try to use the IRO's tenant
                    elif hasattr(iro, 'tenant') and iro.tenant and hasattr(iro.tenant, 'schema_name') and iro.tenant.schema_name:
                        tenant_to_use = iro.tenant
                except Exception as tenant_err:
                    print(f"Error determining tenant for IRO {getattr(iro, 'iro_id', 'unknown')}: {str(tenant_err)}")
                
                # Only proceed with valid tenant and schema_name
                if tenant_to_use and tenant_to_use.schema_name:
                    from django_tenants.utils import schema_context
                    
                    # Get impact and financial scores
                    try:
                        with schema_context(tenant_to_use.schema_name):
                            from apps.assessments.models import ImpactAssessment, RiskOppAssessment
                            
                            impact_assessment = ImpactAssessment.objects.filter(iro=iro).order_by('-created_on').first()
                            if impact_assessment and impact_assessment.impact_materiality_score:
                                try:
                                    impact_score = float(impact_assessment.impact_materiality_score)
                                except (ValueError, TypeError):
                                    impact_score = 0.0
                                
                            risk_opp_assessment = RiskOppAssessment.objects.filter(iro=iro).order_by('-created_on').first()
                            if risk_opp_assessment and risk_opp_assessment.financial_materiality_score:
                                try:
                                    financial_score = float(risk_opp_assessment.financial_materiality_score)
                                except (ValueError, TypeError):
                                    financial_score = 0.0
                    except Exception as score_err:
                        print(f"Error getting assessment scores for IRO {getattr(iro, 'iro_id', 'unknown')}: {str(score_err)}")
                    
                    # Get the title safely
                    try:
                        # Try using the property method first
                        if hasattr(iro, 'title'):
                            title = str(iro.title) if iro.title is not None else title
                        else:
                            # If no title property, fetch title manually
                            from apps.assessments.models import IROVersion
                            with schema_context(tenant_to_use.schema_name):
                                version = None
                                if hasattr(iro, 'current_version_id') and iro.current_version_id:
                                    version = IROVersion.objects.filter(version_id=iro.current_version_id).first()
                                if not version and hasattr(iro, 'iro_id'):
                                    version = IROVersion.objects.filter(iro=iro).order_by('-version_number').first()
                                if version and version.title:
                                    title = str(version.title)
                    except Exception as title_err:
                        print(f"Error getting title for IRO {getattr(iro, 'iro_id', 'unknown')}: {str(title_err)}")
                
                # Safely get last_assessment_date
                last_assessment_date = ''
                if hasattr(iro, 'last_assessment_date') and iro.last_assessment_date:
                    try:
                        last_assessment_date = iro.last_assessment_date.strftime('%Y-%m-%d')
                    except Exception as date_err:
                        print(f"Error formatting last_assessment_date for IRO {getattr(iro, 'iro_id', 'unknown')}: {str(date_err)}")
                
                # Get iro_id safely
                iro_id = getattr(iro, 'iro_id', 0)
                # Make sure iro_id is an integer or a string representation of an integer
                if not isinstance(iro_id, (int, str)) or (isinstance(iro_id, str) and not iro_id.isdigit()):
                    iro_id = 0  # Default to 0 if not valid
                    print(f"WARNING: Invalid iro_id type: {type(iro_id)}, value: {iro_id}. Defaulting to 0.")
                
                # Get other fields safely with explicit string conversion and validation
                # Ensure type is one of the expected values
                raw_type = getattr(iro, 'type', '')
                if raw_type in ['Risk', 'Opportunity', 'Impact']:
                    iro_type = str(raw_type)
                else:
                    # Default to 'Risk' if not one of the expected values
                    iro_type = 'Risk'
                    print(f"WARNING: Invalid type for IRO {iro_id}: {raw_type}. Defaulting to 'Risk'.")
                
                # Normalize esrs_standard
                esrs_standard = str(getattr(iro, 'esrs_standard', '') or '')
                
                # Ensure current_stage is one of the expected values
                raw_stage = getattr(iro, 'current_stage', '')
                valid_stages = ['Draft', 'In_Review', 'Approved', 'Disclosed']
                if raw_stage in valid_stages:
                    current_stage = str(raw_stage)
                else:
                    # Default to 'Draft' if not one of the expected values
                    current_stage = 'Draft'
                    print(f"WARNING: Invalid current_stage for IRO {iro_id}: {raw_stage}. Defaulting to 'Draft'.")
                
                # Build the IRO data dictionary with safe defaults for all fields
                iro_data = {
                    'iro_id': iro_id,
                    'type': iro_type,
                    'title': title,
                    'esrs_standard': esrs_standard,
                    'current_stage': current_stage,
                    'impact_score': impact_score,
                    'financial_score': financial_score,
                    'last_assessment_date': last_assessment_date,
                }
                
                # Debug log to help identify issues
                print(f"DEBUG: Prepared IRO data for IRO {iro_id}: type={iro_type}, stage={current_stage}")
                
                iros.append(iro_data)
            except Exception as e:
                # Log error but continue with other IROs
                import traceback
                print(f"Error processing IRO {getattr(iro, 'iro_id', 'unknown')}: {str(e)}")
                print(traceback.format_exc())
                
                # Add a placeholder entry so the table isn't completely empty
                iros.append({
                    'iro_id': getattr(iro, 'iro_id', 'unknown'),
                    'type': 'Risk',  # Default to a valid value
                    'title': f"Error loading IRO #{getattr(iro, 'iro_id', 'unknown')}",
                    'esrs_standard': '',
                    'current_stage': 'Draft',  # Default to a valid value
                    'impact_score': 0.0,
                    'financial_score': 0.0,
                    'last_assessment_date': '',
                })
        
        # Always return status 200 with the data we have
        return JsonResponse(iros, safe=False)
                
    except Exception as e:
        # Log the exception for debugging
        import traceback
        print(f"Error in iro_data view: {str(e)}")
        print(traceback.format_exc())
        
        # Return an empty array with status 200 instead of error
        return JsonResponse([], safe=False)
</file>

<file path='core/__init__.py'>

</file>

<file path='core/celery.py'>
# core/celery.py
import os
from celery import Celery

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'core.settings.local')

app = Celery('core')
app.config_from_object('django.conf:settings', namespace='CELERY')
app.autodiscover_tasks()

</file>

<file path='core/middleware/__init__.py'>
# core/middleware/__init__.py
# This file intentionally left blank to make the directory a Python package
</file>

<file path='core/middleware/context_middleware.py'>
from django.urls import resolve
from django.db import connection
from tenants.models import TenantConfig
from apps.assessments.models import Assessment, IRO
from django_tenants.utils import schema_context

class ContextMiddleware:
    """
    Middleware to manage hierarchical context:
    - tenant (company)
    - assessment (first time vs refresh)
    - IRO (specific IRO being assessed)
    """
    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        # Initialize context attributes
        request.context = {
            'tenant': None,
            'assessment': None,
            'iro': None
        }

        # Check for tenant in session first (manually selected tenant)
        if 'tenant_id' in request.session:
            try:
                tenant_id = request.session['tenant_id']
                # Always query TenantConfig from public schema
                with schema_context('public'):
                    tenant = TenantConfig.objects.get(tenant_id=tenant_id)
                    # Verify tenant has a valid schema_name
                    if not hasattr(tenant, 'schema_name') or not tenant.schema_name:
                        print(f"Warning: Tenant {tenant_id} has invalid schema_name")
                        del request.session['tenant_id']
                        request.context['tenant'] = None
                    else:
                        request.context['tenant'] = tenant
            except TenantConfig.DoesNotExist:
                # Clear invalid tenant from session
                if 'tenant_id' in request.session:
                    del request.session['tenant_id']

        # Fallback to request.tenant (set by django-tenants based on domain)
        elif hasattr(request, 'tenant'):
            request.context['tenant'] = request.tenant
        # Final fallback: try to determine tenant from the current schema
        elif connection.schema_name.startswith('tenant_'):
            # Extract tenant name from schema_name (tenant_tenant1 -> tenant1)
            tenant_name = connection.schema_name[7:]
            # Always query TenantConfig from public schema
            with schema_context('public'):
                try:
                    tenant = TenantConfig.objects.get(tenant_name=tenant_name)
                    request.context['tenant'] = tenant
                except TenantConfig.DoesNotExist:
                    pass

        # If we still don't have a tenant and we're visiting the root domain,
        # try to set a default tenant
        if not request.context['tenant'] and request.get_host() in ('localhost', '127.0.0.1'):
            try:
                # Always query TenantConfig from public schema
                with schema_context('public'):
                    # Try to use the first tenant as default for the root domain
                    default_tenant = TenantConfig.objects.first()
                    if default_tenant:
                        request.context['tenant'] = default_tenant
                        request.session['tenant_id'] = default_tenant.tenant_id
            except Exception:
                pass

        # Check session for stored context values
        if 'assessment_id' in request.session:
            tenant = request.context['tenant']
            if tenant:
                try:
                    assessment_id = request.session['assessment_id']
                    with schema_context(tenant.schema_name):
                        request.context['assessment'] = Assessment.objects.get(id=assessment_id)
                except Assessment.DoesNotExist:
                    # Clear invalid context
                    if 'assessment_id' in request.session:
                        del request.session['assessment_id']

        if 'iro_id' in request.session:
            try:
                iro_id = request.session['iro_id']
                if request.context['tenant']:
                    from apps.assessments.utils import get_iro_by_id
                    iro = get_iro_by_id(iro_id, request.context['tenant'])
                    request.context['iro'] = iro
            except Exception:
                if 'iro_id' in request.session:
                    del request.session['iro_id']

        # Handle context updates from GET parameters
        if 'tenant_id' in request.GET: 
            try:
                tenant_id = int(request.GET.get('tenant_id'))
                # Always query TenantConfig from public schema
                with schema_context('public'):
                    tenant = TenantConfig.objects.get(tenant_id=tenant_id)
                request.context['tenant'] = tenant
                request.session['tenant_id'] = tenant_id
            except (ValueError, TenantConfig.DoesNotExist):
                pass

        if 'assessment_id' in request.GET:
            tenant = request.context['tenant']
            if tenant:
                try:
                    assessment_id = int(request.GET.get('assessment_id'))
                    with schema_context(tenant.schema_name):
                        assessment = Assessment.objects.get(id=assessment_id)
                    request.context['assessment'] = assessment
                    request.session['assessment_id'] = assessment_id
                    # Clear IRO when assessment changes
                    if 'iro_id' in request.session:
                        del request.session['iro_id']
                except (ValueError, Assessment.DoesNotExist):
                    pass

        if 'iro_id' in request.GET:
            try:
                iro_id = int(request.GET.get('iro_id'))
                if request.context['tenant']:
                    from apps.assessments.utils import get_iro_by_id
                    iro = get_iro_by_id(iro_id, request.context['tenant'])
                    if iro:
                        request.context['iro'] = iro
                        request.session['iro_id'] = iro_id
            except Exception:
                pass

        # Process the request
        response = self.get_response(request)
        return response
</file>

<file path='core/middleware/logging_middleware.py'>
# core/middleware/logging_middleware.py
import json
import logging
import time
from django.utils import timezone

request_logger = logging.getLogger('apps.requests')

class LoggingMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        # Log the request details
        start_time = time.time()
        
        # Process the request
        response = self.get_response(request)
        
        # Calculate request duration
        duration = time.time() - start_time
        
        # Prepare logging information
        log_data = {
            'timestamp': timezone.now().isoformat(),
            'method': request.method,
            'path': request.path,
            'user': str(request.user) if request.user.is_authenticated else 'anonymous',
            'status_code': response.status_code,
            'duration': round(duration * 1000, 2),  # Convert to milliseconds
            'content_type': response.get('Content-Type', ''),
        }
        
        # Add query params without sensitive data
        params = {}
        for key, value in request.GET.items():
            if key.lower() not in ('password', 'token', 'auth', 'key'):
                params[key] = value
        if params:
            log_data['query_params'] = params
        
        # Log request details
        log_message = f"{log_data['method']} {log_data['path']} - {log_data['status_code']} in {log_data['duration']}ms"
        
        # Use appropriate log level based on response status
        if response.status_code >= 500:
            request_logger.error(log_message, extra={'log_data': log_data})
        elif response.status_code >= 400:
            request_logger.warning(log_message, extra={'log_data': log_data})
        else:
            request_logger.info(log_message, extra={'log_data': log_data})
        
        return response
</file>

<file path='core/settings/__init__.py'>
# This file is intentionally empty (or can be left out if not needed).
# It just tells Python that 'settings' is a package.
</file>

<file path='core/settings/base.py'>
# core/settings/base.py

import os
from pathlib import Path
import logging
from datetime import datetime

BASE_DIR = Path(__file__).resolve().parent.parent

SECRET_KEY = 'replace-this-with-a-real-secret-key'
DEBUG = False
ALLOWED_HOSTS = []

########################
# DJANGO-TENANTS SETUP #
########################

# The main django-tenants library
# Make sure you have installed django-tenants in your environment:
# pip install django-tenants

# We must split our apps into SHARED_APPS and TENANT_APPS.
# SHARED_APPS = apps common to all tenants, created in the public schema.
# TENANT_APPS = apps that will be created separately in each tenant schema.

SHARED_APPS = [
    'django_tenants',                  # mandatory for django-tenants
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    # Include the app that contains the Tenant and Domain models
    'tenants',
    'crispy_forms',
    'crispy_bootstrap5',
    'guardian',
    'rest_framework',
]

TENANT_APPS = [
    # These apps' models will be created in each tenant's individual schema:
    'apps.assessments',
    # Add additional tenant-specific apps here if needed
]

# The combination of SHARED_APPS and TENANT_APPS becomes the full INSTALLED_APPS:
INSTALLED_APPS = SHARED_APPS + TENANT_APPS

# The model that points to your tenant (public) table:
TENANT_MODEL = 'tenants.TenantConfig'     # app_label.ModelName
# The model that stores the domain -> tenant mapping:
TENANT_DOMAIN_MODEL = "tenants.TenantDomain"     # app_label.ModelName

# For Bootstrap 5 or another template pack, also install crispy-bootstrap5
CRISPY_ALLOWED_TEMPLATE_PACKS = "bootstrap5"
CRISPY_TEMPLATE_PACK = "bootstrap5"

DATABASE_ROUTERS = (
    'django_tenants.routers.TenantSyncRouter',
)

########################
# END DJANGO-TENANTS   #
########################

# core/settings/base.py - update MIDDLEWARE list

MIDDLEWARE = [
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django_tenants.middleware.main.TenantMainMiddleware',
    'whitenoise.middleware.WhiteNoiseMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',  # Authentication must run BEFORE our middleware
    'core.middleware.context_middleware.ContextMiddleware',     # Context middleware
    'core.middleware.logging_middleware.LoggingMiddleware',     # Add logging middleware
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]
########################
# NEW: Guardian & Auth #
########################
AUTHENTICATION_BACKENDS = [
    'django.contrib.auth.backends.ModelBackend',             # default model backend
    'guardian.backends.ObjectPermissionBackend',             # enable object-level perms
]
ANONYMOUS_USER_NAME = "AnonymousUser"  # Guardian recommended setting

ROOT_URLCONF = 'core.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': ["templates"],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'core.wsgi.application'

########################
# DATABASE CONFIG      #
########################
# Make sure you set the actual DB credentials in local/production overrides
# or environment variables. django-tenants uses the default DB connection,
# but the schema is adjusted per tenant request.

DATABASES = {
    'default': {
        'ENGINE': 'django_tenants.postgresql_backend',  # Changed from django.db.backends.postgresql
        'NAME': 'dma_db',
        'USER': 'dma_user',
        'PASSWORD': 'password',
        'HOST': 'db',
        'PORT': '5432',
    }
}

AUTH_PASSWORD_VALIDATORS = [
    {'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator'},
    {'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator'},
    {'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator'},
    {'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator'},
]

LANGUAGE_CODE = 'en-us'
TIME_ZONE = 'UTC'
USE_I18N = True
USE_TZ = True

STATIC_URL = '/static/'
STATIC_ROOT = os.path.join(BASE_DIR, 'static')
STATICFILES_DIRS = [
    os.path.join(BASE_DIR.parent, 'static'),
]
STATICFILES_STORAGE = 'whitenoise.storage.CompressedManifestStaticFilesStorage'

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

# Example Celery or other global settings can remain here
CELERY_BROKER_URL = os.getenv('CELERY_BROKER_URL', 'redis://localhost:6379/0')

########################
# LOGGING CONFIGURATION #
########################

# Create logs directory if it doesn't exist
LOG_DIR = os.path.join(BASE_DIR.parent, 'logs')
os.makedirs(LOG_DIR, exist_ok=True)

# Get the current datetime for the log filename
log_datetime = datetime.now().strftime('%Y%m%d_%H%M%S')
LOG_FILENAME = f'app_{log_datetime}.log'

LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'verbose': {
            'format': '{levelname} {asctime} {module} {process:d} {thread:d} {message}',
            'style': '{',
        },
        'simple': {
            'format': '{levelname} {asctime} {message}',
            'style': '{',
        },
        'tenant_aware': {
            'format': '{levelname} {asctime} {module} [TENANT:{tenant}] {message}',
            'style': '{',
        },
    },
    'filters': {
        'require_debug_true': {
            '()': 'django.utils.log.RequireDebugTrue',
        },
    },
    'handlers': {
        'console': {
            'level': 'INFO',
            'class': 'logging.StreamHandler',
            'formatter': 'simple',
        },
        'file': {
            'level': 'DEBUG',
            'class': 'logging.FileHandler',
            'filename': os.path.join(LOG_DIR, LOG_FILENAME),
            'formatter': 'verbose',
        },
        'tenant_file': {
            'level': 'DEBUG',
            'class': 'logging.FileHandler',
            'filename': os.path.join(LOG_DIR, LOG_FILENAME),
            'formatter': 'tenant_aware',
        },
        'mail_admins': {
            'level': 'ERROR',
            'class': 'django.utils.log.AdminEmailHandler',
            'formatter': 'verbose',
        },
    },
    'loggers': {
        'django': {
            'handlers': ['console', 'file'],
            'level': 'INFO',
            'propagate': True,
        },
        'django.server': {
            'handlers': ['console', 'file'],
            'level': 'INFO',
            'propagate': False,
        },
        'django.db.backends': {
            'handlers': ['console', 'file'],
            'level': 'INFO',
            'propagate': False,
        },
        'apps': {
            'handlers': ['console', 'tenant_file'],
            'level': 'DEBUG',
            'propagate': False,
        },
        'tenants': {
            'handlers': ['console', 'tenant_file'],
            'level': 'DEBUG',
            'propagate': False,
        },
        'frontend': {
            'handlers': ['console', 'file'],
            'level': 'DEBUG',
            'propagate': False,
        },
        'core': {
            'handlers': ['console', 'tenant_file'],
            'level': 'DEBUG',
            'propagate': False,
        },
    }
}
</file>

<file path='core/settings/local.py'>
# core/settings/local.py
import os
import dj_database_url
from .base import *

# Enable DEBUG mode for local development
DEBUG = True

# Allow all hosts in local dev
ALLOWED_HOSTS = ["*"]

# 1) Parse connection info from DATABASE_URL (or default).
db_config = dj_database_url.config(
    default=os.getenv("DATABASE_URL", "postgres://postgres:password@localhost:5432/postgres"),
    conn_max_age=600,
)

# 2) Force the Django Tenants engine rather than the default Postgres engine
db_config['ENGINE'] = 'django_tenants.postgresql_backend'

DATABASES = {
    'default': db_config
}

# Disable password validators locally, for developer convenience
AUTH_PASSWORD_VALIDATORS = []

# Point Celery broker to Redis, or default to local Redis container
CELERY_BROKER_URL = os.getenv("CELERY_BROKER_URL", "redis://redis:6379/0")

# Override the log level in development to see more details
LOGGING['loggers']['django']['level'] = 'DEBUG'
LOGGING['loggers']['apps']['level'] = 'DEBUG'
LOGGING['loggers']['tenants']['level'] = 'DEBUG'
LOGGING['loggers']['frontend']['level'] = 'DEBUG'

# Also log to the console in development
for logger_name in LOGGING['loggers']:
    if 'console' not in LOGGING['loggers'][logger_name]['handlers']:
        LOGGING['loggers'][logger_name]['handlers'].append('console')
</file>

<file path='core/settings/production.py'>
# core/settings/production.py
import os
import dj_database_url
from .base import *

# Disable debug mode
DEBUG = False

# Set allowed hosts
ALLOWED_HOSTS = ['your-domain.com']  # Add your actual production domain(s)

# Security settings
SESSION_COOKIE_SECURE = True
CSRF_COOKIE_SECURE = True
SECURE_SSL_REDIRECT = True
SECURE_HSTS_SECONDS = 31536000  # 1 year
SECURE_HSTS_INCLUDE_SUBDOMAINS = True
SECURE_HSTS_PRELOAD = True
SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')

# Database configuration
db_config = dj_database_url.config(
    default=os.getenv("DATABASE_URL"),
    conn_max_age=600,
)
db_config['ENGINE'] = 'django_tenants.postgresql_backend'

DATABASES = {
    'default': db_config
}

# Celery configuration
CELERY_BROKER_URL = os.getenv("CELERY_BROKER_URL")

# Production logging
# Adjust log paths for production environment
log_dir = os.getenv('LOG_DIR', '/var/log/dma')
os.makedirs(log_dir, exist_ok=True)

# Update log file locations for production
LOGGING['handlers']['file_backend']['filename'] = os.path.join(log_dir, f'backend_{APP_RUN_TIMESTAMP}.log')
LOGGING['handlers']['file_frontend']['filename'] = os.path.join(log_dir, f'frontend_{APP_RUN_TIMESTAMP}.log')

# Increase max log file size
LOGGING['handlers']['file_backend']['maxBytes'] = 1024*1024*50  # 50 MB
LOGGING['handlers']['file_frontend']['maxBytes'] = 1024*1024*50  # 50 MB

# Add email handler for errors in production
LOGGING['handlers']['mail_admins'] = {
    'level': 'ERROR',
    'filters': ['require_debug_false'],
    'class': 'django.utils.log.AdminEmailHandler',
    'include_html': True,
}

LOGGING['loggers']['django']['handlers'].append('mail_admins')
</file>

<file path='core/urls.py'>
# core/urls.py - Update the URL patterns

from django.contrib import admin
from django.urls import path, include
from django.views.generic import TemplateView
from . import views

urlpatterns = [
    # Keep existing URLs
    path('', views.home_dashboard, name='home'),
    path('admin/', admin.site.urls),
    path('assessments/', include('apps.assessments.urls')),
    path('tenants/', include('tenants.urls', namespace='tenants')),
    path('api/assessments/', include('apps.assessments.api.urls')),  
    path('api/tenants/', include('tenants.api.urls')), 
    path('set-context/', views.set_context, name='set_context'),
    
    # Add new URL for frontend logs
    path('api/logs/frontend/', views.frontend_log, name='frontend_log'),
]
</file>

<file path='core/views.py'>
# core/views.py
from django.http import JsonResponse
from django.shortcuts import redirect, render
from django.views.decorators.http import require_GET
from tenants.models import TenantConfig
from apps.assessments.models import Assessment, IRO, ImpactAssessment, RiskOppAssessment, AuditTrail, Review
from django_tenants.utils import schema_context
import json
import logging
from django.views.decorators.csrf import csrf_exempt
from django.views.decorators.http import require_POST


def home_dashboard(request):
    # Get tenant from context middleware
    tenant = request.context.get('tenant')
    
    # Import the utility function
    from apps.assessments.utils import get_iros_for_tenant, get_all_tenant_iros
    
    # Get IROs based on tenant context
    if tenant:
        iro_queryset = get_iros_for_tenant(tenant)
    else:
        # If no tenant selected, get IROs from all tenant schemas
        iro_queryset = get_all_tenant_iros()
    
    # Calculate metrics for dashboard
    total_iros = len(iro_queryset)
    
    # Define high materiality as IROs with score > 3.5
    high_materiality_count = sum(1 for iro in iro_queryset if iro.last_assessment_score and iro.last_assessment_score > 3.5)
    
    # Count pending reviews
    if tenant:
        with schema_context(tenant.schema_name):
            pending_reviews_count = Review.objects.filter(status='In_Review', tenant=tenant).count()
    else:
        # Aggregate across all tenants
        pending_reviews_count = 0
        for t in TenantConfig.objects.all():
            with schema_context(t.schema_name):
                pending_reviews_count += Review.objects.filter(status='In_Review').count()
    
    # Count completed assessments (approved)
    completed_assessments_count = sum(1 for iro in iro_queryset if iro.current_stage == 'Approved')
    
    # Get recent activity from audit trail
    if tenant:
        with schema_context(tenant.schema_name):
            recent_activities = list(AuditTrail.objects.filter(tenant=tenant).order_by('-timestamp')[:5])
    else:
        # Aggregate across all tenants
        recent_activities = []
        for t in TenantConfig.objects.all():
            with schema_context(t.schema_name):
                tenant_activities = list(AuditTrail.objects.filter(tenant=t).order_by('-timestamp')[:5])
                recent_activities.extend(tenant_activities)
        # Re-sort combined list
        recent_activities.sort(key=lambda x: x.timestamp, reverse=True)
        recent_activities = recent_activities[:5]
    
    # Process activities to add color and icon information
    activity_data = []
    for activity in recent_activities:
        activity_info = {
            'timestamp': activity.timestamp,
            'action': activity.action,
            'description': f"{activity.entity_type} #{activity.entity_id} {activity.action}",
        }
        
        # Set icon and color based on action type
        if activity.action == 'created':
            activity_info['icon'] = 'plus'
            activity_info['icon_color'] = 'info'
        elif activity.action == 'updated':
            activity_info['icon'] = 'edit'
            activity_info['icon_color'] = 'warning'
        elif activity.action == 'approved':
            activity_info['icon'] = 'check'
            activity_info['icon_color'] = 'success'
        elif activity.action == 'deleted':
            activity_info['icon'] = 'trash'
            activity_info['icon_color'] = 'danger'
        else:
            activity_info['icon'] = 'clipboard-list'
            activity_info['icon_color'] = 'primary'
            
        activity_data.append(activity_info)
    
    # Get high priority IROs (highest scores)
    high_priority_iros = []
    
    # Sort IROs by last_assessment_score (if available)
    sorted_iros = sorted(
        [iro for iro in iro_queryset if iro.last_assessment_score], 
        key=lambda x: x.last_assessment_score, 
        reverse=True
    )
    
    for iro in sorted_iros[:10]:
        # Get the latest impact and financial scores
        if tenant:
            with schema_context(tenant.schema_name):
                impact_assessments = list(ImpactAssessment.objects.filter(iro=iro).order_by('-created_on'))
                risk_opp_assessments = list(RiskOppAssessment.objects.filter(iro=iro).order_by('-created_on'))
        else:
            # Use the IRO's tenant schema
            tenant_obj = iro.tenant
            with schema_context(tenant_obj.schema_name):
                impact_assessments = list(ImpactAssessment.objects.filter(iro=iro).order_by('-created_on'))
                risk_opp_assessments = list(RiskOppAssessment.objects.filter(iro=iro).order_by('-created_on'))
        
        impact_score = impact_assessments[0].impact_materiality_score if impact_assessments else 0.0
        financial_score = risk_opp_assessments[0].financial_materiality_score if risk_opp_assessments else 0.0
        
        high_priority_iros.append({
            'iro_id': iro.iro_id,
            'title': iro.title,
            'type': iro.type,
            'impact_score': float(impact_score) if impact_score else 0.0,
            'financial_score': float(financial_score) if financial_score else 0.0,
            'current_stage': iro.current_stage,
        })
    
    # Prepare data for materiality matrix
    matrix_data = []
    for iro in iro_queryset:
        if tenant:
            with schema_context(tenant.schema_name):
                impact_assessment = ImpactAssessment.objects.filter(iro=iro).order_by('-created_on').first()
                risk_opp_assessment = RiskOppAssessment.objects.filter(iro=iro).order_by('-created_on').first()
        else:
            # Use the IRO's tenant schema
            tenant_obj = iro.tenant
            with schema_context(tenant_obj.schema_name):
                impact_assessment = ImpactAssessment.objects.filter(iro=iro).order_by('-created_on').first()
                risk_opp_assessment = RiskOppAssessment.objects.filter(iro=iro).order_by('-created_on').first()
        
        if impact_assessment and risk_opp_assessment:
            matrix_data.append({
                'id': iro.iro_id,
                'title': iro.title,
                'type': iro.type,
                'impact_score': float(impact_assessment.impact_materiality_score or 0),
                'financial_score': float(risk_opp_assessment.financial_materiality_score or 0),
            })
    
    context = {
        'total_iros': total_iros,
        'high_materiality_count': high_materiality_count,
        'pending_reviews_count': pending_reviews_count,
        'completed_assessments_count': completed_assessments_count,
        'recent_activities': activity_data,
        'high_priority_iros': high_priority_iros,
        'high_priority_iros_json': json.dumps(high_priority_iros),  # Add JSON serialized data for Handsontable
        'materiality_matrix_data': json.dumps(matrix_data),
    }
    
    # Always add available tenants to context for the tenant selector, not just for staff users
    context['available_tenants'] = TenantConfig.objects.all()
    
    # ADD THIS SECTION: Fetch available assessments for the selected tenant
    available_assessments = []
    if tenant:
        with schema_context(tenant.schema_name):
            available_assessments = list(Assessment.objects.filter(tenant=tenant))
    context['available_assessments'] = available_assessments
    
    # If we have a tenant but no IROs selected yet, prepare available IROs list
    available_iros = []
    if tenant:
        with schema_context(tenant.schema_name):
            available_iros = list(IRO.objects.filter(tenant=tenant))
    context['available_iros'] = available_iros
    
    return render(request, 'home.html', context)

@require_GET
def set_context(request):
    """
    View to handle setting context values and redirecting.
    Can be called via AJAX or as a normal GET request.
    """
    from django_tenants.utils import schema_context
    
    redirect_url = request.GET.get('next', '/')
    is_ajax = request.headers.get('X-Requested-With') == 'XMLHttpRequest'
    
    # Safely check if user is authenticated and staff
    is_staff = hasattr(request, 'user') and request.user.is_authenticated and request.user.is_staff
    
    # Check for tenant selection (admin only)
    if 'tenant_id' in request.GET and is_staff:
        try:
            tenant_id = int(request.GET.get('tenant_id'))
            # Always query TenantConfig from public schema
            with schema_context('public'):
                tenant = TenantConfig.objects.get(tenant_id=tenant_id)
                request.session['tenant_id'] = tenant_id
        except (ValueError, TenantConfig.DoesNotExist):
            pass
    
    
    # Check for assessment selection
    if 'assessment_id' in request.GET:
        try:
            assessment_id = int(request.GET.get('assessment_id'))
            tenant = request.context.get('tenant')
            if tenant:
                with schema_context(tenant.schema_name):
                    assessment = Assessment.objects.get(id=assessment_id)
                    request.session['assessment_id'] = assessment_id
                    # Clear IRO when assessment changes
                    if 'iro_id' in request.session:
                        del request.session['iro_id']
        except (ValueError, Assessment.DoesNotExist):
            pass
    
    # Check for IRO selection
    if 'iro_id' in request.GET:
        try:
            iro_id = int(request.GET.get('iro_id'))
            if request.context.get('tenant'):
                from apps.assessments.utils import get_iro_by_id
                iro = get_iro_by_id(iro_id, request.context.get('tenant'))
                if iro:
                    request.session['iro_id'] = iro_id
        except ValueError:
            pass
    
    if is_ajax:
        # For AJAX requests, return updated context as JSON
        context = {
            'tenant': None,
            'assessment': None,
            'iro': None
        }
        
        # Populate context based on session values
        if 'tenant_id' in request.session:
            try:
                # Always query TenantConfig from public schema
                with schema_context('public'):
                    tenant = TenantConfig.objects.get(tenant_id=request.session['tenant_id'])
                    context['tenant'] = {
                        'tenant_id': tenant.tenant_id,
                        'tenant_name': tenant.tenant_name
                    }
            except TenantConfig.DoesNotExist:
                pass
        
        if 'assessment_id' in request.session and 'tenant_id' in request.session:
            try:
                # Get tenant for schema context
                with schema_context('public'):
                    tenant = TenantConfig.objects.get(tenant_id=request.session['tenant_id'])
                
                # Get assessment using tenant's schema
                with schema_context(tenant.schema_name):
                    assessment = Assessment.objects.get(id=request.session['assessment_id'])
                    context['assessment'] = {
                        'id': assessment.id,
                        'name': assessment.name,
                        'description': assessment.description
                    }
            except (TenantConfig.DoesNotExist, Assessment.DoesNotExist):
                pass
        
        if 'iro_id' in request.session and 'tenant_id' in request.session:
            try:
                # Get tenant for schema context
                with schema_context('public'):
                    tenant = TenantConfig.objects.get(tenant_id=request.session['tenant_id'])
                
                # Get IRO using tenant's schema
                from apps.assessments.utils import get_iro_by_id
                iro = get_iro_by_id(request.session['iro_id'], tenant)
                if iro:
                    context['iro'] = {
                        'iro_id': iro.iro_id,
                        'title': iro.title if hasattr(iro, 'title') else f"IRO #{iro.iro_id}",
                        'type': iro.type
                    }
            except TenantConfig.DoesNotExist:
                pass
        
        return JsonResponse({
            'success': True,
            'context': context,
            'redirect_url': redirect_url if request.GET.get('reload', False) else None
        })
    else:
        # For non-AJAX requests, redirect to the specified next URL
        return redirect(redirect_url)
    

# Get the frontend logger
frontend_logger = logging.getLogger('frontend')

@require_POST
@csrf_exempt  # In production, you should use proper CSRF protection
def frontend_log(request):
    """
    Endpoint to receive logs from the frontend
    """
    try:
        data = json.loads(request.body)
        logs = data.get('logs', [])
        
        for log_entry in logs:
            level = log_entry.get('level', 'INFO').upper()
            message = log_entry.get('message', '')
            context = log_entry.get('context', {})
            
            # Add request metadata
            meta = {
                'ip': request.META.get('REMOTE_ADDR'),
                'user_agent': log_entry.get('userAgent'),
                'url': log_entry.get('url'),
                'user': str(request.user) if request.user.is_authenticated else 'anonymous',
                'session_id': log_entry.get('sessionId'),
            }
            
            # Combine context with metadata
            extra = {'meta': meta, 'context': context}
            
            # Log with appropriate level
            if level == 'DEBUG':
                frontend_logger.debug(message, extra=extra)
            elif level == 'INFO':
                frontend_logger.info(message, extra=extra)
            elif level == 'WARNING':
                frontend_logger.warning(message, extra=extra)
            elif level == 'ERROR':
                frontend_logger.error(message, extra=extra)
            elif level == 'CRITICAL':
                frontend_logger.critical(message, extra=extra)
            else:
                frontend_logger.info(message, extra=extra)
        
        return JsonResponse({'success': True, 'count': len(logs)})
    
    except json.JSONDecodeError:
        return JsonResponse({'success': False, 'error': 'Invalid JSON'}, status=400)
    except Exception as e:
        return JsonResponse({'success': False, 'error': str(e)}, status=500)
</file>

<file path='core/wsgi.py'>
# core/wsgi.py
import os
from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'core.settings.local')

application = get_wsgi_application()
</file>

<file path='docker-compose.yaml'>
services:
  web:
    build: .
    command: >
      sh -c "
        until pg_isready -h db -p 5432 -U dma_user; do 
          echo 'Waiting for database...'; 
          sleep 2; 
        done;
        # Optional but recommended to include the tenants app in makemigrations:
        python manage.py makemigrations tenants;
        python manage.py makemigrations;

        # 1) Migrate shared schema
        python manage.py migrate_schemas --shared;

        # 2) Create or update the default tenant
        python manage.py init_tenant --name=default --domain=localhost;

        # 3) Migrate the tenant schemas
        python manage.py migrate_schemas --tenant;
        
        # 4) Initialize sample data for testing
        python manage.py init_sample_data;
        
        # Check if tenant schemas have the iro table after migration
        echo 'Listing tables in tenant_tenant1 schema...'
        PGPASSWORD=password psql -h db -U dma_user -d dma_db -c \"\\dt tenant_tenant1.*\"
        echo 'Listing tables in tenant_tenant2 schema...'
        PGPASSWORD=password psql -h db -U dma_user -d dma_db -c \"\\dt tenant_tenant2.*\"

        # 5) Collect static files so admin CSS/JS are available
        python manage.py collectstatic --noinput;

        # Finally start Gunicorn
        gunicorn core.wsgi:application --bind 0.0.0.0:8000
      "
    volumes:
      - .:/app
      - app_logs:/app/logs
    ports:
      - "8000:8000"
    environment:
      - DJANGO_SETTINGS_MODULE=core.settings.local
      - DATABASE_URL=postgres://dma_user:password@db:5432/dma_db
      - CELERY_BROKER_URL=redis://redis:6379/0
      - PYTHONUNBUFFERED=1
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  db:
    image: postgres:14
    restart: always
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts:/docker-entrypoint-initdb.d
    environment:
      POSTGRES_USER: dma_user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: dma_db
      POSTGRES_INITDB_ARGS: "--auth-host=scram-sha-256"
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dma_user -d dma_db"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  redis:
    image: redis:7
    restart: always
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  worker:
    build: .
    user: appuser  # Use the non-root user
    command: celery -A core worker --loglevel=info
    volumes:
      - .:/app
    environment:
      - DJANGO_SETTINGS_MODULE=core.settings.local
      - DATABASE_URL=postgres://dma_user:password@db:5432/dma_db
      - CELERY_BROKER_URL=redis://redis:6379/0
      - PYTHONUNBUFFERED=1
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  postgres_data:
  app_logs:
</file>

<file path='ensure_static_files.py'>
#!/usr/bin/env python
# ensure_static_files.py
import os
import shutil
import sys

def ensure_handsontable_manager_js():
    """
    Ensures that handsontable-manager.js is properly collected and accessible.
    """
    # Define paths
    project_root = os.path.dirname(os.path.abspath(__file__))
    source_file = os.path.join(project_root, 'static', 'js', 'handsontable-manager.js')
    static_root = os.path.join(project_root, 'core', 'static', 'js')
    target_file = os.path.join(static_root, 'handsontable-manager.js')
    
    # Ensure target directory exists
    os.makedirs(static_root, exist_ok=True)
    
    # Check if source file exists
    if not os.path.exists(source_file):
        print(f"Error: Source file {source_file} does not exist.")
        return False
    
    # Copy file
    try:
        shutil.copy2(source_file, target_file)
        print(f"Successfully copied {source_file} to {target_file}")
        return True
    except Exception as e:
        print(f"Error copying file: {str(e)}")
        return False

if __name__ == "__main__":
    success = ensure_handsontable_manager_js()
    sys.exit(0 if success else 1)
</file>

<file path='manage.py'>
#!/usr/bin/env python
import os
import sys

def main():
    """Run administrative tasks."""
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'core.settings.local')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Make sure it's installed and "
            "available on your PYTHONPATH environment variable. "
            "Did you forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)

if __name__ == '__main__':
    main()
</file>

<file path='requirements.txt'>
# requirements.txt
Django==4.2
gunicorn==20.1.0
psycopg2-binary==2.9.6
redis==4.5.5
celery==5.2.7
dj-database-url==0.5.0
django-tenants==3.5.0
django-crispy-forms==2.3
djangorestframework==3.14
crispy-bootstrap5==0.7
django-guardian==2.4.0
whitenoise==6.4.0

</file>

<file path='run_local.sh'>
#!/usr/bin/env bash

# run_local.sh
# Run this any time you need to rebuild or re-init the local environment.

# Exit on error
set -e

echo "Stopping any running containers..."
docker compose down

echo "Removing postgres volume to ensure a fresh database..."
docker volume rm -f $(docker volume ls -q | grep postgres_data) || true

echo "Building Docker images..."
docker compose build

echo "Starting containers in the background..."
docker compose up -d

# Wait a few seconds to ensure the web container is fully started
echo "Waiting for the web container to finish startup..."
sleep 5

# First check if migrations are needed
echo "Checking if migrations are needed..."
if ! docker compose exec -T web python manage.py makemigrations --check; then
    echo "Migrations are needed. Creating migrations with default value for tenant field..."
    # Simulate selecting option 1 (one-off default) and providing default value 1
    docker compose exec -T web bash -c "echo -e \"1\n1\n\" | python manage.py makemigrations assessments"
else
    echo "No migrations needed."
fi

echo "Running shared migrations..."
docker compose exec -T web python manage.py migrate_schemas --shared

echo "Creating or updating default tenant..."
docker compose exec -T web python manage.py init_tenant --name=default --domain=localhost

echo "Running tenant migrations..."
docker compose exec -T web python manage.py migrate_schemas --tenant

echo "Prepopulating sample data (2 tenants, each with 5 IROs fully assessed)..."
docker compose exec -T web python manage.py init_sample_data

echo "Tailing logs. Press Ctrl+C to stop."
docker compose logs -f

</file>

<file path='scripts/01-init-schemas.sql'>
--
-- 01-init-schemas.sql
--

-- Define the create_tenant_schema function without trying to create public.tenant_config
-- or referencing its tenant_id field via foreign keys. 
-- If you invoke create_tenant_schema('some_tenant') manually, 
-- it will create the schema and the tenant-specific tables only.
--

CREATE OR REPLACE FUNCTION create_tenant_schema(tenant_name TEXT) RETURNS void AS $$
DECLARE
    schema_name TEXT := 'tenant_' || tenant_name;
BEGIN
    -- 1) Create the tenant schema if it doesn’t exist
    EXECUTE format('CREATE SCHEMA IF NOT EXISTS %I', schema_name);

    ---------------------------------------------------------------------------
    -- 2) IRO
    ---------------------------------------------------------------------------
    EXECUTE format($f$
        CREATE TABLE IF NOT EXISTS %I.iro (
            iro_id SERIAL PRIMARY KEY,
            tenant_id INT NOT NULL,
            current_version_id INT,
            current_stage VARCHAR(50) NOT NULL DEFAULT 'Draft',
            type VARCHAR(20) NOT NULL,
            source_of_iro VARCHAR(255),
            esrs_standard VARCHAR(100),
            last_assessment_date TIMESTAMP,
            assessment_count INT DEFAULT 0,
            last_assessment_score NUMERIC(5,2),
            created_on TIMESTAMP NOT NULL DEFAULT NOW(),
            updated_on TIMESTAMP NOT NULL DEFAULT NOW()
        );
        CREATE INDEX IF NOT EXISTS idx_iro_tenant_id     ON %I.iro (tenant_id);
        CREATE INDEX IF NOT EXISTS idx_iro_stage         ON %I.iro (current_stage);
        CREATE INDEX IF NOT EXISTS idx_iro_esrs_standard ON %I.iro (esrs_standard);
    $f$, schema_name, schema_name, schema_name, schema_name);

    ---------------------------------------------------------------------------
    -- 3) IRO_Version
    ---------------------------------------------------------------------------
    EXECUTE format($f$
        CREATE TABLE IF NOT EXISTS %I.iro_version (
            version_id SERIAL PRIMARY KEY,
            iro_id INT NOT NULL,
            tenant_id INT NOT NULL,
            version_number INT NOT NULL,
            title VARCHAR(255) NOT NULL,
            description TEXT NOT NULL,
            sust_topic_level1 VARCHAR(100),
            sust_topic_level2 VARCHAR(100),
            sust_topic_level3 VARCHAR(100),
            value_chain_lv1 VARCHAR[] DEFAULT '{}',
            value_chain_lv2 VARCHAR[] DEFAULT '{}',
            economic_activity VARCHAR[] DEFAULT '{}',
            status VARCHAR(50) NOT NULL DEFAULT 'Draft',
            created_by INT NOT NULL,
            created_on TIMESTAMP NOT NULL DEFAULT NOW(),
            parent_version_id INT,
            split_type VARCHAR(50)
        );
        CREATE INDEX IF NOT EXISTS idx_iro_version_iro_id    ON %I.iro_version (iro_id);
        CREATE INDEX IF NOT EXISTS idx_iro_version_tenant_id ON %I.iro_version (tenant_id);
        CREATE INDEX IF NOT EXISTS idx_iro_version_status    ON %I.iro_version (status);
    $f$, schema_name, schema_name, schema_name, schema_name);

    ---------------------------------------------------------------------------
    -- 4) IRO_Relationship
    ---------------------------------------------------------------------------
    EXECUTE format($f$
        CREATE TABLE IF NOT EXISTS %I.iro_relationship (
            relationship_id SERIAL PRIMARY KEY,
            tenant_id INT NOT NULL,
            source_iro_id INT NOT NULL,
            target_iro_id INT NOT NULL,
            relationship_type VARCHAR(50) NOT NULL,
            created_on TIMESTAMP NOT NULL DEFAULT NOW(),
            created_by INT NOT NULL,
            notes TEXT
        );
        CREATE INDEX IF NOT EXISTS idx_iro_relationship_tenant_id ON %I.iro_relationship (tenant_id);
        CREATE INDEX IF NOT EXISTS idx_iro_relationship_src_tgt   ON %I.iro_relationship (source_iro_id, target_iro_id);
    $f$, schema_name, schema_name, schema_name, schema_name);

    ---------------------------------------------------------------------------
    -- 5) impact_assessment
    ---------------------------------------------------------------------------
    EXECUTE format($f$
        CREATE TABLE IF NOT EXISTS %I.impact_assessment (
            impact_assessment_id SERIAL PRIMARY KEY,
            iro_id INT NOT NULL,
            tenant_id INT NOT NULL,
            impact_materiality_def_version_id INT,
            time_horizon VARCHAR(20) NOT NULL,
            actual_or_potential VARCHAR(50),
            related_to_human_rights VARCHAR(50),
            scale_score INT CHECK (scale_score BETWEEN 1 AND 5),
            scale_rationale TEXT,
            scope_score INT CHECK (scope_score BETWEEN 1 AND 5),
            scope_rationale TEXT,
            irremediability_score INT CHECK (irremediability_score BETWEEN 1 AND 5),
            irremediability_rationale TEXT,
            likelihood_score INT CHECK (likelihood_score BETWEEN 1 AND 5),
            likelihood_rationale TEXT,
            severity_score NUMERIC(5,2),
            impact_materiality_score NUMERIC(5,2),
            overall_rationale TEXT,
            related_documents TEXT,
            created_on TIMESTAMP NOT NULL DEFAULT NOW(),
            updated_on TIMESTAMP NOT NULL DEFAULT NOW()
        );
        CREATE INDEX IF NOT EXISTS idx_impact_assessment_tenant_id ON %I.impact_assessment (tenant_id);
        CREATE INDEX IF NOT EXISTS idx_impact_assessment_iro_id    ON %I.impact_assessment (iro_id);
    $f$, schema_name, schema_name, schema_name, schema_name);

    ---------------------------------------------------------------------------
    -- 6) risk_opp_assessment
    ---------------------------------------------------------------------------
    EXECUTE format($f$
        CREATE TABLE IF NOT EXISTS %I.risk_opp_assessment (
            risk_opp_assessment_id SERIAL PRIMARY KEY,
            iro_id INT NOT NULL,
            tenant_id INT NOT NULL,
            fin_materiality_def_version_id INT,
            time_horizon VARCHAR(20) NOT NULL,
            workforce_risk INT CHECK (workforce_risk BETWEEN 1 AND 5),
            workforce_risk_rationale TEXT,
            operational_risk INT CHECK (operational_risk BETWEEN 1 AND 5),
            operational_risk_rationale TEXT,
            cost_of_capital_risk INT CHECK (cost_of_capital_risk BETWEEN 1 AND 5),
            cost_of_capital_risk_rationale TEXT,
            reputational_risk INT CHECK (reputational_risk BETWEEN 1 AND 5),
            reputational_risk_rationale TEXT,
            legal_compliance_risk INT CHECK (legal_compliance_risk BETWEEN 1 AND 5),
            legal_compliance_risk_rationale TEXT,
            likelihood_score INT CHECK (likelihood_score BETWEEN 1 AND 5),
            likelihood_rationale TEXT,
            financial_magnitude_score NUMERIC(5,2),
            financial_materiality_score NUMERIC(5,2),
            overall_rationale TEXT,
            related_documents TEXT,
            created_on TIMESTAMP NOT NULL DEFAULT NOW(),
            updated_on TIMESTAMP NOT NULL DEFAULT NOW()
        );
        CREATE INDEX IF NOT EXISTS idx_risk_opp_assessment_tenant_id ON %I.risk_opp_assessment (tenant_id);
        CREATE INDEX IF NOT EXISTS idx_risk_opp_assessment_iro_id    ON %I.risk_opp_assessment (iro_id);
    $f$, schema_name, schema_name, schema_name, schema_name);

    ---------------------------------------------------------------------------
    -- 7) review
    ---------------------------------------------------------------------------
    EXECUTE format($f$
        CREATE TABLE IF NOT EXISTS %I.review (
            review_id SERIAL PRIMARY KEY,
            iro_id INT NOT NULL,
            tenant_id INT NOT NULL,
            iro_version_id INT,
            reviewer_id INT NOT NULL,
            status VARCHAR(50) NOT NULL DEFAULT 'Draft',
            notes TEXT NOT NULL DEFAULT '',
            created_on TIMESTAMP NOT NULL DEFAULT NOW(),
            updated_on TIMESTAMP NOT NULL DEFAULT NOW()
        );
        CREATE INDEX IF NOT EXISTS idx_review_tenant_id  ON %I.review (tenant_id);
        CREATE INDEX IF NOT EXISTS idx_review_iro_id     ON %I.review (iro_id);
        CREATE INDEX IF NOT EXISTS idx_review_version_id ON %I.review (iro_version_id);
        CREATE INDEX IF NOT EXISTS idx_review_status     ON %I.review (status);
    $f$, schema_name, schema_name, schema_name, schema_name);

    ---------------------------------------------------------------------------
    -- 8) signoff
    ---------------------------------------------------------------------------
    EXECUTE format($f$
        CREATE TABLE IF NOT EXISTS %I.signoff (
            signoff_id SERIAL PRIMARY KEY,
            review_id INT NOT NULL,
            tenant_id INT NOT NULL,
            iro_version_id INT,
            signed_by INT NOT NULL,
            signed_on TIMESTAMP NOT NULL DEFAULT NOW(),
            signature_ref VARCHAR(255),
            comments TEXT NOT NULL DEFAULT ''
        );
        CREATE INDEX IF NOT EXISTS idx_signoff_tenant_id ON %I.signoff (tenant_id);
        CREATE INDEX IF NOT EXISTS idx_signoff_review_id ON %I.signoff (review_id);
        CREATE INDEX IF NOT EXISTS idx_signoff_signed_by ON %I.signoff (signed_by);
    $f$, schema_name, schema_name, schema_name, schema_name);

    ---------------------------------------------------------------------------
    -- 9) audit_trail
    ---------------------------------------------------------------------------
    EXECUTE format($f$
        CREATE TABLE IF NOT EXISTS %I.audit_trail (
            audit_id SERIAL PRIMARY KEY,
            tenant_id INT NOT NULL,
            entity_type VARCHAR(50) NOT NULL,
            entity_id INT NOT NULL,
            action VARCHAR(50) NOT NULL,
            user_id INT NOT NULL,
            timestamp TIMESTAMP NOT NULL DEFAULT NOW(),
            data_diff JSONB NOT NULL DEFAULT '{}'
        );
        CREATE INDEX IF NOT EXISTS idx_audit_trail_tenant_id      ON %I.audit_trail (tenant_id);
        CREATE INDEX IF NOT EXISTS idx_audit_trail_entity_type_id ON %I.audit_trail (entity_type, entity_id);
        CREATE INDEX IF NOT EXISTS idx_audit_trail_timestamp      ON %I.audit_trail (timestamp);
    $f$, schema_name, schema_name, schema_name, schema_name);

    ---------------------------------------------------------------------------
    -- 10) AUXILIARY TABLES
    ---------------------------------------------------------------------------
    EXECUTE format($f$
        CREATE TABLE IF NOT EXISTS %I.impact_materiality_def (
            def_id SERIAL PRIMARY KEY,
            tenant_id INT NOT NULL,
            version_num INT NOT NULL,
            dimension VARCHAR(50) NOT NULL,
            score_value INT NOT NULL CHECK (score_value BETWEEN 1 AND 5),
            definition_text TEXT NOT NULL,
            valid_from TIMESTAMP NOT NULL,
            valid_to TIMESTAMP,
            created_on TIMESTAMP NOT NULL DEFAULT NOW(),
            created_by INT NOT NULL
        );
        CREATE INDEX IF NOT EXISTS idx_imp_mat_def_tenant_id   ON %I.impact_materiality_def (tenant_id);
        CREATE INDEX IF NOT EXISTS idx_imp_mat_def_version_dim ON %I.impact_materiality_def (version_num, dimension);
    $f$, schema_name, schema_name, schema_name);

    EXECUTE format($f$
        CREATE TABLE IF NOT EXISTS %I.fin_materiality_weights (
            weight_id SERIAL PRIMARY KEY,
            tenant_id INT NOT NULL,
            version_num INT NOT NULL,
            dimension VARCHAR(50) NOT NULL,
            weight NUMERIC(5,2) NOT NULL,
            valid_from TIMESTAMP NOT NULL,
            valid_to TIMESTAMP,
            created_on TIMESTAMP NOT NULL DEFAULT NOW(),
            created_by INT NOT NULL
        );
        CREATE INDEX IF NOT EXISTS idx_fin_weights_tenant_id   ON %I.fin_materiality_weights (tenant_id);
        CREATE INDEX IF NOT EXISTS idx_fin_weights_version_dim ON %I.fin_materiality_weights (version_num, dimension);
    $f$, schema_name, schema_name, schema_name);

    EXECUTE format($f$
        CREATE TABLE IF NOT EXISTS %I.fin_materiality_magnitude_def (
            def_id SERIAL PRIMARY KEY,
            tenant_id INT NOT NULL,
            version_num INT NOT NULL,
            score_value INT NOT NULL CHECK (score_value BETWEEN 1 AND 5),
            definition_text TEXT NOT NULL,
            valid_from TIMESTAMP NOT NULL,
            valid_to TIMESTAMP,
            created_on TIMESTAMP NOT NULL DEFAULT NOW(),
            created_by INT NOT NULL
        );
        CREATE INDEX IF NOT EXISTS idx_fin_mag_def_tenant_id     ON %I.fin_materiality_magnitude_def (tenant_id);
        CREATE INDEX IF NOT EXISTS idx_fin_mag_def_version_score ON %I.fin_materiality_magnitude_def (version_num, score_value);
    $f$, schema_name, schema_name, schema_name);

END;
$$ LANGUAGE plpgsql;

-- NOTE: Removed any 'CREATE TABLE public.tenant_config' and 
-- any inserts or references that rely on public.tenant_config(tenant_id).
-- This script now only sets up tenant-side tables in each schema.
--
-- If you manually run:
--     SELECT create_tenant_schema('mytenant');
-- then the script above will create the 'tenant_mytenant' schema 
-- and all tenant-scope tables. 
--
-- Let Django run migrations to create and manage "public.tenant_config" itself.
</file>

<file path='static/js/context_manager.js'>
// static/js/context_manager.js

document.addEventListener('DOMContentLoaded', function() {
    // Function to update context display without reloading page
    function updateContextDisplay(contextData) {
        const tenantDisplay = document.getElementById('currentTenant');
        const assessmentDisplay = document.getElementById('currentAssessment');
        const iroDisplay = document.getElementById('currentIRO');
        
        if (tenantDisplay && contextData.tenant) {
            tenantDisplay.textContent = contextData.tenant.tenant_name;
            tenantDisplay.parentElement.classList.remove('text-muted');
        }
        
        if (assessmentDisplay) {
            if (contextData.assessment) {
                assessmentDisplay.textContent = contextData.assessment.name;
                assessmentDisplay.parentElement.classList.remove('text-muted');
            } else {
                assessmentDisplay.textContent = 'No assessment selected';
                assessmentDisplay.parentElement.classList.add('text-muted');
            }
        }
        
        if (iroDisplay) {
            if (contextData.iro) {
                iroDisplay.textContent = contextData.iro.title;
                iroDisplay.parentElement.classList.remove('text-muted');
                
                const iroBadge = document.getElementById('iroBadge');
                if (iroBadge) {
                    iroBadge.textContent = contextData.iro.type;
                    // Set badge color based on type
                    iroBadge.classList.remove('bg-danger', 'bg-success', 'bg-primary');
                    if (contextData.iro.type === 'Risk') {
                        iroBadge.classList.add('bg-danger');
                    } else if (contextData.iro.type === 'Opportunity') {
                        iroBadge.classList.add('bg-success');
                    } else {
                        iroBadge.classList.add('bg-primary');
                    }
                }
            } else {
                iroDisplay.textContent = 'No IRO selected';
                iroDisplay.parentElement.classList.add('text-muted');
            }
        }
    }
    
    // Handle context selection via Ajax
    const contextLinks = document.querySelectorAll('[data-context-link]');
    contextLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            
            const url = this.getAttribute('href');
            
            fetch(url, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateContextDisplay(data.context);
                    
                    // Close any open modals
                    const openModals = document.querySelectorAll('.modal.show');
                    openModals.forEach(modal => {
                        const modalInstance = bootstrap.Modal.getInstance(modal);
                        if (modalInstance) {
                            modalInstance.hide();
                        }
                    });
                    
                    // Optionally reload content sections
                    if (data.redirect_url) {
                        window.location.href = data.redirect_url;
                    }
                }
            })
            .catch(error => console.error('Error updating context:', error));
        });
    });
});
</file>

<file path='static/js/dashboard.js'>
// static/js/dashboard.js

document.addEventListener('DOMContentLoaded', function() {
    // Initialize charts based on available data attributes
    initializeCharts();
    
    // Setup event listeners for dashboard filters
    setupFilterListeners();
    
    // Initialize any tooltips
    initializeTooltips();
});

/**
 * Initialize all charts if their canvases exist
 */
function initializeCharts() {
    // Initialize the materiality matrix chart if the canvas exists
    const matrixCanvas = document.getElementById('materialityMatrix');
    if (matrixCanvas && matrixCanvas.hasAttribute('data-matrix-data')) {
        try {
            const matrixData = JSON.parse(matrixCanvas.getAttribute('data-matrix-data'));
            initializeMaterialityMatrix(matrixCanvas, matrixData);
        } catch (e) {
            console.error('Error parsing matrix data:', e);
        }
    }

    // Initialize IRO distribution chart if the canvas exists
    const distributionCanvas = document.getElementById('iroDistributionChart');
    if (distributionCanvas && distributionCanvas.hasAttribute('data-distribution')) {
        try {
            const distributionData = JSON.parse(distributionCanvas.getAttribute('data-distribution'));
            initializeIRODistributionChart(distributionCanvas, distributionData);
        } catch (e) {
            console.error('Error parsing distribution data:', e);
        }
    }

    // Initialize assessment progress chart if the canvas exists
    const progressCanvas = document.getElementById('assessmentProgressChart');
    if (progressCanvas && progressCanvas.hasAttribute('data-progress')) {
        try {
            const progressData = JSON.parse(progressCanvas.getAttribute('data-progress'));
            initializeAssessmentProgressChart(progressCanvas, progressData);
        } catch (e) {
            console.error('Error parsing progress data:', e);
        }
    }
}

/**
 * Initializes the materiality matrix visualization
 * @param {HTMLCanvasElement} canvas - The canvas element for the chart
 * @param {Array} iroData - Array of IRO data objects
 */
function initializeMaterialityMatrix(canvas, iroData) {
    // If no data provided, use empty array
    if (!iroData) iroData = [];
    
    // Create datasets for different IRO types with different colors
    const datasets = [
        {
            label: 'Risks',
            data: iroData.filter(item => item.type === 'Risk').map(item => ({
                x: item.impact_score,
                y: item.financial_score,
                r: 8, // Fixed radius for now
                id: item.id,
                title: item.title
            })),
            backgroundColor: 'rgba(239, 68, 68, 0.7)',
            borderColor: 'rgba(239, 68, 68, 1)'
        },
        {
            label: 'Opportunities',
            data: iroData.filter(item => item.type === 'Opportunity').map(item => ({
                x: item.impact_score,
                y: item.financial_score,
                r: 8, // Fixed radius for now
                id: item.id,
                title: item.title
            })),
            backgroundColor: 'rgba(34, 197, 94, 0.7)',
            borderColor: 'rgba(34, 197, 94, 1)'
        },
        {
            label: 'Impacts',
            data: iroData.filter(item => item.type === 'Impact').map(item => ({
                x: item.impact_score,
                y: item.financial_score,
                r: 8, // Fixed radius for now
                id: item.id,
                title: item.title
            })),
            backgroundColor: 'rgba(59, 130, 246, 0.7)',
            borderColor: 'rgba(59, 130, 246, 1)'
        }
    ];

    // Create the bubble chart
    const matrixChart = new Chart(canvas, {
        type: 'bubble',
        data: {
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Impact Materiality',
                        font: {
                            weight: 'bold'
                        }
                    },
                    min: 0,
                    max: 5,
                    ticks: {
                        stepSize: 1
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Financial Materiality',
                        font: {
                            weight: 'bold'
                        }
                    },
                    min: 0,
                    max: 5,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const item = context.raw;
                            return [
                                `ID: #${item.id}`,
                                `Title: ${item.title}`,
                                `Impact Materiality: ${item.x.toFixed(1)}`,
                                `Financial Materiality: ${item.y.toFixed(1)}`
                            ];
                        }
                    }
                },
                legend: {
                    position: 'bottom'
                },
                annotation: {
                    annotations: {
                        quadrantLines: {
                            type: 'line',
                            xMin: 2.5,
                            xMax: 2.5,
                            yMin: 0,
                            yMax: 5,
                            borderColor: 'rgba(0, 0, 0, 0.2)',
                            borderWidth: 1,
                            borderDash: [5, 5]
                        },
                        horizontalLine: {
                            type: 'line',
                            xMin: 0,
                            xMax: 5,
                            yMin: 2.5,
                            yMax: 2.5,
                            borderColor: 'rgba(0, 0, 0, 0.2)',
                            borderWidth: 1,
                            borderDash: [5, 5]
                        }
                    }
                }
            }
        }
    });

    // Add click event to navigate to IRO details
    canvas.onclick = function(evt) {
        const points = matrixChart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
        if (points.length) {
            const firstPoint = points[0];
            const dataset = matrixChart.data.datasets[firstPoint.datasetIndex];
            const iro = dataset.data[firstPoint.index];
            // Navigate to IRO detail page
            window.location.href = `/assessments/iro/${iro.id}/`;
        }
    };
}

/**
 * Initializes the IRO distribution chart
 * @param {HTMLCanvasElement} canvas - The canvas element for the chart
 * @param {Object} distributionData - Object containing distribution data
 */
function initializeIRODistributionChart(canvas, distributionData) {
    // If no data provided, use empty data
    if (!distributionData) {
        distributionData = {labels: [], counts: []};
    }
    
    // Create the pie chart
    const data = {
        labels: distributionData.labels || [],
        datasets: [{
            data: distributionData.counts || [],
            backgroundColor: [
                'rgba(239, 68, 68, 0.7)',
                'rgba(34, 197, 94, 0.7)',
                'rgba(59, 130, 246, 0.7)'
            ],
            borderColor: [
                'rgba(239, 68, 68, 1)',
                'rgba(34, 197, 94, 1)',
                'rgba(59, 130, 246, 1)'
            ],
            borderWidth: 1
        }]
    };

    const distributionChart = new Chart(canvas, {
        type: 'doughnut',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

/**
 * Initializes the assessment progress chart
 * @param {HTMLCanvasElement} canvas - The canvas element for the chart
 * @param {Object} progressData - Object containing progress data
 */
function initializeAssessmentProgressChart(canvas, progressData) {
    // If no data provided, use empty data
    if (!progressData) {
        progressData = {labels: [], counts: []};
    }
    
    // Create the bar chart
    const data = {
        labels: progressData.labels || [],
        datasets: [{
            label: 'Number of IROs',
            data: progressData.counts || [],
            backgroundColor: [
                'rgba(156, 163, 175, 0.7)',
                'rgba(234, 179, 8, 0.7)',
                'rgba(34, 197, 94, 0.7)',
                'rgba(249, 115, 22, 0.7)'
            ],
            borderColor: [
                'rgba(156, 163, 175, 1)',
                'rgba(234, 179, 8, 1)',
                'rgba(34, 197, 94, 1)',
                'rgba(249, 115, 22, 1)'
            ],
            borderWidth: 1
        }]
    };

    const progressChart = new Chart(canvas, {
        type: 'bar',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of IROs',
                        font: {
                            weight: 'bold'
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

/**
 * Sets up event listeners for dashboard filters
 */
function setupFilterListeners() {
    // Time period filter for materiality matrix
    const matrixDropdown = document.getElementById('matrixDropdown');
    if (matrixDropdown) {
        const dropdownItems = document.querySelectorAll('[aria-labelledby="matrixDropdown"] .dropdown-item');
        dropdownItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const selectedPeriod = this.textContent;
                matrixDropdown.textContent = selectedPeriod;
                // Here you would typically fetch new data based on the selected period
                // and update the chart
                updateMatrixData(selectedPeriod);
            });
        });
    }

    // IRO type filter
    const typeFilter = document.getElementById('iroTypeFilter');
    if (typeFilter) {
        typeFilter.addEventListener('change', function() {
            // Filter dashboard data based on selected IRO type
            filterDashboardByType(this.value);
        });
    }

    // Status filter
    const statusFilter = document.getElementById('statusFilter');
    if (statusFilter) {
        statusFilter.addEventListener('change', function() {
            // Filter dashboard data based on selected status
            filterDashboardByStatus(this.value);
        });
    }
}

/**
 * Updates the materiality matrix data based on selected time period
 * @param {string} period - The selected time period
 */
function updateMatrixData(period) {
    // This would typically involve an AJAX call to fetch new data
    console.log(`Updating matrix data for period: ${period}`);
    
    // Example of how you might update the chart with new data
    // In a real implementation, you would fetch this data from your backend
    const matrixCanvas = document.getElementById('materialityMatrix');
    if (matrixCanvas) {
        const chart = Chart.getChart(matrixCanvas);
        if (chart) {
            // Slightly modify the data points to simulate changes
            chart.data.datasets.forEach(dataset => {
                dataset.data.forEach(point => {
                    // Slightly modify the data points to simulate changes
                    point.x += (Math.random() - 0.5) * 0.5;
                    point.y += (Math.random() - 0.5) * 0.5;
                    // Ensure values stay within bounds
                    point.x = Math.max(0, Math.min(5, point.x));
                    point.y = Math.max(0, Math.min(5, point.y));
                });
            });
            chart.update();
        }
    }
}

/**
 * Filters dashboard data based on IRO type
 * @param {string} type - The selected IRO type
 */
function filterDashboardByType(type) {
    console.log(`Filtering dashboard by IRO type: ${type}`);
    
    // This would typically involve updating all relevant dashboard components
    // based on the selected filter
    
    // Example: Update high-priority IROs table
    const iroTable = document.getElementById('highPriorityIROsTable');
    if (iroTable && iroTable.tBodies[0]) {
        const rows = iroTable.tBodies[0].rows;
        for (let i = 0; i < rows.length; i++) {
            const iroType = rows[i].cells[2].querySelector('.badge')?.textContent.trim();
            if (type === 'All' || iroType === type) {
                rows[i].style.display = '';
            } else {
                rows[i].style.display = 'none';
            }
        }
    }
    
    // You would also update other dashboard components like charts
    // based on the selected filter
}

/**
 * Filters dashboard data based on status
 * @param {string} status - The selected status
 */
function filterDashboardByStatus(status) {
    console.log(`Filtering dashboard by status: ${status}`);
    
    // Similar to filterDashboardByType, but filtering based on status
    
    // Example: Update high-priority IROs table
    const iroTable = document.getElementById('highPriorityIROsTable');
    if (iroTable && iroTable.tBodies[0]) {
        const rows = iroTable.tBodies[0].rows;
        for (let i = 0; i < rows.length; i++) {
            const iroStatus = rows[i].cells[5].querySelector('.status-badge')?.textContent.trim();
            if (status === 'All' || iroStatus === status) {
                rows[i].style.display = '';
            } else {
                rows[i].style.display = 'none';
            }
        }
    }
    
    // Example: Update recent activity timeline
    const activityItems = document.querySelectorAll('[data-status]');
    activityItems.forEach(item => {
        const itemStatus = item.getAttribute('data-status');
        if (status === 'All' || itemStatus === status) {
            item.style.display = '';
        } else {
            item.style.display = 'none';
        }
    });
}

/**
 * Initializes Bootstrap tooltips
 */
function initializeTooltips() {
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
}

/**
 * Handles window resize events to ensure charts remain responsive
 */
window.addEventListener('resize', function() {
    const matrixCanvas = document.getElementById('materialityMatrix');
    if (matrixCanvas) {
        const chart = Chart.getChart(matrixCanvas);
        if (chart) {
            chart.resize();
        }
    }
    
    const distributionCanvas = document.getElementById('iroDistributionChart');
    if (distributionCanvas) {
        const chart = Chart.getChart(distributionCanvas);
        if (chart) {
            chart.resize();
        }
    }
    
    const progressCanvas = document.getElementById('assessmentProgressChart');
    if (progressCanvas) {
        const chart = Chart.getChart(progressCanvas);
        if (chart) {
            chart.resize();
        }
    }
});

/**
 * Exports the current materiality matrix as an image
 */
function exportMatrixAsImage() {
    const matrixCanvas = document.getElementById('materialityMatrix');
    if (matrixCanvas) {
        const link = document.createElement('a');
        link.download = 'materiality_matrix.png';
        link.href = matrixCanvas.toDataURL('image/png');
        link.click();
    }
}

/**
 * Initializes search functionality for IRO tables
 */
function initializeSearch() {
    const searchInput = document.getElementById('iroSearch');
    if (searchInput) {
        searchInput.addEventListener('keyup', function() {
            const searchTerm = this.value.toLowerCase();
            const table = document.getElementById('highPriorityIROsTable');
            if (table && table.tBodies[0]) {
                const rows = table.tBodies[0].rows;
                
                for (let i = 0; i < rows.length; i++) {
                    const text = rows[i].textContent.toLowerCase();
                    if (text.indexOf(searchTerm) > -1) {
                        rows[i].style.display = '';
                    } else {
                        rows[i].style.display = 'none';
                    }
                }
            }
        });
    }
}

// Initialize search when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initializeSearch();
});
</file>

<file path='static/js/handsontable-manager.js'>
// static/js/handsontable-manager.js

/**
 * Handsontable manager for initializing and managing data grids
 * with tenant context awareness
 */
class HandsontableManager {
    constructor() {
        this.instances = {};
        this.currentTenant = null;
        this.currentAssessment = null;
    }

    /**
     * Initialize a Handsontable instance
     * 
     * @param {string} containerId - The container element ID
     * @param {object} options - Handsontable configuration options
     * @param {Array} data - Initial data for the table
     * @param {object} contextData - Object with tenant and assessment info
     * @returns {object} The Handsontable instance
     */
    initTable(containerId, options, data, contextData = {}) {
        // Store context info
        this.currentTenant = contextData.tenant || null;
        this.currentAssessment = contextData.assessment || null;

        // Get the container element
        const container = document.getElementById(containerId);
        if (!container) {
            console.error(`Container with ID "${containerId}" not found`);
            return null;
        }

        // Set default options
        const defaultOptions = {
            licenseKey: 'non-commercial-and-evaluation',
            rowHeaders: true,
            colHeaders: true,
            contextMenu: true,
            stretchH: 'all',
            autoColumnSize: true,
            manualColumnResize: true,
            manualRowResize: true,
            afterChange: (changes, source) => {
                if (source === 'loadData') return;
                this.handleDataChange(containerId, changes, source);
            }
        };

        // Combine options
        const tableOptions = { ...defaultOptions, ...options, data: data || [] };

        // Create the Handsontable instance
        const hot = new Handsontable(container, tableOptions);
        
        // Store the instance
        this.instances[containerId] = hot;

        return hot;
    }

    /**
     * Load data into an existing table
     * 
     * @param {string} containerId - The container element ID
     * @param {Array} data - The data to load
     */
    loadData(containerId, data) {
        const hot = this.instances[containerId];
        if (hot) {
            hot.loadData(data);
        } else {
            console.error(`No Handsontable instance found for "${containerId}"`);
        }
    }

    /**
     * Handle data changes and save to the server
     * 
     * @param {string} containerId - The container element ID
     * @param {Array} changes - Array of changes [row, prop, oldValue, newValue]
     * @param {string} source - Source of the change
     */
    handleDataChange(containerId, changes, source) {
        if (!changes || changes.length === 0) return;

        const hot = this.instances[containerId];
        if (!hot) return;

        const tableData = hot.getData();
        const tableHeaders = hot.getColHeader();
        const contextData = {
            tenant: this.currentTenant,
            assessment: this.currentAssessment
        };

        // Prepare the changes
        const changedRows = [];
        changes.forEach(([row, prop, oldValue, newValue]) => {
            // Find column index for the property
            const colIndex = typeof prop === 'number' ? prop : tableHeaders.indexOf(prop);
            if (colIndex === -1) return;

            // Get the row data
            const rowData = tableData[row];
            if (!rowData) return;

            // Add to changed rows
            changedRows.push({
                rowIndex: row,
                data: rowData,
                changes: { [prop]: newValue }
            });
        });

        // Send changes to the server
        this.saveChanges(containerId, changedRows, contextData);
    }

    /**
     * Save changes to the server
     * 
     * @param {string} containerId - The container element ID
     * @param {Array} changedRows - Array of changed rows
     * @param {object} contextData - Tenant and assessment info
     */
    saveChanges(containerId, changedRows, contextData) {
        // Get the save URL from data attribute
        const container = document.getElementById(containerId);
        const saveUrl = container.dataset.saveUrl;
        if (!saveUrl) {
            console.error(`No save URL found for "${containerId}"`);
            return;
        }

        // Get CSRF token
        const csrftoken = this.getCookie('csrftoken');

        // Send changes to the server
        fetch(saveUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                changes: changedRows,
                contextData: contextData
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Changes saved successfully:', data);
            
            // Check if we need to reload the table
            if (data.reload) {
                this.loadData(containerId, data.data);
            }
            
            // Show success message
            this.showMessage('success', 'Changes saved successfully');
        })
        .catch(error => {
            console.error('Error saving changes:', error);
            this.showMessage('error', 'Error saving changes: ' + error.message);
        });
    }

    /**
     * Get a cookie value by name
     * 
     * @param {string} name - The cookie name
     * @returns {string} The cookie value
     */
    getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    /**
     * Show a message to the user
     * 
     * @param {string} type - Message type ('success', 'error', etc.)
     * @param {string} message - The message text
     */
    showMessage(type, message) {
        // Create message element
        const messageEl = document.createElement('div');
        messageEl.className = `alert alert-${type} position-fixed bottom-0 end-0 m-3`;
        messageEl.style.zIndex = 1050;
        messageEl.textContent = message;
        
        // Add to document
        document.body.appendChild(messageEl);
        
        // Remove after 3 seconds
        setTimeout(() => {
            messageEl.classList.add('fade');
            setTimeout(() => {
                document.body.removeChild(messageEl);
            }, 500);
        }, 3000);
    }
}

// Create global instance
window.handsonTableManager = new HandsontableManager();
</file>

<file path='static/js/logger.js'>
// static/js/logger.js

/**
 * Frontend logging utility that captures console logs and sends them to backend
 */
class FrontendLogger {
    constructor() {
        this.logQueue = [];
        this.logEndpoint = '/api/logs/frontend/';
        this.flushInterval = 5000; // Send logs every 5 seconds
        this.maxQueueSize = 100;
        this.enabled = true;
        this.levels = {
            DEBUG: 0,
            INFO: 1,
            WARNING: 2,
            ERROR: 3,
            CRITICAL: 4
        };
        this.currentLevel = this.levels.INFO;
        
        this.setup();
    }
    
    setup() {
        // Start periodic flush of logs
        this.flushIntervalId = setInterval(() => {
            this.flush();
        }, this.flushInterval);
        
        // Override console methods
        this.overrideConsole();
        
        // Set up global error handler
        this.setupErrorHandlers();
    }
    
    overrideConsole() {
        // Store original console methods
        const originalConsole = {
            log: console.log,
            info: console.info,
            warn: console.warn,
            error: console.error
        };
        
        // Override console.log
        console.log = (...args) => {
            originalConsole.log.apply(console, args);
            this.debug(args.map(arg => this.stringify(arg)).join(' '));
        };
        
        // Override console.info
        console.info = (...args) => {
            originalConsole.info.apply(console, args);
            this.info(args.map(arg => this.stringify(arg)).join(' '));
        };
        
        // Override console.warn
        console.warn = (...args) => {
            originalConsole.warn.apply(console, args);
            this.warn(args.map(arg => this.stringify(arg)).join(' '));
        };
        
        // Override console.error
        console.error = (...args) => {
            originalConsole.error.apply(console, args);
            this.error(args.map(arg => this.stringify(arg)).join(' '));
        };
    }
    
    setupErrorHandlers() {
        // Global error handler
        window.addEventListener('error', (event) => {
            this.critical(`Uncaught error: ${event.message} at ${event.filename}:${event.lineno}:${event.colno}`, {
                stack: event.error?.stack,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno
            });
            return false;
        });
        
        // Unhandled promise rejection handler
        window.addEventListener('unhandledrejection', (event) => {
            this.critical(`Unhandled promise rejection: ${this.stringify(event.reason)}`, {
                reason: this.stringify(event.reason),
                stack: event.reason?.stack
            });
        });
    }
    
    stringify(obj) {
        // Convert object to string for logging
        if (obj === null) return 'null';
        if (obj === undefined) return 'undefined';
        if (typeof obj === 'string') return obj;
        
        try {
            return JSON.stringify(obj);
        } catch (e) {
            return String(obj);
        }
    }
    
    shouldLog(level) {
        // Check if this log level should be recorded
        return this.enabled && this.levels[level] >= this.currentLevel;
    }
    
    /**
     * Add a log entry to the queue
     */
    log(level, message, context = {}) {
        if (!this.shouldLog(level)) return;
        
        // Get session/user info
        const sessionId = document.cookie
            .split('; ')
            .find(row => row.startsWith('sessionid='))
            ?.split('=')[1] || 'no-session';
        
        // Add log entry to queue
        this.logQueue.push({
            timestamp: new Date().toISOString(),
            level,
            message,
            url: window.location.href,
            userAgent: navigator.userAgent,
            sessionId,
            context
        });
        
        // Flush immediately if queue is large or this is a higher severity log
        if (this.logQueue.length >= this.maxQueueSize || 
            this.levels[level] >= this.levels.ERROR) {
            this.flush();
        }
    }
    
    /**
     * Log levels
     */
    debug(message, context = {}) {
        this.log('DEBUG', message, context);
    }
    
    info(message, context = {}) {
        this.log('INFO', message, context);
    }
    
    warn(message, context = {}) {
        this.log('WARNING', message, context);
    }
    
    error(message, context = {}) {
        this.log('ERROR', message, context);
    }
    
    critical(message, context = {}) {
        this.log('CRITICAL', message, context);
    }
    
    /**
     * Send logs to backend
     */
    flush() {
        if (!this.logQueue.length) return;
        
        // Get logs to send
        const logs = [...this.logQueue];
        this.logQueue = [];
        
        // Get CSRF token
        const csrfToken = document.querySelector('meta[name="csrftoken"]')?.getAttribute('content') ||
            document.cookie
                .split('; ')
                .find(row => row.startsWith('csrftoken='))
                ?.split('=')[1] || '';
        
        // Send logs to backend
        fetch(this.logEndpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ logs })
        }).catch(error => {
            // Failed to send logs - add them back to queue
            this.logQueue = [...logs, ...this.logQueue].slice(0, this.maxQueueSize);
        });
    }
    
    /**
     * Set the minimum log level
     */
    setLevel(level) {
        if (this.levels[level] !== undefined) {
            this.currentLevel = this.levels[level];
        }
    }
    
    /**
     * Enable or disable logging
     */
    setEnabled(enabled) {
        this.enabled = enabled;
    }
    
    /**
     * Clean up when no longer needed
     */
    destroy() {
        // Flush remaining logs
        this.flush();
        
        // Clear flush interval
        if (this.flushIntervalId) {
            clearInterval(this.flushIntervalId);
        }
    }
}

// Initialize the logger
window.logger = new FrontendLogger();
</file>

<file path='templates/assessments/assessment_form.html'>
<!-- templates/assessments/assessment_form.html -->
{% extends "base.html" %}

{% block title %}
    Assessment Form
{% endblock %}

{% block content %}
<div class="section">
    <h1>Create / Update Assessment</h1>
    <form method="POST" novalidate>
        {% csrf_token %}
        {{ form.as_p }}

        <button type="submit" class="btn btn-success">Save</button>
        <a href="{% url 'assessments:list' %}" class="btn btn-secondary">Cancel</a>
    </form>
</div>
{% endblock %}
</file>

<file path='templates/assessments/assessment_list.html'>
<!-- templates/assessments/assessment_list.html -->
{% extends "base.html" %}

{% block title %}
    Assessments List
{% endblock %}

{% block content %}
<div class="section">
    <h1>All Assessments</h1>
    <p>
        <a href="{% url 'assessments:create' %}" class="btn btn-primary">Create New Assessment</a>
    </p>

    <!-- Handsontable Container -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div id="assessment-table-container" data-save-url="{% url 'assessments:assessment-save' %}" style="height: 400px; overflow: hidden;"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get assessment data
    fetch('{% url "assessments:assessment-data" %}')
        .then(response => response.json())
        .then(data => {
            // Column definitions
            const columnDefs = [
                { data: 'id', title: 'ID', readOnly: true, width: 60 },
                { data: 'name', title: 'Name' },
                { data: 'description', title: 'Description', width: 300 },
                { data: 'created_on', title: 'Created On', readOnly: true, width: 150 },
                { data: 'updated_on', title: 'Updated On', readOnly: true, width: 150 }
            ];
            
            // Initialize Handsontable
            const contextData = {
                tenant: {{ request.context.tenant.tenant_id|default:"null" }}
            };
            
            window.handsonTableManager.initTable('assessment-table-container', {
                colHeaders: columnDefs.map(col => col.title),
                columns: columnDefs,
                filters: true,
                dropdownMenu: true,
                contextMenu: true,
                rowHeaders: true,
                licenseKey: 'non-commercial-and-evaluation'
            }, data, contextData);
        })
        .catch(error => {
            console.error('Error loading assessment data:', error);
            document.getElementById('assessment-table-container').innerHTML = 
                '<div class="alert alert-danger">Error loading assessment data. Please try refreshing the page.</div>';
        });
});
</script>
{% endblock %}
</file>

<file path='templates/assessments/iro_form.html'>
{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block title %}IRO Form | DMA Platform{% endblock %}
{% block page_title %}{% if form.instance.pk %}Edit IRO{% else %}Create New IRO{% endif %}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white py-3">
                <h5 class="card-title mb-0">
                    {% if form.instance.pk %}
                        Edit IRO #{{ form.instance.iro_id }}
                    {% else %}
                        Create New Impact, Risk, or Opportunity
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" novalidate id="iro-form"
                      hx-post="{{ request.path }}"
                      hx-trigger="submit"
                      hx-indicator="#form-indicator"
                      hx-swap="outerHTML">
                    {% csrf_token %}
                    
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <span>Complete all required fields to create a new IRO. You can edit additional details after creation.</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Basic Information Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="border-bottom pb-2 mb-3">Basic Information</h5>
                        </div>
                        
                        <div class="col-md-6">
                            {{ form.tenant|as_crispy_field }}
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="id_type">Type</label>
                                <select name="type" id="id_type" class="form-select"
                                        hx-get="{% url 'assessments:iro-type-changed' %}"
                                        hx-target="#typeSpecificFields"
                                        hx-trigger="change"
                                        hx-indicator="#type-indicator">
                                    <option value="">Select Type</option>
                                    <option value="Risk" {% if form.instance.type == 'Risk' %}selected{% endif %}>Risk</option>
                                    <option value="Opportunity" {% if form.instance.type == 'Opportunity' %}selected{% endif %}>Opportunity</option>
                                    <option value="Impact" {% if form.instance.type == 'Impact' %}selected{% endif %}>Impact</option>
                                </select>
                                <div id="type-indicator" class="htmx-indicator">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-12 mt-3">
                            <div class="form-group">
                                <label for="id_title">Title</label>
                                <input type="text" name="title" class="form-control" id="id_title"
                                       placeholder="Enter a clear, descriptive title" required
                                       hx-post="{% url 'assessments:validate-title' %}"
                                       hx-trigger="keyup changed delay:500ms"
                                       hx-target="#title-feedback"
                                       hx-indicator="#title-indicator"
                                       value="{{ form.instance.title|default:'' }}">
                                <div id="title-feedback" class="form-text text-muted">
                                    Provide a concise title that clearly identifies this IRO
                                </div>
                                <div id="title-indicator" class="htmx-indicator">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-12 mt-3">
                            <div class="form-group">
                                <label for="id_description">Description</label>
                                <textarea name="description" class="form-control" id="id_description" rows="4" 
                                          placeholder="Describe this IRO in detail"
                                          hx-post="{% url 'assessments:validate-description' %}"
                                          hx-trigger="keyup changed delay:800ms"
                                          hx-target="#description-feedback"
                                          hx-indicator="#description-indicator">{{ form.instance.description|default:'' }}</textarea>
                                <div id="description-feedback" class="form-text text-muted">
                                    Include relevant context, scope, and potential implications
                                </div>
                                <div id="description-indicator" class="htmx-indicator">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Classification Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="border-bottom pb-2 mb-3">Classification</h5>
                        </div>
                        
                        <div class="col-md-6">
                            <div id="source-of-iro-container">
                                {{ form.source_of_iro|as_crispy_field }}
                                <button type="button" class="btn btn-sm btn-outline-secondary mt-1"
                                        hx-get="{% url 'assessments:inline-edit' %}?field=source_of_iro&value={{ form.instance.source_of_iro|default:'' }}"
                                        hx-target="#source-of-iro-container"
                                        hx-swap="outerHTML">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div id="esrs-standard-container">
                                {{ form.esrs_standard|as_crispy_field }}
                                <button type="button" class="btn btn-sm btn-outline-secondary mt-1"
                                        hx-get="{% url 'assessments:inline-edit' %}?field=esrs_standard&value={{ form.instance.esrs_standard|default:'' }}"
                                        hx-target="#esrs-standard-container"
                                        hx-swap="outerHTML">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mt-3">
                            <div class="form-group">
                                <label for="id_sust_topic_level1">Sustainability Topic (Level 1)</label>
                                <select name="sust_topic_level1" class="form-select" id="id_sust_topic_level1"
                                        hx-get="{% url 'assessments:get-subtopics' %}"
                                        hx-target="#id_sust_topic_level2"
                                        hx-trigger="change">
                                    <option value="">Select a topic</option>
                                    <option value="climate" {% if iro_version.sust_topic_level1 == 'climate' %}selected{% endif %}>Climate</option>
                                    <option value="water" {% if iro_version.sust_topic_level1 == 'water' %}selected{% endif %}>Water & Marine Resources</option>
                                    <option value="biodiversity" {% if iro_version.sust_topic_level1 == 'biodiversity' %}selected{% endif %}>Biodiversity & Ecosystems</option>
                                    <option value="pollution" {% if iro_version.sust_topic_level1 == 'pollution' %}selected{% endif %}>Pollution</option>
                                    <option value="resources" {% if iro_version.sust_topic_level1 == 'resources' %}selected{% endif %}>Resources & Circular Economy</option>
                                    <option value="workforce" {% if iro_version.sust_topic_level1 == 'workforce' %}selected{% endif %}>Workforce</option>
                                    <option value="communities" {% if iro_version.sust_topic_level1 == 'communities' %}selected{% endif %}>Communities</option>
                                    <option value="consumers" {% if iro_version.sust_topic_level1 == 'consumers' %}selected{% endif %}>Consumers & End-users</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mt-3">
                            <div class="form-group">
                                <label for="id_sust_topic_level2">Sustainability Topic (Level 2)</label>
                                <select name="sust_topic_level2" class="form-select" id="id_sust_topic_level2" disabled>
                                    <option value="">Select level 1 topic first</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mt-3">
                            <div x-data="{ selected: [] }" class="form-group">
                                <label for="id_value_chain">Value Chain Position</label>
                                <select name="value_chain" class="form-select" id="id_value_chain" multiple
                                        x-model="selected">
                                    <option value="upstream">Upstream</option>
                                    <option value="operations">Own Operations</option>
                                    <option value="downstream">Downstream</option>
                                </select>
                                <div class="form-text text-muted">
                                    Hold Ctrl/Cmd to select multiple options
                                </div>
                                <div class="mt-2">
                                    <template x-for="(item, index) in selected" :key="index">
                                        <span class="badge bg-primary me-1 mb-1">
                                            <span x-text="item"></span>
                                            <button type="button" class="btn-close btn-close-white ms-1" aria-label="Remove"
                                                   @click="selected = selected.filter(i => i !== item)"></button>
                                        </span>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Type-specific fields will load here -->
                    <div id="typeSpecificFields">
                        <!-- This section will be populated via HTMX based on type selection -->
                    </div>
                    
                    <!-- Status Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="border-bottom pb-2 mb-3">Status</h5>
                        </div>
                        
                        <div class="col-md-6">
                            <div id="current-stage-container">
                                {{ form.current_stage|as_crispy_field }}
                                <button type="button" class="btn btn-sm btn-outline-secondary mt-1"
                                        hx-get="{% url 'assessments:inline-edit' %}?field=current_stage&value={{ form.instance.current_stage|default:'Draft' }}"
                                        hx-target="#current-stage-container"
                                        hx-swap="outerHTML">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            {{ form.last_assessment_date|as_crispy_field }}
                        </div>
                    </div>
                    
                    <!-- Form Actions -->
                    <div class="row">
                        <div class="col-12 d-flex justify-content-between">
                            <a href="{% url 'assessments:iro-list' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-1"></i> Cancel
                            </a>
                            <div>
                                <button type="button" class="btn btn-outline-primary me-2"
                                        hx-post="{% url 'assessments:save-draft' %}"
                                        hx-include="#iro-form"
                                        hx-target="#save-feedback"
                                        hx-swap="innerHTML">
                                    <i class="fas fa-save me-1"></i> Save as Draft
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-check-circle me-1"></i> 
                                    {% if form.instance.pk %}Update{% else %}Create{% endif %} IRO
                                </button>
                            </div>
                        </div>
                        <div id="save-feedback" class="col-12 mt-3"></div>
                        <div id="form-indicator" class="htmx-indicator text-center mt-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Saving...</span>
                            </div>
                            <p>Processing your request...</p>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Initialize Alpine.js components when DOM is loaded
    document.addEventListener('alpine:init', () => {
        // Add any Alpine.js component initialization here
    });

    // HTMX event handlers
    document.addEventListener('htmx:afterRequest', function(evt) {
        if (evt.detail.successful && evt.detail.target.id === 'save-feedback') {
            // Flash effect for the feedback message
            const feedbackEl = evt.detail.target;
            feedbackEl.classList.add('bg-success', 'text-white', 'p-3', 'rounded');
            setTimeout(() => {
                feedbackEl.classList.remove('bg-success', 'text-white', 'p-3', 'rounded');
            }, 3000);
        }
    });
    
    // For fields that need both HTML5 validation and HTMX validation
    document.addEventListener('htmx:validation:validate', function(evt) {
        const field = evt.detail.elt;
        
        // Title validation
        if (field.id === 'id_title' && !field.value.trim()) {
            evt.detail.issueMessages.push("Title is required");
            field.classList.add('is-invalid');
            return;
        }
        
        // Add more validations as needed
    });
    
    // Form validation enhancement
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('iro-form');
        
        // Handle form validation errors not caught by HTMX
        form.addEventListener('submit', function(event) {
            let isValid = true;
            const title = document.getElementById('id_title');
            
            if (!title.value.trim()) {
                isValid = false;
                title.classList.add('is-invalid');
                
                if (!title.nextElementSibling || !title.nextElementSibling.classList.contains('invalid-feedback')) {
                    const feedback = document.createElement('div');
                    feedback.classList.add('invalid-feedback');
                    feedback.textContent = 'Title is required';
                    title.parentNode.insertBefore(feedback, title.nextElementSibling);
                }
            } else {
                title.classList.remove('is-invalid');
                title.classList.add('is-valid');
            }
            
            if (!isValid) {
                event.preventDefault();
                event.stopPropagation();
            }
        });
    });
</script>
{% endblock %}
</file>

<file path='templates/assessments/iro_list.html'>
<!-- templates/assessments/iro_list.html -->
{% extends "base.html" %}

{% load assessment_filters %}

{% block title %}IROs | DMA Platform{% endblock %}
{% block page_title %}IROs{% endblock %}

{% block content %}
    <div class="mb-4">
        <a href="{% url 'assessments:iro-create' %}" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i> Create New IRO
        </a>
    </div>
    
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white py-3">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">IROs Library</h5>
                <div class="d-flex">
                    <!-- Search input -->
                    <div class="me-2">
                        <input type="text" id="searchInput" class="form-control" placeholder="Search IROs...">
                    </div>
                    
                    <!-- Type filter dropdown -->
                    <div class="dropdown me-2">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="typeFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            Filter by Type
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="typeFilterDropdown">
                            <li><a class="dropdown-item filter-option" data-filter="type" data-value="all" href="#">All Types</a></li>
                            <li><a class="dropdown-item filter-option" data-filter="type" data-value="Risk" href="#">Risk</a></li>
                            <li><a class="dropdown-item filter-option" data-filter="type" data-value="Opportunity" href="#">Opportunity</a></li>
                            <li><a class="dropdown-item filter-option" data-filter="type" data-value="Impact" href="#">Impact</a></li>
                        </ul>
                    </div>
                    
                    <!-- Status filter dropdown -->
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="statusFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            Filter by Status
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="statusFilterDropdown">
                            <li><a class="dropdown-item filter-option" data-filter="status" data-value="all" href="#">All Statuses</a></li>
                            <li><a class="dropdown-item filter-option" data-filter="status" data-value="Draft" href="#">Draft</a></li>
                            <li><a class="dropdown-item filter-option" data-filter="status" data-value="In_Review" href="#">In Review</a></li>
                            <li><a class="dropdown-item filter-option" data-filter="status" data-value="Approved" href="#">Approved</a></li>
                            <li><a class="dropdown-item filter-option" data-filter="status" data-value="Disclosed" href="#">Disclosed</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Handsontable Container -->
    <div class="card shadow-sm mb-4">
        <div class="card-body p-3">
            <div id="iro-table-container" data-save-url="{% url 'assessments:iro-save' %}" style="height: 500px; overflow: hidden;"></div>
        </div>
    </div>
    
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <p class="text-muted mb-0">Showing <span id="iro-count">{{ iros|length }}</span> items</p>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Show loading indicator
    document.getElementById('iro-table-container').innerHTML = 
        '<div class="d-flex justify-content-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
    
    // Get IRO data from the server
    fetch('{% url "assessments:iro-data" %}')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Check if data is valid
            if (!Array.isArray(data)) {
                throw new Error('Invalid data format. Expected an array.');
            }
            
            // Validate and normalize data to prevent JavaScript errors
            const validatedData = data.map(item => {
                return {
                    iro_id: item.iro_id || 0,
                    title: item.title || 'Untitled',
                    type: ['Risk', 'Opportunity', 'Impact'].includes(item.type) ? item.type : 'Risk',
                    esrs_standard: item.esrs_standard || '',
                    impact_score: parseFloat(item.impact_score || 0),
                    financial_score: parseFloat(item.financial_score || 0),
                    current_stage: ['Draft', 'In_Review', 'Approved', 'Disclosed'].includes(item.current_stage) 
                        ? item.current_stage : 'Draft',
                    last_assessment_date: item.last_assessment_date || ''
                };
            });

            // Configure columns      
            const columnDefs = [
                { data: 'iro_id', title: 'IRO ID', readOnly: true, width: 80 },
                { data: 'title', title: 'Title' },
                { 
                    data: 'type', 
                    title: 'Type',
                    type: 'dropdown',
                    source: ['Risk', 'Opportunity', 'Impact'],
                    editor: 'select'
                },
                { data: 'esrs_standard', title: 'ESRS Standard' },
                { 
                    data: 'impact_score', 
                    title: 'Impact Score', 
                    type: 'numeric',
                    numericFormat: {
                        pattern: '0.0'
                    },
                    readOnly: true,
                    className: function(row, col, prop, cellProperties, value) {
                        // Use the cell value directly instead of accessing data array
                        const score = parseFloat(value || 0);
                        if (score > 3.5) return 'bg-danger bg-opacity-25';
                        if (score > 2.5) return 'bg-warning bg-opacity-25';
                        return 'bg-success bg-opacity-25';
                    }
                },
                { 
                    data: 'financial_score', 
                    title: 'Financial Score', 
                    type: 'numeric',
                    numericFormat: {
                        pattern: '0.0'
                    },
                    readOnly: true,
                    className: function(row, col, prop, cellProperties, value) {
                        // Use the cell value directly instead of accessing data array
                        const score = parseFloat(value || 0);
                        if (score > 3.5) return 'bg-danger bg-opacity-25';
                        if (score > 2.5) return 'bg-warning bg-opacity-25';
                        return 'bg-success bg-opacity-25';
                    }
                },
                { 
                    data: 'current_stage', 
                    title: 'Status',
                    type: 'dropdown',
                    source: ['Draft', 'In_Review', 'Approved', 'Disclosed'],
                    editor: 'select'
                },
                {
                    data: 'last_assessment_date',
                    title: 'Last Assessment',
                    readOnly: true
                }
            ];
            
            // If no data available, show a message
            if (validatedData.length === 0) {
                document.getElementById('iro-table-container').innerHTML = 
                    '<div class="alert alert-info">No IRO data available for the selected context. You may need to create IROs first.</div>';
                document.getElementById('iro-count').textContent = '0';
                return;
            }
            
            // Initialize Handsontable
            const contextData = {
                tenant: {{ request.context.tenant.tenant_id|default:"null" }},
                assessment: {{ request.context.assessment.id|default:"null" }}
            };
            
            const hot = window.handsonTableManager.initTable('iro-table-container', {
                colHeaders: columnDefs.map(col => col.title),
                columns: columnDefs,
                filters: true,
                dropdownMenu: true,
                contextMenu: ['row_above', 'row_below', 'remove_row', '---------', 'undo', 'redo'],
                rowHeaders: true,
                height: 'auto',
                licenseKey: 'non-commercial-and-evaluation'
            }, validatedData, contextData);
            
            // Update row count
            document.getElementById('iro-count').textContent = validatedData.length;
            
            // Handle search
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keyup', function() {
                    const query = this.value.toLowerCase();
                    
                    if (hot) {
                        const search = hot.getPlugin('search');
                        hot.getPlugin('search').query(query);
                        hot.render();
                        
                        // Count visible rows
                        let visibleRows = 0;
                        for (let i = 0; i < hot.countRows(); i++) {
                            if (!hot.rowIndexMapper.getValueAtIndex(i)) {
                                visibleRows++;
                            }
                        }
                        document.getElementById('iro-count').textContent = visibleRows;
                    }
                });
            }
            
            // Handle filter dropdown options
            const filterOptions = document.querySelectorAll('.filter-option');
            filterOptions.forEach(option => {
                option.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const filterType = this.dataset.filter;
                    const filterValue = this.dataset.value;
                    
                    if (hot) {
                        const filters = hot.getPlugin('filters');
                        
                        // Get column index based on filter type
                        const columnIndex = filterType === 'type' ? 2 : (filterType === 'status' ? 6 : -1);
                        
                        if (columnIndex >= 0) {
                            filters.clearConditions(columnIndex);
                            
                            if (filterValue !== 'all') {
                                filters.addCondition(columnIndex, 'eq', [filterValue]);
                            }
                            
                            filters.filter();
                            
                            // Update row count
                            document.getElementById('iro-count').textContent = hot.countRows() - hot.countEmptyRows();
                        }
                    }
                });
            });
        })
        .catch(error => {
            console.error('Error loading IRO data:', error);
            document.getElementById('iro-table-container').innerHTML = 
                '<div class="alert alert-danger">' +
                '<strong>Error loading IRO data.</strong><br>' +
                'Please try refreshing the page or selecting a different context.<br>' +
                '<small>Technical details: ' + error.message + '</small>' +
                '</div>';
            document.getElementById('iro-count').textContent = '0';
        });
});
</script>
{% endblock %}
</file>

<file path='templates/assessments/partials/iro_edit_esrs.html'>
<form hx-post="{% url 'assessments:iro-update-esrs' iro.iro_id %}" 
      hx-target="this" 
      hx-swap="outerHTML">
    <select name="esrs_standard" class="form-select form-select-sm">
        <option value="" {% if not iro.esrs_standard %}selected{% endif %}>-- Select Standard --</option>
        <option value="ESRS E1" {% if iro.esrs_standard == 'ESRS E1' %}selected{% endif %}>ESRS E1 - Climate</option>
        <option value="ESRS E2" {% if iro.esrs_standard == 'ESRS E2' %}selected{% endif %}>ESRS E2 - Pollution</option>
        <option value="ESRS E3" {% if iro.esrs_standard == 'ESRS E3' %}selected{% endif %}>ESRS E3 - Water & Marine Resources</option>
        <option value="ESRS E4" {% if iro.esrs_standard == 'ESRS E4' %}selected{% endif %}>ESRS E4 - Biodiversity & Ecosystems</option>
        <option value="ESRS E5" {% if iro.esrs_standard == 'ESRS E5' %}selected{% endif %}>ESRS E5 - Resource Use & Circular Economy</option>
        <option value="ESRS S1" {% if iro.esrs_standard == 'ESRS S1' %}selected{% endif %}>ESRS S1 - Own Workforce</option>
        <option value="ESRS S2" {% if iro.esrs_standard == 'ESRS S2' %}selected{% endif %}>ESRS S2 - Workers in Value Chain</option>
        <option value="ESRS S3" {% if iro.esrs_standard == 'ESRS S3' %}selected{% endif %}>ESRS S3 - Affected Communities</option>
        <option value="ESRS S4" {% if iro.esrs_standard == 'ESRS S4' %}selected{% endif %}>ESRS S4 - Consumers & End-users</option>
        <option value="ESRS G1" {% if iro.esrs_standard == 'ESRS G1' %}selected{% endif %}>ESRS G1 - Business Conduct</option>
    </select>
    <div class="mt-1">
        <button type="submit" class="btn btn-sm btn-primary">Save</button>
        <button type="button" 
                class="btn btn-sm btn-outline-secondary"
                hx-get="{% url 'assessments:iro-cancel-edit-esrs' iro.iro_id %}"
                hx-target="closest form"
                hx-swap="outerHTML">
            Cancel
        </button>
    </div>
</form>
</file>

<file path='templates/assessments/partials/iro_edit_stage.html'>
<form hx-post="{% url 'assessments:iro-update-stage' iro.iro_id %}" 
      hx-target="this" 
      hx-swap="outerHTML">
    <select name="current_stage" class="form-select form-select-sm">
        <option value="Draft" {% if iro.current_stage == 'Draft' %}selected{% endif %}>Draft</option>
        <option value="In_Review" {% if iro.current_stage == 'In_Review' %}selected{% endif %}>In Review</option>
        <option value="Approved" {% if iro.current_stage == 'Approved' %}selected{% endif %}>Approved</option>
        <option value="Disclosed" {% if iro.current_stage == 'Disclosed' %}selected{% endif %}>Disclosed</option>
    </select>
    <div class="mt-1">
        <button type="submit" class="btn btn-sm btn-primary">Save</button>
        <button type="button" 
                class="btn btn-sm btn-outline-secondary"
                hx-get="{% url 'assessments:iro-cancel-edit-stage' iro.iro_id %}"
                hx-target="closest form"
                hx-swap="outerHTML">
            Cancel
        </button>
    </div>
</form>
</file>

<file path='templates/assessments/partials/iro_edit_title.html'>
<form hx-post="{% url 'assessments:iro-update-title' iro.iro_id %}" 
      hx-target="this" 
      hx-swap="outerHTML"
      class="fw-medium">
    <input type="text" 
           name="title" 
           value="{{ iro.title }}" 
           class="form-control form-control-sm"
           hx-get="{% url 'assessments:iro-validate-title' %}"
           hx-trigger="keyup changed delay:500ms"
           hx-target="next .invalid-feedback"
           hx-swap="innerHTML">
    <div class="invalid-feedback"></div>
    <div class="mt-1">
        <button type="submit" class="btn btn-sm btn-primary">Save</button>
        <button type="button" 
                class="btn btn-sm btn-outline-secondary"
                hx-get="{% url 'assessments:iro-cancel-edit-title' iro.iro_id %}"
                hx-target="closest form"
                hx-swap="outerHTML">
            Cancel
        </button>
    </div>
</form>
</file>

<file path='templates/assessments/partials/iro_edit_type.html'>
<form hx-post="{% url 'assessments:iro-update-type' iro.iro_id %}" 
      hx-target="this" 
      hx-swap="outerHTML">
    <select name="type" class="form-select form-select-sm" 
            hx-get="{% url 'assessments:iro-validate-type' %}"
            hx-trigger="change"
            hx-target="next .invalid-feedback"
            hx-swap="innerHTML">
        <option value="Risk" {% if iro.type == 'Risk' %}selected{% endif %}>Risk</option>
        <option value="Opportunity" {% if iro.type == 'Opportunity' %}selected{% endif %}>Opportunity</option>
        <option value="Impact" {% if iro.type == 'Impact' %}selected{% endif %}>Impact</option>
    </select>
    <div class="invalid-feedback"></div>
    <div class="mt-1">
        <button type="submit" class="btn btn-sm btn-primary">Save</button>
        <button type="button" 
                class="btn btn-sm btn-outline-secondary"
                hx-get="{% url 'assessments:iro-cancel-edit-type' iro.iro_id %}"
                hx-target="closest form"
                hx-swap="outerHTML">
            Cancel
        </button>
    </div>
</form>
</file>

<file path='templates/assessments/partials/iro_list_rows.html'>
{% for item in iros %}
<tr>
    <td>#{{ item.iro_id }}</td>
    <td>
        <div class="d-flex align-items-center">
            {% if item.type == 'Risk' %}
            <span class="badge bg-danger me-2">R</span>
            {% elif item.type == 'Opportunity' %}
            <span class="badge bg-success me-2">O</span>
            {% else %}
            <span class="badge bg-primary me-2">I</span>
            {% endif %}
            <div>
                <div class="fw-medium"
                     hx-get="{% url 'assessments:iro-edit-title' item.iro_id %}"
                     hx-trigger="dblclick"
                     hx-target="this"
                     hx-swap="outerHTML">
                    {{ item.title }}
                </div>
                <small class="text-muted">{{ item.tenant.tenant_name }}</small>
            </div>
        </div>
    </td>
    <td>
        <span hx-get="{% url 'assessments:iro-edit-type' item.iro_id %}"
              hx-trigger="dblclick"
              hx-target="this"
              hx-swap="outerHTML">
            {% if item.type == 'Risk' %}
            Risk
            {% elif item.type == 'Opportunity' %}
            Opportunity
            {% else %}
            Impact
            {% endif %}
        </span>
    </td>
    <td>
        <span hx-get="{% url 'assessments:iro-edit-esrs' item.iro_id %}"
              hx-trigger="dblclick"
              hx-target="this"
              hx-swap="outerHTML">
            {{ item.esrs_standard|default:"--" }}
        </span>
    </td>
    <td>
        {% if item.last_assessment_score %}
        <div class="d-flex align-items-center">
            <span class="me-2">{{ item.last_assessment_score }}</span>
            <div class="progress" style="width: 60px; height: 5px;">
                <div class="progress-bar {% if item.last_assessment_score > 3.5 %}bg-danger{% elif item.last_assessment_score > 2.5 %}bg-warning{% else %}bg-success{% endif %}" 
                    style="width: {{ item.last_assessment_score|floatformat:1|stringformat:'s'|slice:'0:3'|floatformat:1|mul:20 }}%">
                </div>
            </div>
        </div>
        {% else %}
        --
        {% endif %}
    </td>
    <td>
        {% if item.last_assessment_score %}
        <div class="d-flex align-items-center">
            <span class="me-2">{{ item.last_assessment_score|add:"-0.2"|floatformat:1 }}</span>
            <div class="progress" style="width: 60px; height: 5px;">
                <div class="progress-bar {% if item.last_assessment_score > 3.5 %}bg-danger{% elif item.last_assessment_score > 2.5 %}bg-warning{% else %}bg-success{% endif %}" 
                    style="width: {{ item.last_assessment_score|add:'-0.2'|floatformat:1|stringformat:'s'|slice:'0:3'|floatformat:1|mul:20 }}%">
                </div>
            </div>
        </div>
        {% else %}
        --
        {% endif %}
    </td>
    <td>
        <span hx-get="{% url 'assessments:iro-edit-stage' item.iro_id %}"
              hx-trigger="dblclick"
              hx-target="this"
              hx-swap="outerHTML">
            {% if item.current_stage == 'Draft' %}
            Draft
            {% elif item.current_stage == 'In_Review' %}
            In Review
            {% elif item.current_stage == 'Approved' %}
            Approved
            {% else %}
            Disclosed
            {% endif %}
        </span>
    </td>
    <td>
        <div class="dropdown">
            <button class="btn btn-sm btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                Actions
            </button>
            <ul class="dropdown-menu">
                <li>
                    <a class="dropdown-item" href="{% url 'assessments:iro-edit' item.iro_id %}">
                        <i class="fas fa-edit me-1"></i> Edit
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" href="#">
                        <i class="fas fa-clipboard-check me-1"></i> Assess
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" href="#">
                        <i class="fas fa-eye me-1"></i> View Details
                    </a>
                </li>
                <li>
                    <hr class="dropdown-divider">
                </li>
                <li>
                    <a class="dropdown-item text-danger" 
                       hx-delete="{% url 'assessments:iro-delete' item.iro_id %}"
                       hx-confirm="Are you sure you want to delete this IRO?"
                       hx-target="closest tr"
                       hx-swap="outerHTML swap:1s">
                        <i class="fas fa-trash-alt me-1"></i> Delete
                    </a>
                </li>
            </ul>
        </div>
    </td>
</tr>
{% empty %}
<tr>
    <td colspan="8" class="text-center py-5">
        <div class="py-5">
            <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
            <h5>No IROs found</h5>
            <p class="text-muted">Create your first IRO to begin the assessment process.</p>
            <a href="{% url 'assessments:iro-create' %}" class="btn btn-primary mt-2">
                <i class="fas fa-plus me-1"></i> Create New IRO
            </a>
        </div>
    </td>
</tr>
{% endfor %}
</file>

<file path='templates/base.html'>
<!-- templates/base.html - Add in the head section -->


{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Double Materiality Assessment Platform{% endblock %}</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Handsontable CSS -->
    <link href="https://cdn.jsdelivr.net/npm/handsontable@12.3.1/dist/handsontable.full.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1e40af;
            --secondary-color: #14b8a6;
            --accent-color: #f97316;
            --success-color: #22c55e;
            --warning-color: #eab308;
            --danger-color: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--gray-50);
            color: var(--gray-800);
        }
        
        /* Modern card styling */
        .card {
            border-radius: 10px;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        
        /* Modern button styling */
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
            border-color: var(--primary-dark);
        }
        
        .btn-success {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }
        
        /* Navbar styling */
        .navbar {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        /* Table styling */
        .table {
            border-radius: 8px;
            overflow: hidden;
        }
        
        /* Dashboard metrics */
        .metric-card {
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
        }
        
        .metric-label {
            color: var(--gray-600);
            font-size: 0.9rem;
        }
        
        /* Status badges */
        .status-badge {
            padding: 0.35em 0.65em;
            border-radius: 50rem;
            font-weight: 500;
            font-size: 0.75em;
        }
        
        .status-draft {
            background-color: var(--gray-200);
            color: var(--gray-700);
        }
        
        .status-review {
            background-color: var(--warning-color);
            color: white;
        }
        
        .status-approved {
            background-color: var(--success-color);
            color: white;
        }
        
        .status-disclosed {
            background-color: var(--accent-color);
            color: white;
        }
    </style>
    {% block extra_css %}{% endblock %}
<!-- Add this before the end of the head section -->
<script src="{% static 'js/logger.js' %}"></script>
</head>
<body>
    <!-- Modern sidebar navigation -->
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 d-md-block bg-white sidebar collapse" style="min-height: 100vh; box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);">
                <div class="position-sticky pt-3">
                    <div class="px-3 py-4 mb-3">
                        <h2 class="h5 mb-0">DMA Platform</h2>
                        <p class="text-muted small">Double Materiality Assessment</p>
                    </div>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link {% if request.path == '/' %}active{% endif %}" href="{% url 'home' %}">
                                <i class="fas fa-home me-2"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if '/iro/' in request.path %}active{% endif %}" href="{% url 'assessments:iro-list' %}">
                                <i class="fas fa-chart-line me-2"></i> IROs
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if '/assessments/' in request.path and not '/iro/' in request.path %}active{% endif %}" href="{% url 'assessments:list' %}">
                                <i class="fas fa-clipboard-check me-2"></i> Assessments
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="fas fa-file-alt me-2"></i> Reports
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="fas fa-users me-2"></i> Stakeholders
                            </a>
                        </li>
                        {% if user.is_staff %}
                        <li class="nav-item mt-3">
                            <span class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                                <span>Administration</span>
                            </span>
                            <a class="nav-link" href="{% url 'admin:index' %}">
                                <i class="fas fa-cog me-2"></i> Admin Panel
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
            
            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
                <!-- templates/base.html - add after the header section -->

                <!-- Header with user info -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">{% block page_title %}Dashboard{% endblock %}</h1>
                    <div class="dropdown">
                        <button class="btn btn-light dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user-circle me-1"></i> User Name
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li><a class="dropdown-item" href="#"><i class="fas fa-user me-2"></i> Profile</a></li>
                            <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i> Settings</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#"><i class="fas fa-sign-out-alt me-2"></i> Logout</a></li>
                        </ul>
                    </div>
                </div>

                <!-- Context Selector -->
                {% include 'components/context_selector.html' %}

                <!-- Content container -->
                <div class="container-fluid">
                    {% block content %}{% endblock %}
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- HTMX for dynamic interactions -->
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>
    <!-- Alpine.js for interactive components -->
    <script defer src="https://unpkg.com/alpinejs@3.10.5/dist/cdn.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Handsontable JS -->
    <script src="https://cdn.jsdelivr.net/npm/handsontable@12.3.1/dist/handsontable.full.min.js"></script>
    <!-- HTMX for dynamic interactions -->
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>
    <!-- Alpine.js for interactive components -->
    <script defer src="https://unpkg.com/alpinejs@3.10.5/dist/cdn.min.js"></script>
    <script src="{% static 'js/handsontable-manager.js' %}"></script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>

</file>

<file path='templates/components/context_selector.html'>
<!-- templates/components/context_selector.html -->
<div class="context-selector border rounded p-3 mb-4 bg-light">
    <h5 class="mb-3">Current Context</h5>
    
    <div class="row">
        <!-- Tenant Context -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Tenant</h6>
                </div>
                <div class="card-body">
                    {% if request.context.tenant %}
                        <p class="mb-1 fw-bold">{{ request.context.tenant.tenant_name }}</p>
                    {% else %}
                        <p class="text-muted mb-1">No tenant selected</p>
                    {% endif %}
                    
                    <!-- 
                         Removed the check for request.user.is_staff 
                         to let all authenticated users see the button
                    -->
                    <div class="mt-2">
                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                data-bs-toggle="modal" data-bs-target="#tenantSelectorModal">
                            Change
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Assessment Context -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Assessment</h6>
                </div>
                <div class="card-body">
                    {% if request.context.assessment %}
                        <p class="mb-1 fw-bold">{{ request.context.assessment.name }}</p>
                        <p class="small text-muted">{{ request.context.assessment.description|truncatechars:50 }}</p>
                    {% else %}
                        <p class="text-muted mb-1">No assessment selected</p>
                    {% endif %}
                    
                    <div class="mt-2">
                        <button type="button" class="btn btn-sm btn-outline-primary"
                                data-bs-toggle="modal" data-bs-target="#assessmentSelectorModal">
                            {% if request.context.assessment %}Change{% else %}Select{% endif %}
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- IRO Context -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">IRO</h6>
                </div>
                <div class="card-body">
                    {% if request.context.iro %}
                        <p class="mb-1 fw-bold">{{ request.context.iro.title }}</p>
                        <div class="badge bg-{% if request.context.iro.type == 'Risk' %}danger{% elif request.context.iro.type == 'Opportunity' %}success{% else %}primary{% endif %}">
                            {{ request.context.iro.type }}
                        </div>
                    {% else %}
                        <p class="text-muted mb-1">No IRO selected</p>
                    {% endif %}
                    
                    <div class="mt-2">
                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                {% if not request.context.assessment %}disabled{% endif %}
                                data-bs-toggle="modal" data-bs-target="#iroSelectorModal">
                            {% if request.context.iro %}Change{% else %}Select{% endif %}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tenant Selector Modal -->
<div class="modal fade" id="tenantSelectorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Tenant</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="list-group">
                    {% for tenant in available_tenants %}
                    <a href="{% url 'set_context' %}?tenant_id={{ tenant.tenant_id }}&next={{ request.path }}" 
                       class="list-group-item list-group-item-action {% if request.context.tenant == tenant %}active{% endif %}">
                        {{ tenant.tenant_name }}
                    </a>
                    {% empty %}
                    <div class="alert alert-info">No tenants available.</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Assessment Selector Modal -->
<div class="modal fade" id="assessmentSelectorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Assessment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="list-group">
                    {% for assessment in available_assessments %}
                    <a href="{% url 'set_context' %}?assessment_id={{ assessment.id }}&next={{ request.path }}" 
                       class="list-group-item list-group-item-action {% if request.context.assessment == assessment %}active{% endif %}">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">{{ assessment.name }}</h6>
                            <small>{{ assessment.created_on|date }}</small>
                        </div>
                        <p class="mb-1 small">{{ assessment.description|truncatechars:100 }}</p>
                    </a>
                    {% empty %}
                    <div class="alert alert-info">No assessments available.</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- IRO Selector Modal -->
<div class="modal fade" id="iroSelectorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select IRO</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% if request.context.assessment %}
                <div class="list-group">
                    {% for iro in available_iros %}
                    <a href="{% url 'set_context' %}?iro_id={{ iro.iro_id }}&next={{ request.path }}" 
                       class="list-group-item list-group-item-action {% if request.context.iro == iro %}active{% endif %}">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">{{ iro.title }}</h6>
                            <span class="badge bg-{% if iro.type == 'Risk' %}danger{% elif iro.type == 'Opportunity' %}success{% else %}primary{% endif %}">
                                {{ iro.type }}
                            </span>
                        </div>
                        <p class="mb-1 small">{{ iro.description|truncatechars:100 }}</p>
                    </a>
                    {% empty %}
                    <div class="alert alert-info">No IROs available for this assessment.</div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="alert alert-warning">Please select an assessment first.</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
</file>

<file path='templates/home.html'>
<!-- templates/home.html -->
{% extends "base.html" %}
{% load assessment_filters %}

{% block title %}Dashboard | DMA Platform{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block content %}
<div class="row mb-4">
    <!-- Key metrics cards -->
    <div class="col-md-3">
        <div class="card metric-card bg-white">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="metric-value">{{ total_iros }}</div>
                    <div class="metric-label">Total IROs</div>
                </div>
                <div class="icon-shape rounded-circle bg-primary bg-opacity-10 p-2">
                    <i class="fas fa-chart-line text-primary fs-4"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card bg-white">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="metric-value">{{ high_materiality_count }}</div>
                    <div class="metric-label">High Materiality</div>
                </div>
                <div class="icon-shape rounded-circle bg-danger bg-opacity-10 p-2">
                    <i class="fas fa-exclamation-triangle text-danger fs-4"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card bg-white">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="metric-value">{{ pending_reviews_count }}</div>
                    <div class="metric-label">Pending Reviews</div>
                </div>
                <div class="icon-shape rounded-circle bg-warning bg-opacity-10 p-2">
                    <i class="fas fa-hourglass-half text-warning fs-4"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card bg-white">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="metric-value">{{ completed_assessments_count }}</div>
                    <div class="metric-label">Completed Assessments</div>
                </div>
                <div class="icon-shape rounded-circle bg-success bg-opacity-10 p-2">
                    <i class="fas fa-check-circle text-success fs-4"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <!-- Materiality matrix visualization -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Materiality Matrix</h5>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="matrixDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            Last 12 Months
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="matrixDropdown">
                            <li><a class="dropdown-item" href="#">Last 6 Months</a></li>
                            <li><a class="dropdown-item" href="#">Last 3 Months</a></li>
                            <li><a class="dropdown-item" href="#">Custom Range</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <canvas id="materialityMatrix" style="height: 300px;" data-matrix-data="{{ materiality_matrix_data }}"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Recent activity timeline -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0">Recent Activity</h5>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush">
                    {% for activity in recent_activities %}
                    <div class="list-group-item border-0 py-3" data-status="{{ activity.action }}">
                        <div class="d-flex align-items-center">
                            <div class="bg-{{ activity.icon_color }} rounded-circle p-2 me-3">
                                <i class="fas fa-{{ activity.icon }} text-white small"></i>
                            </div>
                            <div>
                                <p class="mb-0 fw-medium">{{ activity.description }}</p>
                                <p class="text-muted small mb-0">{{ activity.timestamp|timesince }} ago</p>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="list-group-item border-0 py-3">
                        <p class="text-center text-muted my-3">No recent activity</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- High Priority IROs section using Handsontable -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">High Priority IROs</h5>
                    <a href="{% url 'assessments:iro-list' %}" class="btn btn-sm btn-outline-primary">View All IROs</a>
                </div>
            </div>
            <div class="card-body p-3">
                <div id="high-priority-iros-container" data-save-url="{% url 'assessments:iro-save' %}" style="height: 300px; overflow: hidden;"></div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get high priority IROs data from a JSON string
    const highPriorityIROsData = {{ high_priority_iros_json|safe }};
    
    // Define column configurations
    const columnDefs = [
        { data: 'iro_id', title: 'IRO ID', readOnly: true, width: 80 },
        { data: 'title', title: 'Title', readOnly: true, width: 200 },
        { 
            data: 'type', 
            title: 'Type',
            readOnly: true,
            width: 100,
            renderer: function(instance, td, row, col, prop, value, cellProperties) {
                Handsontable.renderers.TextRenderer.apply(this, arguments);
                
                // Add badge styling based on type
                if (value) {
                    let badgeClass = 'primary';
                    if (value === 'Risk') badgeClass = 'danger';
                    else if (value === 'Opportunity') badgeClass = 'success';
                    
                    td.innerHTML = `<span class="badge bg-${badgeClass}">${value}</span>`;
                }
                
                return td;
            }
        },
        { 
            data: 'impact_score', 
            title: 'Impact Score', 
            type: 'numeric',
            numericFormat: {
                pattern: '0.0'
            },
            readOnly: true,
            width: 120,
            renderer: function(instance, td, row, col, prop, value, cellProperties) {
                Handsontable.renderers.NumericRenderer.apply(this, arguments);
                
                // Add progress bar styling
                if (value) {
                    let barClass = 'success';
                    if (value > 3.5) barClass = 'danger';
                    else if (value > 2.5) barClass = 'warning';
                    
                    const percentage = value * 20; // Scale to percentage (0-5 scale * 20 = 0-100%)
                    
                    td.innerHTML = `
                        <div class="d-flex align-items-center">
                            <span class="me-2">${parseFloat(value).toFixed(1)}</span>
                            <div class="progress" style="width: 60px; height: 5px;">
                                <div class="progress-bar bg-${barClass}" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                }
                
                return td;
            }
        },
        { 
            data: 'financial_score', 
            title: 'Financial Score', 
            type: 'numeric',
            numericFormat: {
                pattern: '0.0'
            },
            readOnly: true,
            width: 120,
            renderer: function(instance, td, row, col, prop, value, cellProperties) {
                Handsontable.renderers.NumericRenderer.apply(this, arguments);
                
                // Add progress bar styling
                if (value) {
                    let barClass = 'success';
                    if (value > 3.5) barClass = 'danger';
                    else if (value > 2.5) barClass = 'warning';
                    
                    const percentage = value * 20; // Scale to percentage (0-5 scale * 20 = 0-100%)
                    
                    td.innerHTML = `
                        <div class="d-flex align-items-center">
                            <span class="me-2">${parseFloat(value).toFixed(1)}</span>
                            <div class="progress" style="width: 60px; height: 5px;">
                                <div class="progress-bar bg-${barClass}" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                }
                
                return td;
            }
        },
        { 
            data: 'current_stage', 
            title: 'Status',
            readOnly: true,
            width: 100,
            renderer: function(instance, td, row, col, prop, value, cellProperties) {
                Handsontable.renderers.TextRenderer.apply(this, arguments);
                
                // Add status badge styling
                if (value) {
                    let badgeClass = value.toLowerCase();
                    if (badgeClass === 'draft') badgeClass = 'status-draft';
                    else if (badgeClass === 'in_review') badgeClass = 'status-review';
                    else if (badgeClass === 'approved') badgeClass = 'status-approved';
                    else if (badgeClass === 'disclosed') badgeClass = 'status-disclosed';
                    
                    const displayValue = value.replace('_', ' ');
                    
                    td.innerHTML = `<span class="status-badge ${badgeClass}">${displayValue}</span>`;
                }
                
                return td;
            }
        },
        {
            title: 'Actions',
            data: 'iro_id',
            readOnly: true,
            width: 100,
            renderer: function(instance, td, row, col, prop, value, cellProperties) {
                // Create edit button
                const iroId = value;
                td.className = 'htCenter htMiddle';
                td.innerHTML = `
                    <a href="/assessments/iro/${iroId}/edit/" class="btn btn-sm btn-primary">
                        <i class="fas fa-edit"></i> Edit
                    </a>
                `;
                
                return td;
            }
        }
    ];
    
    // Initialize Handsontable
    const contextData = {
        tenant: {{ request.context.tenant.tenant_id|default:"null" }},
        assessment: {{ request.context.assessment.id|default:"null" }}
    };
    
    // Check if we have the container element
    const container = document.getElementById('high-priority-iros-container');
    if (container) {
        const hot = window.handsonTableManager.initTable('high-priority-iros-container', {
            colHeaders: columnDefs.map(col => col.title),
            columns: columnDefs,
            licenseKey: 'non-commercial-and-evaluation',
            height: 'auto',
            manualRowResize: true,
            manualColumnResize: true,
            stretchH: 'all',
            autoColumnSize: true,
            rowHeights: 50, // Slightly larger rows to accommodate the action buttons
            readOnly: true, // Make the entire table read-only
            outsideClickDeselects: false,
            selectable: true,
            contextMenu: false // Disable context menu for the dashboard view
        }, highPriorityIROsData, contextData);
        
        // Add click handler for the entire row
        hot.addHook('afterOnCellMouseDown', function(event, coords, TD) {
            // Don't process clicks on the Actions column
            if (coords.col === 6) return;
            
            // Navigate to IRO details page
            const iroId = this.getDataAtRowProp(coords.row, 'iro_id');
            if (iroId) {
                window.location.href = `/assessments/iro/${iroId}/edit/`;
            }
        });
    }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Initialize materiality matrix using data from database
    const matrixCtx = document.getElementById('materialityMatrix');
    const matrixData = JSON.parse(matrixCtx.getAttribute('data-matrix-data') || '[]');
    
    if (matrixData.length > 0) {
        initializeMatrixChart(matrixCtx, matrixData);
    } else {
        matrixCtx.innerHTML = 'No data available for materiality matrix';
    }
});

function initializeMatrixChart(canvas, data) {
    // Process data into datasets grouped by type
    const riskData = data.filter(item => item.type === 'Risk').map(d => ({
        x: d.impact_score,
        y: d.financial_score,
        id: d.id,
        title: d.title
    }));
    
    const opportunityData = data.filter(item => item.type === 'Opportunity').map(d => ({
        x: d.impact_score,
        y: d.financial_score,
        id: d.id,
        title: d.title
    }));
    
    const impactData = data.filter(item => item.type === 'Impact').map(d => ({
        x: d.impact_score,
        y: d.financial_score,
        id: d.id,
        title: d.title
    }));
    
    const matrixChart = new Chart(canvas.getContext('2d'), {
        type: 'scatter',
        data: {
            datasets: [
                {
                    label: 'Risks',
                    data: riskData,
                    backgroundColor: 'rgba(239, 68, 68, 0.7)',
                    borderColor: 'rgba(239, 68, 68, 1)',
                    borderWidth: 1,
                    pointRadius: 8,
                    pointHoverRadius: 10
                }, 
                {
                    label: 'Opportunities',
                    data: opportunityData,
                    backgroundColor: 'rgba(34, 197, 94, 0.7)',
                    borderColor: 'rgba(34, 197, 94, 1)',
                    borderWidth: 1,
                    pointRadius: 8,
                    pointHoverRadius: 10
                },
                {
                    label: 'Impacts',
                    data: impactData,
                    backgroundColor: 'rgba(59, 130, 246, 0.7)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 1,
                    pointRadius: 8,
                    pointHoverRadius: 10
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Impact Materiality'
                    },
                    min: 0,
                    max: 5,
                    grid: {
                        display: true,
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Financial Materiality'
                    },
                    min: 0,
                    max: 5,
                    grid: {
                        display: true,
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const point = context.raw;
                            return `${point.title} (ID: ${point.id})
Impact: ${point.x.toFixed(1)}, Financial: ${point.y.toFixed(1)}`;
                        }
                    }
                }
            }
        }
    });
}
</script>
{% endblock %}
</file>

<file path='tenants/admin.py'>
# tenants/admin.py

from django.contrib import admin
from .models import TenantConfig, TenantDomain

@admin.register(TenantConfig)
class TenantConfigAdmin(admin.ModelAdmin):
    list_display = ('tenant_id', 'tenant_name', 'schema_name', 'created_on')
    search_fields = ('tenant_name', 'schema_name')
    list_filter = ('created_on',)

@admin.register(TenantDomain)
class TenantDomainAdmin(admin.ModelAdmin):
    list_display = ('id', 'domain', 'tenant', 'is_primary')
    list_filter = ('is_primary',)
    search_fields = ('domain',)
</file>

<file path='tenants/api/serializers.py'>
# tenants/api/serializers.py
from rest_framework import serializers
from tenants.models import TenantConfig

class TenantConfigSerializer(serializers.ModelSerializer):
    class Meta:
        model = TenantConfig
        fields = ['tenant_id', 'tenant_name', 'schema_name', 'created_on']
</file>

<file path='tenants/api/urls.py'>
# tenants/api/urls.py
from rest_framework.routers import DefaultRouter
from .views import TenantConfigViewSet

router = DefaultRouter()
router.register(r'tenant-configs', TenantConfigViewSet, basename='tenant-config')

urlpatterns = router.urls
</file>

<file path='tenants/api/views.py'>
# tenants/api/views.py
from rest_framework import viewsets, permissions
from tenants.models import TenantConfig
from .serializers import TenantConfigSerializer

class TenantConfigViewSet(viewsets.ModelViewSet):
    serializer_class = TenantConfigSerializer
    permission_classes = [permissions.IsAuthenticated]
    
    def get_queryset(self):
        # If user is staff, allow access to all tenants
        if self.request.user.is_staff:
            return TenantConfig.objects.all()
        
        # For non-staff users, use the current tenant from context
        # This assumes context middleware is being used
        tenant = getattr(self.request, 'context', {}).get('tenant')
        if tenant:
            return TenantConfig.objects.filter(tenant_id=tenant.tenant_id)
        
        # Fallback: return an empty queryset
        return TenantConfig.objects.none()
</file>

<file path='tenants/apps.py'>
# tenants/apps.py

from django.apps import AppConfig

class TenantsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'tenants'
    verbose_name = "Tenants"
</file>

<file path='tenants/management/commands/__init__.py'>

</file>

<file path='tenants/management/commands/init_sample_data.py'>
from django.core.management.base import BaseCommand
from django.db import transaction, connection
from django.utils import timezone
from tenants.models import TenantConfig, TenantDomain
from apps.assessments.models import Assessment, IRO, ImpactAssessment, RiskOppAssessment, IROVersion
from django_tenants.utils import schema_context

class Command(BaseCommand):
    """
    Creates two tenants (if they do not already exist),
    assessments for each tenant, and IROs with appropriate assessments based on type.
    """
    help = 'Prepopulate the database with 2 tenants, assessments, and IROs that are fully assessed.'

    def handle(self, *args, **options):
        # 1) Ensure or create 2 tenants:
        #    - tenant1 with domain tenant1.localhost
        #    - tenant2 with domain tenant2.localhost
        tenant_data = [
            {
                "tenant_name": "tenant1",
                "schema_name": "tenant_tenant1",
                "domain": "tenant1.localhost"
            },
            {
                "tenant_name": "tenant2",
                "schema_name": "tenant_tenant2",
                "domain": "tenant2.localhost"
            }
        ]

        for item in tenant_data:
            tenant = TenantConfig.objects.filter(tenant_name=item["tenant_name"]).first()
            if tenant:
                self.stdout.write(
                    self.style.WARNING(
                        f'Tenant "{item["tenant_name"]}" already exists. Using the existing tenant.'
                    )
                )
            else:
                tenant = TenantConfig(
                    tenant_name=item["tenant_name"],
                    schema_name=item["schema_name"]
                )
                tenant.save()
                # Create a corresponding domain
                TenantDomain.objects.create(
                    domain=item["domain"],
                    tenant=tenant,
                    is_primary=True
                )
                self.stdout.write(
                    self.style.SUCCESS(
                        f'Created tenant "{item["tenant_name"]}" with domain "{item["domain"]}".'
                    )
                )
            
            # 2) For each tenant, create assessments
            assessments = self.create_assessments(tenant)
            
            # 3) For each tenant and each assessment, create unique IROs
            for assessment in assessments:
                self.create_iros_for_assessment(tenant, assessment)

    @transaction.atomic
    def create_assessments(self, tenant):
        # Log the current schema that Django is using
        current_schema = connection.schema_name
        self.stdout.write(self.style.NOTICE(f"Current schema before assessment creation: {current_schema}"))

        created_assessments = []
        # Important: Switch to the tenant's schema before querying or creating tenant models.
        with schema_context(tenant.schema_name):
            # Create assessments (first time and refresh)
            assessments = [
                {
                    "name": "First Time Assessment",
                    "description": "Initial assessment of IROs"
                },
                {
                    "name": "Annual Refresh",
                    "description": "Annual refresh of existing IROs"
                }
            ]
            
            for assessment_data in assessments:
                # Check if assessment already exists
                assessment = Assessment.objects.filter(
                    name=assessment_data["name"], 
                    tenant=tenant
                ).first()
                
                if assessment:
                    self.stdout.write(
                        self.style.WARNING(
                            f'Assessment "{assessment_data["name"]}" already exists for tenant {tenant.tenant_name}. Using the existing assessment.'
                        )
                    )
                else:
                    # Create a new assessment
                    assessment = Assessment.objects.create(
                        tenant=tenant,
                        name=assessment_data["name"],
                        description=assessment_data["description"]
                    )
                    self.stdout.write(
                        self.style.SUCCESS(
                            f'Created assessment "{assessment_data["name"]}" for tenant {tenant.tenant_name}.'
                        )
                    )
                created_assessments.append(assessment)
        
        return created_assessments

    @transaction.atomic
    def create_iros_for_assessment(self, tenant, assessment):
        # Log the current schema that Django is using
        current_schema = connection.schema_name
        self.stdout.write(self.style.NOTICE(f"Current schema before IRO creation for assessment {assessment.name}: {current_schema}"))

        # Important: Switch to the tenant's schema before querying or creating tenant models.
        with schema_context(tenant.schema_name):
            # Generate a title prefix for this tenant and assessment
            assessment_name_for_title = assessment.name.replace(" ", "_")
            title_prefix = f"{tenant.tenant_name}_{assessment_name_for_title}_"
            
            # Count IROs with titles starting with our prefix (via their current version)
            existing_count = IROVersion.objects.filter(
                title__startswith=title_prefix
            ).count()
            
            self.stdout.write(self.style.NOTICE(
                f"Found {existing_count} existing IROs with titles starting with '{title_prefix}'"
            ))
            
            if existing_count >= 5:
                self.stdout.write(
                    self.style.WARNING(
                        f'Already found {existing_count} IRO(s) for assessment "{assessment.name}" in tenant "{tenant.tenant_name}". Skipping creation.'
                    )
                )
                return

            # Sample sets of data for demonstration.  
            iro_data = [
                {"type": "Risk", "description": "Risk related to climate transition requirements"},
                {"type": "Opportunity", "description": "Opportunity for new sustainable products"},
                {"type": "Impact", "description": "Impact from carbon emissions"},
                {"type": "Risk", "description": "Risk from increasing water scarcity"},
                {"type": "Opportunity", "description": "Energy efficiency improvements"}
            ]
            
            for idx, data in enumerate(iro_data):
                # Check schema again before each IRO creation to ensure it's consistent
                current_schema = connection.schema_name
                self.stdout.write(self.style.NOTICE(
                    f"Current schema before creating IRO #{idx+1} for assessment {assessment.name}: {current_schema}"
                ))
                
                # Create the IRO
                iro_obj = IRO.objects.create(
                    tenant=tenant,
                    type=data["type"],
                    current_stage='Approved',
                    source_of_iro='Scripted Demo',
                    esrs_standard='ESRS E1',
                    assessment_count=1,
                    last_assessment_score=3.5 + (idx * 0.3),  # Just an example
                )
                
                # Format the title according to the pattern [tenant]_[assessment]_[iro id]
                formatted_title = f"{tenant.tenant_name}_{assessment_name_for_title}_{iro_obj.iro_id}"
                
                # Create an IRO version for this IRO
                iro_version = IROVersion.objects.create(
                    iro=iro_obj,
                    tenant=tenant,
                    version_number=1,
                    title=formatted_title,
                    description=data["description"],
                    status='Approved',
                    created_by=1,  # Default user ID
                )
                
                # Update the IRO with its current version
                iro_obj.current_version_id = iro_version.version_id
                iro_obj.save()
                
                self.stdout.write(self.style.NOTICE(
                    f"Created IRO with ID: {iro_obj.iro_id}, title: {formatted_title}, type: {data['type']} in schema: {current_schema}"
                ))
                
                # Create the appropriate assessment based on IRO type
                if data["type"] == "Impact":
                    # Create ImpactAssessment only for Impact type
                    impact_assessment = ImpactAssessment.objects.create(
                        iro=iro_obj,
                        tenant=tenant,
                        time_horizon='Short-term',
                        actual_or_potential='Actual',
                        scale_score=4,
                        scope_score=3,
                        irremediability_score=3,
                        likelihood_score=4,
                        severity_score=3.8,
                        impact_materiality_score=3.8,
                        overall_rationale=f'Impact rationale for {formatted_title}',
                    )
                    
                    self.stdout.write(self.style.NOTICE(
                        f"Created ImpactAssessment with ID: {impact_assessment.impact_assessment_id} for Impact type IRO"
                    ))
                elif data["type"] in ["Risk", "Opportunity"]:
                    # Create RiskOppAssessment only for Risk or Opportunity types
                    risk_assessment = RiskOppAssessment.objects.create(
                        iro=iro_obj,
                        tenant=tenant,
                        time_horizon='Short-term',
                        workforce_risk=3,
                        operational_risk=4,
                        reputational_risk=3,
                        likelihood_score=3,
                        financial_magnitude_score=2.5,
                        financial_materiality_score=2.9,
                        overall_rationale=f'Financial rationale for {formatted_title}',
                    )
                    
                    self.stdout.write(self.style.NOTICE(
                        f"Created RiskOppAssessment with ID: {risk_assessment.risk_opp_assessment_id} for {data['type']} type IRO"
                    ))
                
                self.stdout.write(
                    self.style.SUCCESS(
                        f'Created IRO #{iro_obj.iro_id} ({formatted_title}) of type {data["type"]} for assessment "{assessment.name}" and tenant: {tenant.tenant_name}'
                    )
                )
</file>

<file path='tenants/management/commands/init_tenant.py'>
from django.core.management.base import BaseCommand
from tenants.models import TenantConfig, TenantDomain

class Command(BaseCommand):
    help = 'Initialize a new tenant (create if not exists); also ensures a matching domain.'

    def add_arguments(self, parser):
        parser.add_argument('--name', type=str, required=True, help='Name of the tenant (unique).')
        parser.add_argument('--domain', type=str, required=True, help='Domain name to map to this tenant (unique).')

    def handle(self, *args, **options):
        tenant_name = options['name']
        domain_name = options['domain']

        # 1) Check if a tenant with this name already exists
        existing_tenant = TenantConfig.objects.filter(tenant_name=tenant_name).first()
        if existing_tenant:
            self.stdout.write(
                self.style.WARNING(f'Tenant named "{tenant_name}" already exists. Checking associated domain...')
            )
            # 2) Ensure the corresponding domain is also set up
            domain_obj, created = TenantDomain.objects.get_or_create(
                domain=domain_name,
                tenant=existing_tenant,
                defaults={'is_primary': True}
            )
            if created:
                self.stdout.write(
                    self.style.SUCCESS(
                        f'Created domain "{domain_name}" for existing tenant "{tenant_name}".'
                    )
                )
            else:
                self.stdout.write(
                    self.style.WARNING(
                        f'Domain "{domain_name}" also already exists. No changes were made.'
                    )
                )
            return  # Done; no need to create a new tenant

        # 3) If tenant does not exist, create a new one
        tenant = TenantConfig(
            tenant_name=tenant_name,
            schema_name=f'tenant_{tenant_name}'
        )
        tenant.save()

        # 4) Create the domain for the newly created tenant
        domain = TenantDomain(
            domain=domain_name,
            tenant=tenant,
            is_primary=True
        )
        domain.save()

        self.stdout.write(
            self.style.SUCCESS(
                f'Successfully created tenant "{tenant_name}" with domain "{domain_name}".'
            )
        )
</file>

<file path='tenants/migrations/0001_initial.py'>
# tenants/migrations/0001_initial.py
# Generated by Django 4.2 on YYYY-MM-DD HH:MM

from django.db import migrations, models
import django.db.models.deletion

class Migration(migrations.Migration):
    initial = True

    dependencies = [
    ]

    operations = [
        migrations.CreateModel(
            name='TenantConfig',
            fields=[
                ('tenant_id', models.AutoField(primary_key=True, serialize=False)),
                ('tenant_name', models.CharField(max_length=100, unique=True)),
                ('created_on', models.DateTimeField(auto_now_add=True)),
                ('schema_name', models.CharField(max_length=63, unique=True)),
            ],
            options={
                'db_table': 'public.tenant_config',
            },
        ),
        migrations.CreateModel(
            name='TenantDomain',
            fields=[
                ('id', models.BigAutoField(auto_created=True,
                                           primary_key=True,
                                           serialize=False,
                                           verbose_name='ID')),
                ('domain', models.CharField(db_index=True,
                                            max_length=253,
                                            unique=True)),
                ('is_primary', models.BooleanField(db_index=True, default=True)),
                ('tenant', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE,
                                             related_name='domains',
                                             to='tenants.tenantconfig')),
            ],
            options={
                'db_table': 'tenant_domain',
            },
        ),
    ]
</file>

<file path='tenants/migrations/__init__.py'>

</file>

<file path='tenants/models.py'>
# tenants/models.py

from django.db import models
from django_tenants.models import TenantMixin, DomainMixin

class TenantConfig(TenantMixin):
    tenant_id = models.AutoField(primary_key=True)
    tenant_name = models.CharField(max_length=100, unique=True)
    created_on = models.DateTimeField(auto_now_add=True)
    schema_name = models.CharField(max_length=63, unique=True)

    auto_create_schema = True
    auto_drop_schema = False

    class Meta:
        db_table = 'public.tenant_config'

    def __str__(self):
        return f"{self.tenant_name} (ID: {self.tenant_id})"

class TenantDomain(DomainMixin):
    tenant = models.ForeignKey(
        TenantConfig,
        related_name='domains',
        on_delete=models.CASCADE
    )

    class Meta:
        db_table = 'tenant_domain'

    def __str__(self):
        return f"Domain: {self.domain} -> Tenant: {self.tenant}"
</file>

<file path='tenants/urls.py'>
# tenants/urls.py
from django.urls import path
from .views import TenantConfigListView, TenantConfigCreateView, TenantConfigUpdateView

app_name = 'tenants'

urlpatterns = [
    path('', TenantConfigListView.as_view(), name='list'),
    path('create/', TenantConfigCreateView.as_view(), name='create'),
    path('<int:pk>/edit/', TenantConfigUpdateView.as_view(), name='edit'),
]
</file>

<file path='tenants/views.py'>
# tenants/views.py
from django.views.generic import ListView, CreateView, UpdateView
from django.urls import reverse_lazy
from .models import TenantConfig

class TenantConfigListView(ListView):
    model = TenantConfig
    template_name = 'tenants/tenant_list.html'
    context_object_name = 'tenants'

class TenantConfigCreateView(CreateView):
    model = TenantConfig
    fields = ['tenant_name', 'schema_name']
    template_name = 'tenants/tenant_form.html'
    success_url = reverse_lazy('tenants:list')

class TenantConfigUpdateView(UpdateView):
    model = TenantConfig
    fields = ['tenant_name', 'schema_name']
    template_name = 'tenants/tenant_form.html'
    success_url = reverse_lazy('tenants:list')
</file>

</Concatenated Source Code>